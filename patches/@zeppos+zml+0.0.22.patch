diff --git a/node_modules/@zeppos/zml/dist/1.0/module/messaging/plugin/app.js b/node_modules/@zeppos/zml/dist/1.0/module/messaging/plugin/app.js
index 437fa63..223b55c 100644
--- a/node_modules/@zeppos/zml/dist/1.0/module/messaging/plugin/app.js
+++ b/node_modules/@zeppos/zml/dist/1.0/module/messaging/plugin/app.js
@@ -1,8 +1,8 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;s()?t=hmApp.getPackageInfo:r()&&(t=e("@zos/app").getPackageInfo),s()?hmUI:r()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:r()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:r()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:r()&&e("@zos/router").push;let n=null;function s(){return a()&&i()}function r(){return a()&&o()}function i(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function a(){return i()||o()}function u(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}s()?n=hmBle:r()&&(n=e("@zos/ble"));let h=null;s()?h=DeviceRuntimeCore.HmLogger:r()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);class c{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const p=setTimeout,d=clearTimeout;var l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function f(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var y={exports:{}};
+let e=null;function t(t){return"object"==typeof t&&!e.isBuffer(t)&&!Array.isArray(t)&&null!==t}void 0===globalThis.Buffer?globalThis.Buffer=e=DeviceRuntimeCore.Buffer:e=globalThis.Buffer;let n=null;n="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let s=null;i()?s=hmApp.getPackageInfo:o()&&(s=n("@zos/app").getPackageInfo),i()?hmUI:o()&&n("@zos/ui"),i()?hmSetting.getDeviceInfo:o()&&n("@zos/device").getDeviceInfo,i()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:o()&&n("@zos/i18n").getText,i()?hmApp.gotoPage:o()&&n("@zos/router").push;let r=null;function i(){return h()&&a()}function o(){return h()&&u()}function a(){return"undefined"!=typeof hmApp}function u(){return"undefined"!=typeof __$$R$$__}function h(){return a()||u()}i()?r=hmBle:o()&&(r=n("@zos/ble"));let c=null;i()?c=DeviceRuntimeCore.HmLogger:o()?c=n("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(c=Logger);class l{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}function p(e){e&&timer.stopTimer(e)}function d(e,t){const n=timer.createTimer(t||1,t||1,(function(){p(n),e&&e()}),{});return n}void 0===globalThis.setTimeout&&(globalThis.setTimeout=d,globalThis.clearTimeout=p);var f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function y(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var g={exports:{}};
 /*!
  * @overview es6-promise - a tiny implementation of Promises/A+.
  * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
  * @license   Licensed under MIT license
  *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
  * @version   v4.2.8+1e68dce6
- */y.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){d[n]=e,d[n+1]=t,2===(n+=2)&&(r?r(f):T())},o="undefined"!=typeof window?window:void 0,a=o||{},u=a.MutationObserver||a.WebKitMutationObserver,h="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function p(){var e=setTimeout;return function(){return e(f,1)}}var d=new Array(1e3);function f(){for(var e=0;e<n;e+=2)(0,d[e])(d[e+1]),d[e]=void 0,d[e+1]=void 0;n=0}var y,g,m,I,T=void 0;function v(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&j(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return x(r,s,o,n._result)}))}else P(n,s,e,t);return s}function b(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return q(t,e),t}T=h?function(){return process.nextTick(f)}:u?(g=0,m=new u(f),I=document.createTextNode(""),m.observe(I,{characterData:!0}),function(){I.data=g=++g%2}):c?((y=new MessageChannel).port1.onmessage=f,function(){return y.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(f)}:p()}catch(e){return p()}}():p();var w=Math.random().toString(36).substring(2);function _(){}var k=void 0,L=1,B=2;function S(t,n,s){n.constructor===t.constructor&&s===v&&n.constructor.resolve===b?function(e,t){t._state===L?U(e,t._result):t._state===B?C(e,t._result):P(t,void 0,(function(t){return q(e,t)}),(function(t){return C(e,t)}))}(t,n):void 0===s?U(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?q(e,n):U(e,n))}),(function(t){s||(s=!0,C(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,C(e,r))}),e)}(t,n,s):U(t,n)}function q(e,t){if(e===t)C(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)U(e,t);else{var n=void 0;try{n=t.then}catch(t){return void C(e,t)}S(e,t,n)}var s,r}function E(e){e._onerror&&e._onerror(e._result),A(e)}function U(e,t){e._state===k&&(e._result=t,e._state=L,0!==e._subscribers.length&&i(A,e))}function C(e,t){e._state===k&&(e._state=B,e._result=t,i(E,e))}function P(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+L]=n,r[o+B]=s,0===o&&e._state&&i(A,e)}function A(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function x(t,n,s,r){var i=e(s),o=void 0,a=void 0,u=!0;if(i){try{o=s(r)}catch(e){u=!1,a=e}if(n===o)return void C(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==k||(i&&u?q(n,o):!1===u?C(n,a):t===L?U(n,o):t===B&&C(n,o))}var D=0;function j(e){e[w]=D++,e._state=void 0,e._result=void 0,e._subscribers=[]}var $=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||j(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?U(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&U(this.promise,this._result))):C(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===k&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===b){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===v&&e._state!==k)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===M){var a=new n(_);o?C(a,i):S(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===k&&(this._remaining--,e===B?C(s,n):this._result[t]=n),0===this._remaining&&U(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;P(e,void 0,(function(e){return n._settledAt(L,t,e)}),(function(e){return n._settledAt(B,t,e)}))},e}(),M=function(){function t(e){this[w]=D++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){q(e,t)}),(function(t){C(e,t)}))}catch(t){C(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return M.prototype.then=v,M.all=function(e){return new $(this,e).promise},M.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},M.resolve=b,M.reject=function(e){var t=new this(_);return C(t,e),t},M._setScheduler=function(e){r=e},M._setAsap=function(e){i=e},M._asap=i,M.polyfill=function(){var e=void 0;if(void 0!==l)e=l;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=M},M.Promise=M,M}();const g=f(y.exports);function m(){const e={canceled:!1};return e.promise=new g((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function I(e,t){const n=m(),s=p((()=>{d(s),t?t&&t(n.resolve,n.reject):n.reject("Timed out in "+e+"ms.")}),e=e||1e3);return n.promise}function T(e){return b(function(e){return JSON.stringify(e)}(e))}function v(e){return t=w(e),JSON.parse(t);var t}function b(e){return Buffer.from(e,"utf-8")}function w(e){return e.toString("utf-8")}function _(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function k(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const L=a()?h.getLogger("device-message"):h.getLogger("side-message"),B=void 0,S="json",q="text",E="bin",U=0,C=1,P=2,A=3;function x(e){switch(e.toLowerCase()){case S:return P;case q:return C;case E:return A;case"empty":return U;default:return A}}let D=1e4;function j(){return D++}let $=1e3;function M(){return $++}class R extends c{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const n=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,n]):n}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class O{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new R(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class z extends Error{constructor(e,t){super(t),this.code=e}}class H extends c{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:r=(a()?n:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:a()?n:void 0}){super(),this.isDevice=a(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=r,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new O,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=m(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=p((()=>{this.shakeStatus=4,this.shakeTask.reject(new z(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&d(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return v(e)}json2Buf(e){return T(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=g.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt8(e.flag,s),s+=1,n.writeUInt8(e.version,s),s+=1,n.writeUInt16LE(e.type,s),s+=2,n.writeUInt16LE(e.port1,s),s+=2,n.writeUInt16LE(e.port2,s),s+=2,n.writeUInt32LE(e.appId,s),s+=4,n.writeUInt32LE(e.extra,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let n=0;const s=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const i=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const a=t.readUInt16LE(n);n+=2;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);return n+=4,{flag:s,version:r,type:i,port1:o,port2:a,appId:u,extra:h,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=B){if(t&&L.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,k(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=B){t&&L.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,k(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:s,dataType:r},{messageType:i=4}={}){const o=3518,a=t.byteLength;let u=0;const h=Buffer.alloc(o),c=e||j(),p=M();let d=1;const l=Math.ceil(a/o);function f(){return d++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=a-u,o=Buffer.alloc(0+e);t.copy(o,0,u,u+e),u+=e,this.sendDataWithSession({traceId:c,spanId:p,seqId:f(),payload:o,type:n,opCode:1,totalLength:a,contentType:s,dataType:r},{messageType:i});break}t.copy(h,0,u,u+o),u+=o,this.sendDataWithSession({traceId:c,spanId:p,seqId:f(),payload:h,type:n,opCode:0,totalLength:a,contentType:s,dataType:r},{messageType:i})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=T(t),o=e||j();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||j();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=b(t),o=e||j();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:u},{messageType:h}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:u});let p=this.isDevice?this.buildData(c,{type:h}):c;this.sendMsg(p)}buildPayload(e){const t=66+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt32LE(e.traceId,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(e.spanId,s),s+=4,n.writeUInt32LE(e.seqId,s),s+=4,n.writeUInt32LE(e.totalLength,s),s+=4,n.writeUInt32LE(e.payload.byteLength,s),s+=4,n.writeUInt8(e.type,s),s+=1,n.writeUInt8(e.opCode,s),s+=1,n.writeUInt32LE(this.now(),s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt8(e.contentType,s),s+=1,n.writeUInt8(e.dataType,s),s+=1,n.writeUInt16LE(0,s),s+=2,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}readPayload(e){const t=Buffer.from(e);let n=0;const s=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const i=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt8(n);n+=1;const c=t.readUInt8(n);n+=1;const p=t.readUInt32LE(n);n+=4;const d=t.readUInt32LE(n);n+=4;const l=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const I=t.readUInt8(n);n+=1;const T=t.readUInt8(n);n+=1;const v=t.readUInt16LE(n);n+=2;const b=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:s,parentId:r,spanId:i,seqId:o,totalLength:a,payloadLength:u,payloadType:h,opCode:c,contentType:I,dataType:T,timestamp1:p,timestamp2:d,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:v,extra2:b,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(a()&&!this.ble.connectStatus())throw new z(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(a&&!this.appSidePort)throw new z(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?x(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return g.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=E;"string"==typeof e?n=q:u(e)?n=S:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=E);const s={timeout:6e4,contentType:n,dataType:n},r=j(),i=m();t=Object.assign(s,t),this.handlers.set(r,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case C:s=w(t);break;case A:s=t;break;case P:s=v(t);break;default:s=t}i.resolve(s)})),Buffer.isBuffer(e)?this.sendBuf({requestId:r,buf:e,type:1,contentType:A,dataType:x(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:A,dataType:x(t.dataType)}):x(t.contentType)===P?this.sendJson({requestId:r,json:e,type:1,contentType:P,dataType:x(t.dataType)}):x(t.contentType)===C?this.sendText({requestId:r,text:e,type:1,contentType:C,dataType:x(t.dataType)}):this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:A,dataType:x(t.dataType)});let o=!1;return g.race([I(t.timeout,((e,n)=>{if(o)return e();n(new z(4,`request timed out in ${t.timeout}ms.`))})),i.promise.finally((()=>{o=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(r)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){A===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):C===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):P===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:A})}call(e){let t=P;return"string"==typeof e?t=C:u(e)?t=P:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=A),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:A,dataType:U}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:A,dataType:U}):t===P?this.sendJson({json:e,type:3,contentType:P,dataType:U}):t===C?this.sendText({text:e,type:3,contentType:C,dataType:U}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:A,dataType:U})))}}h.getLogger("message-builder");const J="hmrpcv1";function W(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}function F(e){const n={shakeTimeout:5e3,requestTimeout:6e4,transport:s=new H({appId:t().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(s.on("call",(({contentType:t,payload:n})=>{switch(t){case P:n=v(n);break;case C:n=w(n);break;default:n=_(n)}e&&e(n)})),this):this},offOnCall(e){return s.off("call",e),this},call(e){return a()&&s.fork(this.shakeTimeout),e=u(e)?e.contentType?e:{jsonrpc:J,...e}:e,s.call(e)},onRequest(e){return e?(s.on("request",(t=>{let n=t.request.payload;switch(t.request.contentType){case P:n=v(n);break;case C:n=w(n);break;default:n=_(n)}e&&e(n,((e,s,r={})=>t.request.contentType===P&&n?.jsonrpc===J?e?t.response({data:{jsonrpc:J,error:e}}):t.response({data:{jsonrpc:J,result:s}}):t.response({data:s,...r})))})),this):this},cancelAllRequest(){return s.off("response"),this},offOnRequest(e){return s.off("request",e),this},request(e,t={}){return a()&&s.fork(this.shakeTimeout),e=u(e)?t.contentType?e:{jsonrpc:J,...e}:e,s.request(e,{timeout:this.requestTimeout,...t}).then((e=>{if(!u(e)||e.jsonrpc!==J)return e;const{error:t,result:n}=e;if(t)throw t;return n}))},connect(){return s.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this},start(){return s.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this}};var s;return{onCreate(){this.messaging=this.globalData.messaging=n,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:W}}const V="1.0";export{V as API_LEVEL,F as appPlugin};
+ */g.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){p[n]=e,p[n+1]=t,2===(n+=2)&&(r?r(d):I())},o="undefined"!=typeof window?window:void 0,a=o||{},u=a.MutationObserver||a.WebKitMutationObserver,h="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function l(){var e=setTimeout;return function(){return e(d,1)}}var p=new Array(1e3);function d(){for(var e=0;e<n;e+=2)(0,p[e])(p[e+1]),p[e]=void 0,p[e+1]=void 0;n=0}var y,g,m,T,I=void 0;function b(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&M(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return x(r,s,o,n._result)}))}else P(n,s,e,t);return s}function v(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return B(t,e),t}I=h?function(){return process.nextTick(d)}:u?(g=0,m=new u(d),T=document.createTextNode(""),m.observe(T,{characterData:!0}),function(){T.data=g=++g%2}):c?((y=new MessageChannel).port1.onmessage=d,function(){return y.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(d)}:l()}catch(e){return l()}}():l();var w=Math.random().toString(36).substring(2);function _(){}var L=void 0,S=1,k=2;function E(t,n,s){n.constructor===t.constructor&&s===b&&n.constructor.resolve===v?function(e,t){t._state===S?U(e,t._result):t._state===k?q(e,t._result):P(t,void 0,(function(t){return B(e,t)}),(function(t){return q(e,t)}))}(t,n):void 0===s?U(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?B(e,n):U(e,n))}),(function(t){s||(s=!0,q(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,q(e,r))}),e)}(t,n,s):U(t,n)}function B(e,t){if(e===t)q(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)U(e,t);else{var n=void 0;try{n=t.then}catch(t){return void q(e,t)}E(e,t,n)}var s,r}function C(e){e._onerror&&e._onerror(e._result),A(e)}function U(e,t){e._state===L&&(e._result=t,e._state=S,0!==e._subscribers.length&&i(A,e))}function q(e,t){e._state===L&&(e._state=k,e._result=t,i(C,e))}function P(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+S]=n,r[o+k]=s,0===o&&e._state&&i(A,e)}function A(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function x(t,n,s,r){var i=e(s),o=void 0,a=void 0,u=!0;if(i){try{o=s(r)}catch(e){u=!1,a=e}if(n===o)return void q(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==L||(i&&u?B(n,o):!1===u?q(n,a):t===S?U(n,o):t===k&&q(n,o))}var D=0;function M(e){e[w]=D++,e._state=void 0,e._result=void 0,e._subscribers=[]}var j=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||M(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?U(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&U(this.promise,this._result))):q(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===L&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===v){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===b&&e._state!==L)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===O){var a=new n(_);o?q(a,i):E(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===L&&(this._remaining--,e===k?q(s,n):this._result[t]=n),0===this._remaining&&U(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;P(e,void 0,(function(e){return n._settledAt(S,t,e)}),(function(e){return n._settledAt(k,t,e)}))},e}(),O=function(){function t(e){this[w]=D++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){B(e,t)}),(function(t){q(e,t)}))}catch(t){q(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return O.prototype.then=b,O.all=function(e){return new j(this,e).promise},O.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},O.resolve=v,O.reject=function(e){var t=new this(_);return q(t,e),t},O._setScheduler=function(e){r=e},O._setAsap=function(e){i=e},O._asap=i,O.polyfill=function(){var e=void 0;if(void 0!==f)e=f;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=O},O.Promise=O,O}();var m=y(g.exports);globalThis.Promise=m;const T=m;function I(){const e={canceled:!1};return e.promise=new T((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function b(e){return w(function(e){return JSON.stringify(e)}(e))}function v(e){return t=_(e),JSON.parse(t);var t}function w(t){return e.from(t,"utf-8")}function _(e){return e.toString("utf-8")}function L(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function S(t){return n=function(t){return e.from(t)}(t),n.toString("hex");var n}const k=h()?c.getLogger("device-message"):c.getLogger("side-message"),E=void 0,B="json",C="text",U="bin",q=0,P=1,A=2,x=3;function D(e){switch(e.toLowerCase()){case B:return A;case C:return P;case U:return x;case"empty":return q;default:return x}}let M=1e4;function j(){return M++}let O=1e3;function $(){return O++}class R extends l{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.count=0,this.finishChunk=null,k.log("Session Created.")}addChunk(t){if(1===t.opCode&&(this.count=t.seqId,this.finishChunk=t),t.payloadLength!==t.payload.byteLength)return void this.emit("error",Error(`receive chunk data length error, expect ${t.payloadLength} but ${t.payload.byteLength}`));this.tempBuf||(this.tempBuf=e.alloc(t.totalLength));const n=3518*(t.seqId-1);t.payload.copy(this.tempBuf,n),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class z{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new R(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const H={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class J extends Error{constructor(e,t){super(t),this.code=e}}class W extends l{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:s=(h()?r:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:h()?r:void 0}){super(),this.isDevice=h(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=s,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new z,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=I(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=d((()=>{this.shakeStatus=4,this.shakeTask.reject(new J(H.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&p(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return v(e)}json2Buf(e){return b(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=T.resolve(),e&&e(this)}buildBin(t){if(t.payload.byteLength>this.chunkSize)throw new Error(`${t.payload.byteLength} greater than max size of ${this.chunkSize}`);const n=this.getMessageHeaderSize()+t.payload.byteLength;let s=e.alloc(n),r=0;return s.writeUInt8(t.flag,r),r+=1,s.writeUInt8(t.version,r),r+=1,s.writeUInt16LE(t.type,r),r+=2,s.writeUInt16LE(t.port1,r),r+=2,s.writeUInt16LE(t.port2,r),r+=2,s.writeUInt32LE(t.appId,r),r+=4,s.writeUInt32LE(t.extra,r),r+=4,s.fill(t.payload,r,t.payload.byteLength+r),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(t){const n=e.from(t);let s=0;const r=n.readUInt8(s);s+=1;const i=n.readUInt8(s);s+=1;const o=n.readUInt16LE(s);s+=2;const a=n.readUInt16LE(s);s+=2;const u=n.readUInt16LE(s);s+=2;const h=n.readUInt32LE(s);s+=4;const c=n.readUInt32LE(s);return s+=4,{flag:r,version:i,type:o,port1:a,port2:u,appId:h,extra:c,payload:n.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=E){if(t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,S(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=E){t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,S(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:t,dataBin:n,type:s,contentType:r,dataType:i},{messageType:o=4}={}){const a=3518,u=n.byteLength;let h=0;const c=e.alloc(a),l=t||j(),p=$();let d=1;const f=Math.ceil(u/a);function y(){return d++}for(let t=1;t<=f;t++){if(this.errorIfBleDisconnect(),t===f){const t=u-h,a=e.alloc(0+t);n.copy(a,0,h,h+t),h+=t,this.sendDataWithSession({traceId:l,spanId:p,seqId:y(),payload:a,type:s,opCode:1,totalLength:u,contentType:r,dataType:i},{messageType:o});break}n.copy(c,0,h,h+a),h+=a,this.sendDataWithSession({traceId:l,spanId:p,seqId:y(),payload:c,type:s,opCode:0,totalLength:u,contentType:r,dataType:i},{messageType:o})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=b(t),o=e||j();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||j();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=w(t),o=e||j();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:u},{messageType:h}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:u});let l=this.isDevice?this.buildData(c,{type:h}):c;this.sendMsg(l)}buildPayload(t){const n=66+t.payload.byteLength;let s=e.alloc(n),r=0;return s.writeUInt32LE(t.traceId,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(t.spanId,r),r+=4,s.writeUInt32LE(t.seqId,r),r+=4,s.writeUInt32LE(t.totalLength,r),r+=4,s.writeUInt32LE(t.payload.byteLength,r),r+=4,s.writeUInt8(t.type,r),r+=1,s.writeUInt8(t.opCode,r),r+=1,s.writeUInt32LE(this.now(),r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt8(t.contentType,r),r+=1,s.writeUInt8(t.dataType,r),r+=1,s.writeUInt16LE(0,r),r+=2,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.fill(t.payload,r,t.payload.byteLength+r),s}readPayload(t){const n=e.from(t);let s=0;const r=n.readUInt32LE(s);s+=4;const i=n.readUInt32LE(s);s+=4;const o=n.readUInt32LE(s);s+=4;const a=n.readUInt32LE(s);s+=4;const u=n.readUInt32LE(s);s+=4;const h=n.readUInt32LE(s);s+=4;const c=n.readUInt8(s);s+=1;const l=n.readUInt8(s);s+=1;const p=n.readUInt32LE(s);s+=4;const d=n.readUInt32LE(s);s+=4;const f=n.readUInt32LE(s);s+=4;const y=n.readUInt32LE(s);s+=4;const g=n.readUInt32LE(s);s+=4;const m=n.readUInt32LE(s);s+=4;const T=n.readUInt32LE(s);s+=4;const I=n.readUInt8(s);s+=1;const b=n.readUInt8(s);s+=1;const v=n.readUInt16LE(s);s+=2;const w=n.readUInt32LE(s);s+=4;const _=n.readUInt32LE(s);return s+=4,{traceId:r,parentId:i,spanId:o,seqId:a,totalLength:u,payloadLength:h,payloadType:c,opCode:l,contentType:I,dataType:b,timestamp1:p,timestamp2:d,timestamp3:f,timestamp4:y,timestamp5:g,timestamp6:m,timestamp7:T,extra1:v,extra2:w,extra3:_,payload:n.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(h()&&!this.ble.connectStatus())throw new J(H.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(h()&&!this.appSidePort)throw new J(H.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?D(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(n,s){try{this.errorIfBleDisconnect()}catch(e){return T.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let r=U;"string"==typeof n?r=C:t(n)?r=B:(n instanceof ArrayBuffer||ArrayBuffer.isView(n)||e.isBuffer(n))&&(r=U);const i={timeout:6e4,contentType:r,dataType:r},o=j(),a=I();let u=d((()=>{u=null,a.reject(new J(H.TIMEOUT,"request timeout"))}),(s=Object.assign(i,s)).timeout);return this.handlers.set(o,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case P:s=_(t);break;case x:s=t;break;case A:s=v(t);break;default:s=t}a.resolve(s)})),e.isBuffer(n)?this.sendBuf({requestId:o,buf:n,type:1,contentType:x,dataType:D(s.dataType)}):n instanceof ArrayBuffer||ArrayBuffer.isView(n)?this.sendBuf({requestId:o,buf:e.from(n),type:1,contentType:x,dataType:D(s.dataType)}):D(s.contentType)===A?this.sendJson({requestId:o,json:n,type:1,contentType:A,dataType:D(s.dataType)}):D(s.contentType)===P?this.sendText({requestId:o,text:n,type:1,contentType:P,dataType:D(s.dataType)}):this.sendBuf({requestId:o,buf:e.from(n),type:1,contentType:x,dataType:D(s.dataType)}),a.promise.catch((e=>{throw e})).finally((()=>{u&&(p(u),u=null),this.handlers.delete(o)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){x===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):P===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):A===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:x})}call(n){let s=A;return"string"==typeof n?s=P:t(n)?s=A:(n instanceof ArrayBuffer||ArrayBuffer.isView(n)||e.isBuffer(n))&&(s=x),this.waitingShakePromise.then((()=>e.isBuffer(n)?this.sendBuf({buf:n,type:3,contentType:x,dataType:q}):n instanceof ArrayBuffer||ArrayBuffer.isView(n)?this.sendBuf({buf:e.from(n),type:3,contentType:x,dataType:q}):s===A?this.sendJson({json:n,type:3,contentType:A,dataType:q}):s===P?this.sendText({text:n,type:3,contentType:P,dataType:q}):this.sendBuf({buf:e.from(n),type:3,contentType:x,dataType:q})))}}c.getLogger("message-builder");const F="hmrpcv1";function V(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}function K(e){const n={shakeTimeout:5e3,requestTimeout:6e4,transport:r=new W({appId:s().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(r.on("call",(({contentType:t,payload:n})=>{switch(t){case A:n=v(n);break;case P:n=_(n);break;default:n=L(n)}e&&e(n)})),this):this},offOnCall(e){return r.off("call",e),this},call(e){return h()&&r.fork(this.shakeTimeout),e=t(e)?e.contentType?e:{jsonrpc:F,...e}:e,r.call(e)},onRequest(e){return e?(r.on("request",(t=>{let n=t.request.payload;switch(t.request.contentType){case A:n=v(n);break;case P:n=_(n);break;default:n=L(n)}e&&e(n,((e,s,r={})=>t.request.contentType===A&&n?.jsonrpc===F?e?t.response({data:{jsonrpc:F,error:e}}):t.response({data:{jsonrpc:F,result:s}}):t.response({data:s,...r})))})),this):this},cancelAllRequest(){return r.off("response"),this},offOnRequest(e){return r.off("request",e),this},request(e,n={}){return h()&&r.fork(this.shakeTimeout),e=t(e)?n.contentType?e:{jsonrpc:F,...e}:e,r.request(e,{timeout:this.requestTimeout,...n}).then((e=>{if(!t(e)||e.jsonrpc!==F)return e;const{error:n,result:s}=e;if(n)throw n;return s}))},connect(){return r.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),r.disConnect((()=>{})),this},start(){return r.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),r.disConnect((()=>{})),this}};var r;return{onCreate(){this.messaging=this.globalData.messaging=n,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:V}}const N="1.0";export{N as API_LEVEL,K as appPlugin};
diff --git a/node_modules/@zeppos/zml/dist/1.0/module/messaging/plugin/side.js b/node_modules/@zeppos/zml/dist/1.0/module/messaging/plugin/side.js
index e769247..0280869 100644
--- a/node_modules/@zeppos/zml/dist/1.0/module/messaging/plugin/side.js
+++ b/node_modules/@zeppos/zml/dist/1.0/module/messaging/plugin/side.js
@@ -1,8 +1 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},n()?hmApp.getPackageInfo:s()&&e("@zos/app").getPackageInfo,n()?hmUI:s()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:s()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:s()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:s()&&e("@zos/router").push;let t=null;function n(){return o()&&r()}function s(){return o()&&i()}function r(){return"undefined"!=typeof hmApp}function i(){return"undefined"!=typeof __$$R$$__}function o(){return r()||i()}function a(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}n()?t=hmBle:s()&&(t=e("@zos/ble"));let u=null;n()?u=DeviceRuntimeCore.HmLogger:s()?u=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(u=Logger);class h{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const c=setTimeout,d=clearTimeout;var p="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function l(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var f={exports:{}};
-/*!
- * @overview es6-promise - a tiny implementation of Promises/A+.
- * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
- * @license   Licensed under MIT license
- *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
- * @version   v4.2.8+1e68dce6
- */f.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){l[n]=e,l[n+1]=t,2===(n+=2)&&(r?r(f):T())},o="undefined"!=typeof window?window:void 0,a=o||{},u=a.MutationObserver||a.WebKitMutationObserver,h="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function d(){var e=setTimeout;return function(){return e(f,1)}}var l=new Array(1e3);function f(){for(var e=0;e<n;e+=2)(0,l[e])(l[e+1]),l[e]=void 0,l[e+1]=void 0;n=0}var y,g,m,I,T=void 0;function b(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&R(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return x(r,s,o,n._result)}))}else A(n,s,e,t);return s}function v(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return q(t,e),t}T=h?function(){return process.nextTick(f)}:u?(g=0,m=new u(f),I=document.createTextNode(""),m.observe(I,{characterData:!0}),function(){I.data=g=++g%2}):c?((y=new MessageChannel).port1.onmessage=f,function(){return y.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(f)}:d()}catch(e){return d()}}():d();var w=Math.random().toString(36).substring(2);function _(){}var k=void 0,L=1,B=2;function S(t,n,s){n.constructor===t.constructor&&s===b&&n.constructor.resolve===v?function(e,t){t._state===L?E(e,t._result):t._state===B?C(e,t._result):A(t,void 0,(function(t){return q(e,t)}),(function(t){return C(e,t)}))}(t,n):void 0===s?E(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?q(e,n):E(e,n))}),(function(t){s||(s=!0,C(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,C(e,r))}),e)}(t,n,s):E(t,n)}function q(e,t){if(e===t)C(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)E(e,t);else{var n=void 0;try{n=t.then}catch(t){return void C(e,t)}S(e,t,n)}var s,r}function U(e){e._onerror&&e._onerror(e._result),P(e)}function E(e,t){e._state===k&&(e._result=t,e._state=L,0!==e._subscribers.length&&i(P,e))}function C(e,t){e._state===k&&(e._state=B,e._result=t,i(U,e))}function A(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+L]=n,r[o+B]=s,0===o&&e._state&&i(P,e)}function P(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function x(t,n,s,r){var i=e(s),o=void 0,a=void 0,u=!0;if(i){try{o=s(r)}catch(e){u=!1,a=e}if(n===o)return void C(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==k||(i&&u?q(n,o):!1===u?C(n,a):t===L?E(n,o):t===B&&C(n,o))}var D=0;function R(e){e[w]=D++,e._state=void 0,e._result=void 0,e._subscribers=[]}var j=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||R(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?E(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&E(this.promise,this._result))):C(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===k&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===v){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===b&&e._state!==k)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===$){var a=new n(_);o?C(a,i):S(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===k&&(this._remaining--,e===B?C(s,n):this._result[t]=n),0===this._remaining&&E(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;A(e,void 0,(function(e){return n._settledAt(L,t,e)}),(function(e){return n._settledAt(B,t,e)}))},e}(),$=function(){function t(e){this[w]=D++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){q(e,t)}),(function(t){C(e,t)}))}catch(t){C(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return $.prototype.then=b,$.all=function(e){return new j(this,e).promise},$.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},$.resolve=v,$.reject=function(e){var t=new this(_);return C(t,e),t},$._setScheduler=function(e){r=e},$._setAsap=function(e){i=e},$._asap=i,$.polyfill=function(){var e=void 0;if(void 0!==p)e=p;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=$},$.Promise=$,$}();const y=l(f.exports);function g(){const e={canceled:!1};return e.promise=new y((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function m(e,t){const n=g(),s=c((()=>{d(s),t?t&&t(n.resolve,n.reject):n.reject("Timed out in "+e+"ms.")}),e=e||1e3);return n.promise}function I(e){return b(function(e){return JSON.stringify(e)}(e))}function T(e){return t=v(e),JSON.parse(t);var t}function b(e){return Buffer.from(e,"utf-8")}function v(e){return e.toString("utf-8")}function w(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function _(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const k=o()?u.getLogger("device-message"):u.getLogger("side-message"),L=void 0,B="json",S="text",q="bin";function U(e){switch(e.toLowerCase()){case B:return 2;case S:return 1;case q:return 3;case"empty":return 0;default:return 3}}let E=1e4;function C(){return E++}let A=1e3;function P(){return A++}class x extends h{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const n=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,n]):n}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class D{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new x(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class R extends Error{constructor(e,t){super(t),this.code=e}}u.getLogger("message-builder");const j="hmrpcv1",$=new class extends h{constructor({appId:e=0,appDevicePort:n=20,appSidePort:s=0,ble:r=(o()?t:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?t:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=n,this.appSidePort=s,this.ble=r,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new D,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=g(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=c((()=>{this.shakeStatus=4,this.shakeTask.reject(new R(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&d(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return T(e)}json2Buf(e){return I(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=y.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt8(e.flag,s),s+=1,n.writeUInt8(e.version,s),s+=1,n.writeUInt16LE(e.type,s),s+=2,n.writeUInt16LE(e.port1,s),s+=2,n.writeUInt16LE(e.port2,s),s+=2,n.writeUInt32LE(e.appId,s),s+=4,n.writeUInt32LE(e.extra,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let n=0;const s=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const i=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const a=t.readUInt16LE(n);n+=2;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);return n+=4,{flag:s,version:r,type:i,port1:o,port2:a,appId:u,extra:h,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=L){if(t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,_(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=L){t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,_(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:s,dataType:r},{messageType:i=4}={}){const o=3518,a=t.byteLength;let u=0;const h=Buffer.alloc(o),c=e||C(),d=P();let p=1;const l=Math.ceil(a/o);function f(){return p++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=a-u,o=Buffer.alloc(0+e);t.copy(o,0,u,u+e),u+=e,this.sendDataWithSession({traceId:c,spanId:d,seqId:f(),payload:o,type:n,opCode:1,totalLength:a,contentType:s,dataType:r},{messageType:i});break}t.copy(h,0,u,u+o),u+=o,this.sendDataWithSession({traceId:c,spanId:d,seqId:f(),payload:h,type:n,opCode:0,totalLength:a,contentType:s,dataType:r},{messageType:i})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=I(t),o=e||C();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||C();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=b(t),o=e||C();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:u},{messageType:h}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:u});let d=this.isDevice?this.buildData(c,{type:h}):c;this.sendMsg(d)}buildPayload(e){const t=66+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt32LE(e.traceId,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(e.spanId,s),s+=4,n.writeUInt32LE(e.seqId,s),s+=4,n.writeUInt32LE(e.totalLength,s),s+=4,n.writeUInt32LE(e.payload.byteLength,s),s+=4,n.writeUInt8(e.type,s),s+=1,n.writeUInt8(e.opCode,s),s+=1,n.writeUInt32LE(this.now(),s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt8(e.contentType,s),s+=1,n.writeUInt8(e.dataType,s),s+=1,n.writeUInt16LE(0,s),s+=2,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}readPayload(e){const t=Buffer.from(e);let n=0;const s=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const i=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt8(n);n+=1;const c=t.readUInt8(n);n+=1;const d=t.readUInt32LE(n);n+=4;const p=t.readUInt32LE(n);n+=4;const l=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const I=t.readUInt8(n);n+=1;const T=t.readUInt8(n);n+=1;const b=t.readUInt16LE(n);n+=2;const v=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:s,parentId:r,spanId:i,seqId:o,totalLength:a,payloadLength:u,payloadType:h,opCode:c,contentType:I,dataType:T,timestamp1:d,timestamp2:p,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:b,extra2:v,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new R(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new R(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?U(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return y.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=q;"string"==typeof e?n=S:a(e)?n=B:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=q);const s={timeout:6e4,contentType:n,dataType:n},r=C(),i=g();t=Object.assign(s,t),this.handlers.set(r,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case 1:s=v(t);break;case 3:default:s=t;break;case 2:s=T(t)}i.resolve(s)})),Buffer.isBuffer(e)?this.sendBuf({requestId:r,buf:e,type:1,contentType:3,dataType:U(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:3,dataType:U(t.dataType)}):2===U(t.contentType)?this.sendJson({requestId:r,json:e,type:1,contentType:2,dataType:U(t.dataType)}):1===U(t.contentType)?this.sendText({requestId:r,text:e,type:1,contentType:1,dataType:U(t.dataType)}):this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:3,dataType:U(t.dataType)});let o=!1;return y.race([m(t.timeout,((e,n)=>{if(o)return e();n(new R(4,`request timed out in ${t.timeout}ms.`))})),i.promise.finally((()=>{o=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(r)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){3===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):1===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):2===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:a(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}},M=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:n})=>{switch(e){case 2:n=T(n);break;case 1:n=v(n);break;default:n=w(n)}t&&t(n)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=a(t)?t.contentType?t:{jsonrpc:j,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let n=e.request.payload;switch(e.request.contentType){case 2:n=T(n);break;case 1:n=v(n);break;default:n=w(n)}t&&t(n,((t,s,r={})=>2===e.request.contentType&&n?.jsonrpc===j?t?e.response({data:{jsonrpc:j,error:t}}):e.response({data:{jsonrpc:j,result:s}}):e.response({data:s,...r})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,n={}){return o()&&e.fork(this.shakeTimeout),t=a(t)?n.contentType?t:{jsonrpc:j,...t}:t,e.request(t,{timeout:this.requestTimeout,...n}).then((e=>{if(!a(e)||e.jsonrpc!==j)return e;const{error:t,result:n}=e;if(t)throw t;return n}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}($);function O(){return{onInit(){this.messaging=M,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}const z="3.0";export{z as API_LEVEL,O as messagingPlugin};
+const e=Buffer;function t(t){return"object"==typeof t&&!e.isBuffer(t)&&!Array.isArray(t)&&null!==t}let s=null;s="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},i()?hmApp.getPackageInfo:r()&&s("@zos/app").getPackageInfo,i()?hmUI:r()&&s("@zos/ui"),i()?hmSetting.getDeviceInfo:r()&&s("@zos/device").getDeviceInfo,i()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:r()&&s("@zos/i18n").getText,i()?hmApp.gotoPage:r()&&s("@zos/router").push;let n=null;function i(){return h()&&a()}function r(){return h()&&o()}function a(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function h(){return a()||o()}i()?n=hmBle:r()&&(n=s("@zos/ble"));let d=null;i()?d=DeviceRuntimeCore.HmLogger:r()?d=s("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(d=Logger);class p{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const c=setTimeout,u=clearTimeout,l=Promise;function y(){const e={canceled:!1};return e.promise=new l((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function f(e){return I(function(e){return JSON.stringify(e)}(e))}function g(e){return t=T(e),JSON.parse(t);var t}function I(t){return e.from(t,"utf-8")}function T(e){return e.toString("utf-8")}function m(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function L(t){return s=function(t){return e.from(t)}(t),s.toString("hex");var s}const b=h()?d.getLogger("device-message"):d.getLogger("side-message"),k=void 0,S="json",w="text",U="bin";function E(e){switch(e.toLowerCase()){case S:return 2;case w:return 1;case U:return 3;case"empty":return 0;default:return 3}}let q=1e4;function B(){return q++}let C=1e3;function _(){return C++}class v extends p{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,b.log("Session Created.")}addChunk(t){if(1===t.opCode&&(this.count=t.seqId,this.finishChunk=t),t.payloadLength!==t.payload.byteLength)return void this.emit("error",Error(`receive chunk data length error, expect ${t.payloadLength} but ${t.payload.byteLength}`));this.tempBuf||(this.tempBuf=e.alloc(t.totalLength));const s=3518*(t.seqId-1);t.payload.copy(this.tempBuf,s),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class P{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new v(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const R={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class x extends Error{constructor(e,t){super(t),this.code=e}}d.getLogger("message-builder");const D="hmrpcv1",$=new class extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:i=(h()?n:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:h()?n:void 0}){super(),this.isDevice=h(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new P,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=y(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=c((()=>{this.shakeStatus=4,this.shakeTask.reject(new x(R.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=l.resolve(),e&&e(this)}buildBin(t){if(t.payload.byteLength>this.chunkSize)throw new Error(`${t.payload.byteLength} greater than max size of ${this.chunkSize}`);const s=this.getMessageHeaderSize()+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt8(t.flag,i),i+=1,n.writeUInt8(t.version,i),i+=1,n.writeUInt16LE(t.type,i),i+=2,n.writeUInt16LE(t.port1,i),i+=2,n.writeUInt16LE(t.port2,i),i+=2,n.writeUInt32LE(t.appId,i),i+=4,n.writeUInt32LE(t.extra,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(t){const s=e.from(t);let n=0;const i=s.readUInt8(n);n+=1;const r=s.readUInt8(n);n+=1;const a=s.readUInt16LE(n);n+=2;const o=s.readUInt16LE(n);n+=2;const h=s.readUInt16LE(n);n+=2;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt32LE(n);return n+=4,{flag:i,version:r,type:a,port1:o,port2:h,appId:d,extra:p,payload:s.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=k){if(t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=k){t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:t,dataBin:s,type:n,contentType:i,dataType:r},{messageType:a=4}={}){const o=3518,h=s.byteLength;let d=0;const p=e.alloc(o),c=t||B(),u=_();let l=1;const y=Math.ceil(h/o);function f(){return l++}for(let t=1;t<=y;t++){if(this.errorIfBleDisconnect(),t===y){const t=h-d,o=e.alloc(0+t);s.copy(o,0,d,d+t),d+=t,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:o,type:n,opCode:1,totalLength:h,contentType:i,dataType:r},{messageType:a});break}s.copy(p,0,d,d+o),d+=o,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:p,type:n,opCode:0,totalLength:h,contentType:i,dataType:r},{messageType:a})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),a=e||B();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||B();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=I(t),a=e||B();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let c=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(c)}buildPayload(t){const s=66+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt32LE(t.traceId,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(t.spanId,i),i+=4,n.writeUInt32LE(t.seqId,i),i+=4,n.writeUInt32LE(t.totalLength,i),i+=4,n.writeUInt32LE(t.payload.byteLength,i),i+=4,n.writeUInt8(t.type,i),i+=1,n.writeUInt8(t.opCode,i),i+=1,n.writeUInt32LE(this.now(),i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt8(t.contentType,i),i+=1,n.writeUInt8(t.dataType,i),i+=1,n.writeUInt16LE(0,i),i+=2,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}readPayload(t){const s=e.from(t);let n=0;const i=s.readUInt32LE(n);n+=4;const r=s.readUInt32LE(n);n+=4;const a=s.readUInt32LE(n);n+=4;const o=s.readUInt32LE(n);n+=4;const h=s.readUInt32LE(n);n+=4;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt8(n);n+=1;const c=s.readUInt8(n);n+=1;const u=s.readUInt32LE(n);n+=4;const l=s.readUInt32LE(n);n+=4;const y=s.readUInt32LE(n);n+=4;const f=s.readUInt32LE(n);n+=4;const g=s.readUInt32LE(n);n+=4;const I=s.readUInt32LE(n);n+=4;const T=s.readUInt32LE(n);n+=4;const m=s.readUInt8(n);n+=1;const L=s.readUInt8(n);n+=1;const b=s.readUInt16LE(n);n+=2;const k=s.readUInt32LE(n);n+=4;const S=s.readUInt32LE(n);return n+=4,{traceId:i,parentId:r,spanId:a,seqId:o,totalLength:h,payloadLength:d,payloadType:p,opCode:c,contentType:m,dataType:L,timestamp1:u,timestamp2:l,timestamp3:y,timestamp4:f,timestamp5:g,timestamp6:I,timestamp7:T,extra1:b,extra2:k,extra3:S,payload:s.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(h()&&!this.ble.connectStatus())throw new x(R.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(h()&&!this.appSidePort)throw new x(R.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?E(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(s,n){try{this.errorIfBleDisconnect()}catch(e){return l.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let i=U;"string"==typeof s?i=w:t(s)?i=S:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(i=U);const r={timeout:6e4,contentType:i,dataType:i},a=B(),o=y();n=Object.assign(r,n);let h=c((()=>{h=null,o.reject(new x(R.TIMEOUT,"request timeout"))}),n.timeout);return this.handlers.set(a,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=T(t);break;case 3:default:n=t;break;case 2:n=g(t)}o.resolve(n)})),e.isBuffer(s)?this.sendBuf({requestId:a,buf:s,type:1,contentType:3,dataType:E(n.dataType)}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:3,dataType:E(n.dataType)}):2===E(n.contentType)?this.sendJson({requestId:a,json:s,type:1,contentType:2,dataType:E(n.dataType)}):1===E(n.contentType)?this.sendText({requestId:a,text:s,type:1,contentType:1,dataType:E(n.dataType)}):this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:3,dataType:E(n.dataType)}),o.promise.catch((e=>{throw e})).finally((()=>{h&&(u(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(s){let n=2;return"string"==typeof s?n=1:t(s)?n=2:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(n=3),this.waitingShakePromise.then((()=>e.isBuffer(s)?this.sendBuf({buf:s,type:3,contentType:3,dataType:0}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({buf:e.from(s),type:3,contentType:3,dataType:0}):2===n?this.sendJson({json:s,type:3,contentType:2,dataType:0}):1===n?this.sendText({text:s,type:3,contentType:1,dataType:0}):this.sendBuf({buf:e.from(s),type:3,contentType:3,dataType:0})))}},A=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case 2:s=g(s);break;case 1:s=T(s);break;default:s=m(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(s){return h()&&e.fork(this.shakeTimeout),s=t(s)?s.contentType?s:{jsonrpc:D,...s}:s,e.call(s)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case 2:s=g(s);break;case 1:s=T(s);break;default:s=m(s)}t&&t(s,((t,n,i={})=>2===e.request.contentType&&s?.jsonrpc===D?t?e.response({data:{jsonrpc:D,error:t}}):e.response({data:{jsonrpc:D,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(s,n={}){return h()&&e.fork(this.shakeTimeout),s=t(s)?n.contentType?s:{jsonrpc:D,...s}:s,e.request(s,{timeout:this.requestTimeout,...n}).then((e=>{if(!t(e)||e.jsonrpc!==D)return e;const{error:s,result:n}=e;if(s)throw s;return n}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}($);function M(){return{onInit(){this.messaging=A,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}const O="3.0";export{O as API_LEVEL,M as messagingPlugin};
diff --git a/node_modules/@zeppos/zml/dist/2.0/module/messaging/plugin/app.js b/node_modules/@zeppos/zml/dist/2.0/module/messaging/plugin/app.js
index 7c70140..5285855 100644
--- a/node_modules/@zeppos/zml/dist/2.0/module/messaging/plugin/app.js
+++ b/node_modules/@zeppos/zml/dist/2.0/module/messaging/plugin/app.js
@@ -1,8 +1,8 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;s()?t=hmApp.getPackageInfo:r()&&(t=e("@zos/app").getPackageInfo),s()?hmUI:r()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:r()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:r()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:r()&&e("@zos/router").push;let n=null;function s(){return a()&&i()}function r(){return a()&&o()}function i(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function a(){return i()||o()}function u(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}s()?n=hmBle:r()&&(n=e("@zos/ble"));let h=null;s()?h=DeviceRuntimeCore.HmLogger:r()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);class c{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const p=setTimeout,d=clearTimeout;var l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function f(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var y={exports:{}};
+let e=Buffer;function t(t){return"object"==typeof t&&!e.isBuffer(t)&&!Array.isArray(t)&&null!==t}let n=null;n="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let s=null;i()?s=hmApp.getPackageInfo:o()&&(s=n("@zos/app").getPackageInfo),i()?hmUI:o()&&n("@zos/ui"),i()?hmSetting.getDeviceInfo:o()&&n("@zos/device").getDeviceInfo,i()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:o()&&n("@zos/i18n").getText,i()?hmApp.gotoPage:o()&&n("@zos/router").push;let r=null;function i(){return h()&&a()}function o(){return h()&&u()}function a(){return"undefined"!=typeof hmApp}function u(){return"undefined"!=typeof __$$R$$__}function h(){return a()||u()}i()?r=hmBle:o()&&(r=n("@zos/ble"));let c=null;i()?c=DeviceRuntimeCore.HmLogger:o()?c=n("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(c=Logger);class p{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const d=setTimeout,l=clearTimeout;var f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function y(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var g={exports:{}};
 /*!
  * @overview es6-promise - a tiny implementation of Promises/A+.
  * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
  * @license   Licensed under MIT license
  *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
  * @version   v4.2.8+1e68dce6
- */y.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){d[n]=e,d[n+1]=t,2===(n+=2)&&(r?r(f):T())},o="undefined"!=typeof window?window:void 0,a=o||{},u=a.MutationObserver||a.WebKitMutationObserver,h="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function p(){var e=setTimeout;return function(){return e(f,1)}}var d=new Array(1e3);function f(){for(var e=0;e<n;e+=2)(0,d[e])(d[e+1]),d[e]=void 0,d[e+1]=void 0;n=0}var y,g,m,I,T=void 0;function v(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&j(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return x(r,s,o,n._result)}))}else P(n,s,e,t);return s}function b(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return q(t,e),t}T=h?function(){return process.nextTick(f)}:u?(g=0,m=new u(f),I=document.createTextNode(""),m.observe(I,{characterData:!0}),function(){I.data=g=++g%2}):c?((y=new MessageChannel).port1.onmessage=f,function(){return y.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(f)}:p()}catch(e){return p()}}():p();var w=Math.random().toString(36).substring(2);function _(){}var k=void 0,L=1,B=2;function S(t,n,s){n.constructor===t.constructor&&s===v&&n.constructor.resolve===b?function(e,t){t._state===L?U(e,t._result):t._state===B?C(e,t._result):P(t,void 0,(function(t){return q(e,t)}),(function(t){return C(e,t)}))}(t,n):void 0===s?U(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?q(e,n):U(e,n))}),(function(t){s||(s=!0,C(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,C(e,r))}),e)}(t,n,s):U(t,n)}function q(e,t){if(e===t)C(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)U(e,t);else{var n=void 0;try{n=t.then}catch(t){return void C(e,t)}S(e,t,n)}var s,r}function E(e){e._onerror&&e._onerror(e._result),A(e)}function U(e,t){e._state===k&&(e._result=t,e._state=L,0!==e._subscribers.length&&i(A,e))}function C(e,t){e._state===k&&(e._state=B,e._result=t,i(E,e))}function P(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+L]=n,r[o+B]=s,0===o&&e._state&&i(A,e)}function A(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function x(t,n,s,r){var i=e(s),o=void 0,a=void 0,u=!0;if(i){try{o=s(r)}catch(e){u=!1,a=e}if(n===o)return void C(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==k||(i&&u?q(n,o):!1===u?C(n,a):t===L?U(n,o):t===B&&C(n,o))}var D=0;function j(e){e[w]=D++,e._state=void 0,e._result=void 0,e._subscribers=[]}var $=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||j(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?U(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&U(this.promise,this._result))):C(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===k&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===b){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===v&&e._state!==k)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===M){var a=new n(_);o?C(a,i):S(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===k&&(this._remaining--,e===B?C(s,n):this._result[t]=n),0===this._remaining&&U(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;P(e,void 0,(function(e){return n._settledAt(L,t,e)}),(function(e){return n._settledAt(B,t,e)}))},e}(),M=function(){function t(e){this[w]=D++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){q(e,t)}),(function(t){C(e,t)}))}catch(t){C(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return M.prototype.then=v,M.all=function(e){return new $(this,e).promise},M.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},M.resolve=b,M.reject=function(e){var t=new this(_);return C(t,e),t},M._setScheduler=function(e){r=e},M._setAsap=function(e){i=e},M._asap=i,M.polyfill=function(){var e=void 0;if(void 0!==l)e=l;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=M},M.Promise=M,M}();const g=f(y.exports);function m(){const e={canceled:!1};return e.promise=new g((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function I(e,t){const n=m(),s=p((()=>{d(s),t?t&&t(n.resolve,n.reject):n.reject("Timed out in "+e+"ms.")}),e=e||1e3);return n.promise}function T(e){return b(function(e){return JSON.stringify(e)}(e))}function v(e){return t=w(e),JSON.parse(t);var t}function b(e){return Buffer.from(e,"utf-8")}function w(e){return e.toString("utf-8")}function _(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function k(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const L=a()?h.getLogger("device-message"):h.getLogger("side-message"),B=void 0,S="json",q="text",E="bin",U=0,C=1,P=2,A=3;function x(e){switch(e.toLowerCase()){case S:return P;case q:return C;case E:return A;case"empty":return U;default:return A}}let D=1e4;function j(){return D++}let $=1e3;function M(){return $++}class R extends c{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const n=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,n]):n}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class O{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new R(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class z extends Error{constructor(e,t){super(t),this.code=e}}class H extends c{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:r=(a()?n:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:a()?n:void 0}){super(),this.isDevice=a(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=r,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new O,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=m(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=p((()=>{this.shakeStatus=4,this.shakeTask.reject(new z(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&d(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return v(e)}json2Buf(e){return T(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=g.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt8(e.flag,s),s+=1,n.writeUInt8(e.version,s),s+=1,n.writeUInt16LE(e.type,s),s+=2,n.writeUInt16LE(e.port1,s),s+=2,n.writeUInt16LE(e.port2,s),s+=2,n.writeUInt32LE(e.appId,s),s+=4,n.writeUInt32LE(e.extra,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let n=0;const s=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const i=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const a=t.readUInt16LE(n);n+=2;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);return n+=4,{flag:s,version:r,type:i,port1:o,port2:a,appId:u,extra:h,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=B){if(t&&L.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,k(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=B){t&&L.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,k(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:s,dataType:r},{messageType:i=4}={}){const o=3518,a=t.byteLength;let u=0;const h=Buffer.alloc(o),c=e||j(),p=M();let d=1;const l=Math.ceil(a/o);function f(){return d++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=a-u,o=Buffer.alloc(0+e);t.copy(o,0,u,u+e),u+=e,this.sendDataWithSession({traceId:c,spanId:p,seqId:f(),payload:o,type:n,opCode:1,totalLength:a,contentType:s,dataType:r},{messageType:i});break}t.copy(h,0,u,u+o),u+=o,this.sendDataWithSession({traceId:c,spanId:p,seqId:f(),payload:h,type:n,opCode:0,totalLength:a,contentType:s,dataType:r},{messageType:i})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=T(t),o=e||j();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||j();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=b(t),o=e||j();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:u},{messageType:h}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:u});let p=this.isDevice?this.buildData(c,{type:h}):c;this.sendMsg(p)}buildPayload(e){const t=66+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt32LE(e.traceId,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(e.spanId,s),s+=4,n.writeUInt32LE(e.seqId,s),s+=4,n.writeUInt32LE(e.totalLength,s),s+=4,n.writeUInt32LE(e.payload.byteLength,s),s+=4,n.writeUInt8(e.type,s),s+=1,n.writeUInt8(e.opCode,s),s+=1,n.writeUInt32LE(this.now(),s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt8(e.contentType,s),s+=1,n.writeUInt8(e.dataType,s),s+=1,n.writeUInt16LE(0,s),s+=2,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}readPayload(e){const t=Buffer.from(e);let n=0;const s=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const i=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt8(n);n+=1;const c=t.readUInt8(n);n+=1;const p=t.readUInt32LE(n);n+=4;const d=t.readUInt32LE(n);n+=4;const l=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const I=t.readUInt8(n);n+=1;const T=t.readUInt8(n);n+=1;const v=t.readUInt16LE(n);n+=2;const b=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:s,parentId:r,spanId:i,seqId:o,totalLength:a,payloadLength:u,payloadType:h,opCode:c,contentType:I,dataType:T,timestamp1:p,timestamp2:d,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:v,extra2:b,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(a()&&!this.ble.connectStatus())throw new z(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(a&&!this.appSidePort)throw new z(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?x(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return g.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=E;"string"==typeof e?n=q:u(e)?n=S:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=E);const s={timeout:6e4,contentType:n,dataType:n},r=j(),i=m();t=Object.assign(s,t),this.handlers.set(r,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case C:s=w(t);break;case A:s=t;break;case P:s=v(t);break;default:s=t}i.resolve(s)})),Buffer.isBuffer(e)?this.sendBuf({requestId:r,buf:e,type:1,contentType:A,dataType:x(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:A,dataType:x(t.dataType)}):x(t.contentType)===P?this.sendJson({requestId:r,json:e,type:1,contentType:P,dataType:x(t.dataType)}):x(t.contentType)===C?this.sendText({requestId:r,text:e,type:1,contentType:C,dataType:x(t.dataType)}):this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:A,dataType:x(t.dataType)});let o=!1;return g.race([I(t.timeout,((e,n)=>{if(o)return e();n(new z(4,`request timed out in ${t.timeout}ms.`))})),i.promise.finally((()=>{o=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(r)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){A===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):C===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):P===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:A})}call(e){let t=P;return"string"==typeof e?t=C:u(e)?t=P:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=A),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:A,dataType:U}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:A,dataType:U}):t===P?this.sendJson({json:e,type:3,contentType:P,dataType:U}):t===C?this.sendText({text:e,type:3,contentType:C,dataType:U}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:A,dataType:U})))}}h.getLogger("message-builder");const J="hmrpcv1";function W(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}function F(e){const n={shakeTimeout:5e3,requestTimeout:6e4,transport:s=new H({appId:t().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(s.on("call",(({contentType:t,payload:n})=>{switch(t){case P:n=v(n);break;case C:n=w(n);break;default:n=_(n)}e&&e(n)})),this):this},offOnCall(e){return s.off("call",e),this},call(e){return a()&&s.fork(this.shakeTimeout),e=u(e)?e.contentType?e:{jsonrpc:J,...e}:e,s.call(e)},onRequest(e){return e?(s.on("request",(t=>{let n=t.request.payload;switch(t.request.contentType){case P:n=v(n);break;case C:n=w(n);break;default:n=_(n)}e&&e(n,((e,s,r={})=>t.request.contentType===P&&n?.jsonrpc===J?e?t.response({data:{jsonrpc:J,error:e}}):t.response({data:{jsonrpc:J,result:s}}):t.response({data:s,...r})))})),this):this},cancelAllRequest(){return s.off("response"),this},offOnRequest(e){return s.off("request",e),this},request(e,t={}){return a()&&s.fork(this.shakeTimeout),e=u(e)?t.contentType?e:{jsonrpc:J,...e}:e,s.request(e,{timeout:this.requestTimeout,...t}).then((e=>{if(!u(e)||e.jsonrpc!==J)return e;const{error:t,result:n}=e;if(t)throw t;return n}))},connect(){return s.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this},start(){return s.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this}};var s;return{onCreate(){this.messaging=this.globalData.messaging=n,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:W}}const V="2.0";export{V as API_LEVEL,F as appPlugin};
+ */g.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){d[n]=e,d[n+1]=t,2===(n+=2)&&(r?r(l):T())},o="undefined"!=typeof window?window:void 0,a=o||{},u=a.MutationObserver||a.WebKitMutationObserver,h="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function p(){var e=setTimeout;return function(){return e(l,1)}}var d=new Array(1e3);function l(){for(var e=0;e<n;e+=2)(0,d[e])(d[e+1]),d[e]=void 0,d[e+1]=void 0;n=0}var y,g,m,I,T=void 0;function v(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&M(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return x(r,s,o,n._result)}))}else P(n,s,e,t);return s}function b(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return U(t,e),t}T=h?function(){return process.nextTick(l)}:u?(g=0,m=new u(l),I=document.createTextNode(""),m.observe(I,{characterData:!0}),function(){I.data=g=++g%2}):c?((y=new MessageChannel).port1.onmessage=l,function(){return y.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(l)}:p()}catch(e){return p()}}():p();var w=Math.random().toString(36).substring(2);function _(){}var L=void 0,S=1,k=2;function E(t,n,s){n.constructor===t.constructor&&s===v&&n.constructor.resolve===b?function(e,t){t._state===S?B(e,t._result):t._state===k?q(e,t._result):P(t,void 0,(function(t){return U(e,t)}),(function(t){return q(e,t)}))}(t,n):void 0===s?B(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?U(e,n):B(e,n))}),(function(t){s||(s=!0,q(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,q(e,r))}),e)}(t,n,s):B(t,n)}function U(e,t){if(e===t)q(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)B(e,t);else{var n=void 0;try{n=t.then}catch(t){return void q(e,t)}E(e,t,n)}var s,r}function C(e){e._onerror&&e._onerror(e._result),A(e)}function B(e,t){e._state===L&&(e._result=t,e._state=S,0!==e._subscribers.length&&i(A,e))}function q(e,t){e._state===L&&(e._state=k,e._result=t,i(C,e))}function P(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+S]=n,r[o+k]=s,0===o&&e._state&&i(A,e)}function A(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function x(t,n,s,r){var i=e(s),o=void 0,a=void 0,u=!0;if(i){try{o=s(r)}catch(e){u=!1,a=e}if(n===o)return void q(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==L||(i&&u?U(n,o):!1===u?q(n,a):t===S?B(n,o):t===k&&q(n,o))}var D=0;function M(e){e[w]=D++,e._state=void 0,e._result=void 0,e._subscribers=[]}var j=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||M(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?B(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&B(this.promise,this._result))):q(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===L&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===b){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===v&&e._state!==L)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===O){var a=new n(_);o?q(a,i):E(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===L&&(this._remaining--,e===k?q(s,n):this._result[t]=n),0===this._remaining&&B(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;P(e,void 0,(function(e){return n._settledAt(S,t,e)}),(function(e){return n._settledAt(k,t,e)}))},e}(),O=function(){function t(e){this[w]=D++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){U(e,t)}),(function(t){q(e,t)}))}catch(t){q(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return O.prototype.then=v,O.all=function(e){return new j(this,e).promise},O.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},O.resolve=b,O.reject=function(e){var t=new this(_);return q(t,e),t},O._setScheduler=function(e){r=e},O._setAsap=function(e){i=e},O._asap=i,O.polyfill=function(){var e=void 0;if(void 0!==f)e=f;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=O},O.Promise=O,O}();var m=y(g.exports);globalThis.Promise=m;const I=m;function T(){const e={canceled:!1};return e.promise=new I((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function v(e){return w(function(e){return JSON.stringify(e)}(e))}function b(e){return t=_(e),JSON.parse(t);var t}function w(t){return e.from(t,"utf-8")}function _(e){return e.toString("utf-8")}function L(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function S(t){return n=function(t){return e.from(t)}(t),n.toString("hex");var n}const k=h()?c.getLogger("device-message"):c.getLogger("side-message"),E=void 0,U="json",C="text",B="bin",q=0,P=1,A=2,x=3;function D(e){switch(e.toLowerCase()){case U:return A;case C:return P;case B:return x;case"empty":return q;default:return x}}let M=1e4;function j(){return M++}let O=1e3;function $(){return O++}class R extends p{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.count=0,this.finishChunk=null,k.log("Session Created.")}addChunk(t){if(1===t.opCode&&(this.count=t.seqId,this.finishChunk=t),t.payloadLength!==t.payload.byteLength)return void this.emit("error",Error(`receive chunk data length error, expect ${t.payloadLength} but ${t.payload.byteLength}`));this.tempBuf||(this.tempBuf=e.alloc(t.totalLength));const n=3518*(t.seqId-1);t.payload.copy(this.tempBuf,n),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class z{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new R(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const H={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class J extends Error{constructor(e,t){super(t),this.code=e}}class W extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:s=(h()?r:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:h()?r:void 0}){super(),this.isDevice=h(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=s,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new z,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=T(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=d((()=>{this.shakeStatus=4,this.shakeTask.reject(new J(H.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&l(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return b(e)}json2Buf(e){return v(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=I.resolve(),e&&e(this)}buildBin(t){if(t.payload.byteLength>this.chunkSize)throw new Error(`${t.payload.byteLength} greater than max size of ${this.chunkSize}`);const n=this.getMessageHeaderSize()+t.payload.byteLength;let s=e.alloc(n),r=0;return s.writeUInt8(t.flag,r),r+=1,s.writeUInt8(t.version,r),r+=1,s.writeUInt16LE(t.type,r),r+=2,s.writeUInt16LE(t.port1,r),r+=2,s.writeUInt16LE(t.port2,r),r+=2,s.writeUInt32LE(t.appId,r),r+=4,s.writeUInt32LE(t.extra,r),r+=4,s.fill(t.payload,r,t.payload.byteLength+r),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(t){const n=e.from(t);let s=0;const r=n.readUInt8(s);s+=1;const i=n.readUInt8(s);s+=1;const o=n.readUInt16LE(s);s+=2;const a=n.readUInt16LE(s);s+=2;const u=n.readUInt16LE(s);s+=2;const h=n.readUInt32LE(s);s+=4;const c=n.readUInt32LE(s);return s+=4,{flag:r,version:i,type:o,port1:a,port2:u,appId:h,extra:c,payload:n.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=E){if(t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,S(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=E){t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,S(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:t,dataBin:n,type:s,contentType:r,dataType:i},{messageType:o=4}={}){const a=3518,u=n.byteLength;let h=0;const c=e.alloc(a),p=t||j(),d=$();let l=1;const f=Math.ceil(u/a);function y(){return l++}for(let t=1;t<=f;t++){if(this.errorIfBleDisconnect(),t===f){const t=u-h,a=e.alloc(0+t);n.copy(a,0,h,h+t),h+=t,this.sendDataWithSession({traceId:p,spanId:d,seqId:y(),payload:a,type:s,opCode:1,totalLength:u,contentType:r,dataType:i},{messageType:o});break}n.copy(c,0,h,h+a),h+=a,this.sendDataWithSession({traceId:p,spanId:d,seqId:y(),payload:c,type:s,opCode:0,totalLength:u,contentType:r,dataType:i},{messageType:o})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=v(t),o=e||j();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||j();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=w(t),o=e||j();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:u},{messageType:h}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:u});let p=this.isDevice?this.buildData(c,{type:h}):c;this.sendMsg(p)}buildPayload(t){const n=66+t.payload.byteLength;let s=e.alloc(n),r=0;return s.writeUInt32LE(t.traceId,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(t.spanId,r),r+=4,s.writeUInt32LE(t.seqId,r),r+=4,s.writeUInt32LE(t.totalLength,r),r+=4,s.writeUInt32LE(t.payload.byteLength,r),r+=4,s.writeUInt8(t.type,r),r+=1,s.writeUInt8(t.opCode,r),r+=1,s.writeUInt32LE(this.now(),r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.writeUInt8(t.contentType,r),r+=1,s.writeUInt8(t.dataType,r),r+=1,s.writeUInt16LE(0,r),r+=2,s.writeUInt32LE(0,r),r+=4,s.writeUInt32LE(0,r),r+=4,s.fill(t.payload,r,t.payload.byteLength+r),s}readPayload(t){const n=e.from(t);let s=0;const r=n.readUInt32LE(s);s+=4;const i=n.readUInt32LE(s);s+=4;const o=n.readUInt32LE(s);s+=4;const a=n.readUInt32LE(s);s+=4;const u=n.readUInt32LE(s);s+=4;const h=n.readUInt32LE(s);s+=4;const c=n.readUInt8(s);s+=1;const p=n.readUInt8(s);s+=1;const d=n.readUInt32LE(s);s+=4;const l=n.readUInt32LE(s);s+=4;const f=n.readUInt32LE(s);s+=4;const y=n.readUInt32LE(s);s+=4;const g=n.readUInt32LE(s);s+=4;const m=n.readUInt32LE(s);s+=4;const I=n.readUInt32LE(s);s+=4;const T=n.readUInt8(s);s+=1;const v=n.readUInt8(s);s+=1;const b=n.readUInt16LE(s);s+=2;const w=n.readUInt32LE(s);s+=4;const _=n.readUInt32LE(s);return s+=4,{traceId:r,parentId:i,spanId:o,seqId:a,totalLength:u,payloadLength:h,payloadType:c,opCode:p,contentType:T,dataType:v,timestamp1:d,timestamp2:l,timestamp3:f,timestamp4:y,timestamp5:g,timestamp6:m,timestamp7:I,extra1:b,extra2:w,extra3:_,payload:n.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(h()&&!this.ble.connectStatus())throw new J(H.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(h()&&!this.appSidePort)throw new J(H.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?D(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(n,s){try{this.errorIfBleDisconnect()}catch(e){return I.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let r=B;"string"==typeof n?r=C:t(n)?r=U:(n instanceof ArrayBuffer||ArrayBuffer.isView(n)||e.isBuffer(n))&&(r=B);const i={timeout:6e4,contentType:r,dataType:r},o=j(),a=T();s=Object.assign(i,s);let u=d((()=>{u=null,a.reject(new J(H.TIMEOUT,"request timeout"))}),s.timeout);return this.handlers.set(o,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case P:s=_(t);break;case x:s=t;break;case A:s=b(t);break;default:s=t}a.resolve(s)})),e.isBuffer(n)?this.sendBuf({requestId:o,buf:n,type:1,contentType:x,dataType:D(s.dataType)}):n instanceof ArrayBuffer||ArrayBuffer.isView(n)?this.sendBuf({requestId:o,buf:e.from(n),type:1,contentType:x,dataType:D(s.dataType)}):D(s.contentType)===A?this.sendJson({requestId:o,json:n,type:1,contentType:A,dataType:D(s.dataType)}):D(s.contentType)===P?this.sendText({requestId:o,text:n,type:1,contentType:P,dataType:D(s.dataType)}):this.sendBuf({requestId:o,buf:e.from(n),type:1,contentType:x,dataType:D(s.dataType)}),a.promise.catch((e=>{throw e})).finally((()=>{u&&(l(u),u=null),this.handlers.delete(o)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){x===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):P===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):A===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:x})}call(n){let s=A;return"string"==typeof n?s=P:t(n)?s=A:(n instanceof ArrayBuffer||ArrayBuffer.isView(n)||e.isBuffer(n))&&(s=x),this.waitingShakePromise.then((()=>e.isBuffer(n)?this.sendBuf({buf:n,type:3,contentType:x,dataType:q}):n instanceof ArrayBuffer||ArrayBuffer.isView(n)?this.sendBuf({buf:e.from(n),type:3,contentType:x,dataType:q}):s===A?this.sendJson({json:n,type:3,contentType:A,dataType:q}):s===P?this.sendText({text:n,type:3,contentType:P,dataType:q}):this.sendBuf({buf:e.from(n),type:3,contentType:x,dataType:q})))}}c.getLogger("message-builder");const F="hmrpcv1";function V(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}function K(e){const n={shakeTimeout:5e3,requestTimeout:6e4,transport:r=new W({appId:s().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(r.on("call",(({contentType:t,payload:n})=>{switch(t){case A:n=b(n);break;case P:n=_(n);break;default:n=L(n)}e&&e(n)})),this):this},offOnCall(e){return r.off("call",e),this},call(e){return h()&&r.fork(this.shakeTimeout),e=t(e)?e.contentType?e:{jsonrpc:F,...e}:e,r.call(e)},onRequest(e){return e?(r.on("request",(t=>{let n=t.request.payload;switch(t.request.contentType){case A:n=b(n);break;case P:n=_(n);break;default:n=L(n)}e&&e(n,((e,s,r={})=>t.request.contentType===A&&n?.jsonrpc===F?e?t.response({data:{jsonrpc:F,error:e}}):t.response({data:{jsonrpc:F,result:s}}):t.response({data:s,...r})))})),this):this},cancelAllRequest(){return r.off("response"),this},offOnRequest(e){return r.off("request",e),this},request(e,n={}){return h()&&r.fork(this.shakeTimeout),e=t(e)?n.contentType?e:{jsonrpc:F,...e}:e,r.request(e,{timeout:this.requestTimeout,...n}).then((e=>{if(!t(e)||e.jsonrpc!==F)return e;const{error:n,result:s}=e;if(n)throw n;return s}))},connect(){return r.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),r.disConnect((()=>{})),this},start(){return r.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),r.disConnect((()=>{})),this}};var r;return{onCreate(){this.messaging=this.globalData.messaging=n,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:V}}const N="2.0";export{N as API_LEVEL,K as appPlugin};
diff --git a/node_modules/@zeppos/zml/dist/2.0/module/messaging/plugin/side.js b/node_modules/@zeppos/zml/dist/2.0/module/messaging/plugin/side.js
index e769247..0280869 100644
--- a/node_modules/@zeppos/zml/dist/2.0/module/messaging/plugin/side.js
+++ b/node_modules/@zeppos/zml/dist/2.0/module/messaging/plugin/side.js
@@ -1,8 +1 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},n()?hmApp.getPackageInfo:s()&&e("@zos/app").getPackageInfo,n()?hmUI:s()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:s()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:s()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:s()&&e("@zos/router").push;let t=null;function n(){return o()&&r()}function s(){return o()&&i()}function r(){return"undefined"!=typeof hmApp}function i(){return"undefined"!=typeof __$$R$$__}function o(){return r()||i()}function a(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}n()?t=hmBle:s()&&(t=e("@zos/ble"));let u=null;n()?u=DeviceRuntimeCore.HmLogger:s()?u=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(u=Logger);class h{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const c=setTimeout,d=clearTimeout;var p="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function l(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var f={exports:{}};
-/*!
- * @overview es6-promise - a tiny implementation of Promises/A+.
- * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
- * @license   Licensed under MIT license
- *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
- * @version   v4.2.8+1e68dce6
- */f.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){l[n]=e,l[n+1]=t,2===(n+=2)&&(r?r(f):T())},o="undefined"!=typeof window?window:void 0,a=o||{},u=a.MutationObserver||a.WebKitMutationObserver,h="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function d(){var e=setTimeout;return function(){return e(f,1)}}var l=new Array(1e3);function f(){for(var e=0;e<n;e+=2)(0,l[e])(l[e+1]),l[e]=void 0,l[e+1]=void 0;n=0}var y,g,m,I,T=void 0;function b(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&R(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return x(r,s,o,n._result)}))}else A(n,s,e,t);return s}function v(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return q(t,e),t}T=h?function(){return process.nextTick(f)}:u?(g=0,m=new u(f),I=document.createTextNode(""),m.observe(I,{characterData:!0}),function(){I.data=g=++g%2}):c?((y=new MessageChannel).port1.onmessage=f,function(){return y.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(f)}:d()}catch(e){return d()}}():d();var w=Math.random().toString(36).substring(2);function _(){}var k=void 0,L=1,B=2;function S(t,n,s){n.constructor===t.constructor&&s===b&&n.constructor.resolve===v?function(e,t){t._state===L?E(e,t._result):t._state===B?C(e,t._result):A(t,void 0,(function(t){return q(e,t)}),(function(t){return C(e,t)}))}(t,n):void 0===s?E(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?q(e,n):E(e,n))}),(function(t){s||(s=!0,C(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,C(e,r))}),e)}(t,n,s):E(t,n)}function q(e,t){if(e===t)C(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)E(e,t);else{var n=void 0;try{n=t.then}catch(t){return void C(e,t)}S(e,t,n)}var s,r}function U(e){e._onerror&&e._onerror(e._result),P(e)}function E(e,t){e._state===k&&(e._result=t,e._state=L,0!==e._subscribers.length&&i(P,e))}function C(e,t){e._state===k&&(e._state=B,e._result=t,i(U,e))}function A(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+L]=n,r[o+B]=s,0===o&&e._state&&i(P,e)}function P(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function x(t,n,s,r){var i=e(s),o=void 0,a=void 0,u=!0;if(i){try{o=s(r)}catch(e){u=!1,a=e}if(n===o)return void C(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==k||(i&&u?q(n,o):!1===u?C(n,a):t===L?E(n,o):t===B&&C(n,o))}var D=0;function R(e){e[w]=D++,e._state=void 0,e._result=void 0,e._subscribers=[]}var j=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||R(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?E(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&E(this.promise,this._result))):C(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===k&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===v){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===b&&e._state!==k)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===$){var a=new n(_);o?C(a,i):S(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===k&&(this._remaining--,e===B?C(s,n):this._result[t]=n),0===this._remaining&&E(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;A(e,void 0,(function(e){return n._settledAt(L,t,e)}),(function(e){return n._settledAt(B,t,e)}))},e}(),$=function(){function t(e){this[w]=D++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){q(e,t)}),(function(t){C(e,t)}))}catch(t){C(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return $.prototype.then=b,$.all=function(e){return new j(this,e).promise},$.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},$.resolve=v,$.reject=function(e){var t=new this(_);return C(t,e),t},$._setScheduler=function(e){r=e},$._setAsap=function(e){i=e},$._asap=i,$.polyfill=function(){var e=void 0;if(void 0!==p)e=p;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=$},$.Promise=$,$}();const y=l(f.exports);function g(){const e={canceled:!1};return e.promise=new y((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function m(e,t){const n=g(),s=c((()=>{d(s),t?t&&t(n.resolve,n.reject):n.reject("Timed out in "+e+"ms.")}),e=e||1e3);return n.promise}function I(e){return b(function(e){return JSON.stringify(e)}(e))}function T(e){return t=v(e),JSON.parse(t);var t}function b(e){return Buffer.from(e,"utf-8")}function v(e){return e.toString("utf-8")}function w(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function _(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const k=o()?u.getLogger("device-message"):u.getLogger("side-message"),L=void 0,B="json",S="text",q="bin";function U(e){switch(e.toLowerCase()){case B:return 2;case S:return 1;case q:return 3;case"empty":return 0;default:return 3}}let E=1e4;function C(){return E++}let A=1e3;function P(){return A++}class x extends h{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const n=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,n]):n}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class D{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new x(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class R extends Error{constructor(e,t){super(t),this.code=e}}u.getLogger("message-builder");const j="hmrpcv1",$=new class extends h{constructor({appId:e=0,appDevicePort:n=20,appSidePort:s=0,ble:r=(o()?t:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?t:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=n,this.appSidePort=s,this.ble=r,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new D,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=g(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=c((()=>{this.shakeStatus=4,this.shakeTask.reject(new R(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&d(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return T(e)}json2Buf(e){return I(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=y.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt8(e.flag,s),s+=1,n.writeUInt8(e.version,s),s+=1,n.writeUInt16LE(e.type,s),s+=2,n.writeUInt16LE(e.port1,s),s+=2,n.writeUInt16LE(e.port2,s),s+=2,n.writeUInt32LE(e.appId,s),s+=4,n.writeUInt32LE(e.extra,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let n=0;const s=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const i=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const a=t.readUInt16LE(n);n+=2;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);return n+=4,{flag:s,version:r,type:i,port1:o,port2:a,appId:u,extra:h,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=L){if(t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,_(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=L){t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,_(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:s,dataType:r},{messageType:i=4}={}){const o=3518,a=t.byteLength;let u=0;const h=Buffer.alloc(o),c=e||C(),d=P();let p=1;const l=Math.ceil(a/o);function f(){return p++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=a-u,o=Buffer.alloc(0+e);t.copy(o,0,u,u+e),u+=e,this.sendDataWithSession({traceId:c,spanId:d,seqId:f(),payload:o,type:n,opCode:1,totalLength:a,contentType:s,dataType:r},{messageType:i});break}t.copy(h,0,u,u+o),u+=o,this.sendDataWithSession({traceId:c,spanId:d,seqId:f(),payload:h,type:n,opCode:0,totalLength:a,contentType:s,dataType:r},{messageType:i})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=I(t),o=e||C();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||C();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=b(t),o=e||C();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:u},{messageType:h}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:u});let d=this.isDevice?this.buildData(c,{type:h}):c;this.sendMsg(d)}buildPayload(e){const t=66+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt32LE(e.traceId,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(e.spanId,s),s+=4,n.writeUInt32LE(e.seqId,s),s+=4,n.writeUInt32LE(e.totalLength,s),s+=4,n.writeUInt32LE(e.payload.byteLength,s),s+=4,n.writeUInt8(e.type,s),s+=1,n.writeUInt8(e.opCode,s),s+=1,n.writeUInt32LE(this.now(),s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt8(e.contentType,s),s+=1,n.writeUInt8(e.dataType,s),s+=1,n.writeUInt16LE(0,s),s+=2,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}readPayload(e){const t=Buffer.from(e);let n=0;const s=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const i=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt8(n);n+=1;const c=t.readUInt8(n);n+=1;const d=t.readUInt32LE(n);n+=4;const p=t.readUInt32LE(n);n+=4;const l=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const I=t.readUInt8(n);n+=1;const T=t.readUInt8(n);n+=1;const b=t.readUInt16LE(n);n+=2;const v=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:s,parentId:r,spanId:i,seqId:o,totalLength:a,payloadLength:u,payloadType:h,opCode:c,contentType:I,dataType:T,timestamp1:d,timestamp2:p,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:b,extra2:v,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new R(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new R(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?U(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return y.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=q;"string"==typeof e?n=S:a(e)?n=B:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=q);const s={timeout:6e4,contentType:n,dataType:n},r=C(),i=g();t=Object.assign(s,t),this.handlers.set(r,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case 1:s=v(t);break;case 3:default:s=t;break;case 2:s=T(t)}i.resolve(s)})),Buffer.isBuffer(e)?this.sendBuf({requestId:r,buf:e,type:1,contentType:3,dataType:U(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:3,dataType:U(t.dataType)}):2===U(t.contentType)?this.sendJson({requestId:r,json:e,type:1,contentType:2,dataType:U(t.dataType)}):1===U(t.contentType)?this.sendText({requestId:r,text:e,type:1,contentType:1,dataType:U(t.dataType)}):this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:3,dataType:U(t.dataType)});let o=!1;return y.race([m(t.timeout,((e,n)=>{if(o)return e();n(new R(4,`request timed out in ${t.timeout}ms.`))})),i.promise.finally((()=>{o=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(r)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){3===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):1===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):2===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:a(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}},M=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:n})=>{switch(e){case 2:n=T(n);break;case 1:n=v(n);break;default:n=w(n)}t&&t(n)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=a(t)?t.contentType?t:{jsonrpc:j,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let n=e.request.payload;switch(e.request.contentType){case 2:n=T(n);break;case 1:n=v(n);break;default:n=w(n)}t&&t(n,((t,s,r={})=>2===e.request.contentType&&n?.jsonrpc===j?t?e.response({data:{jsonrpc:j,error:t}}):e.response({data:{jsonrpc:j,result:s}}):e.response({data:s,...r})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,n={}){return o()&&e.fork(this.shakeTimeout),t=a(t)?n.contentType?t:{jsonrpc:j,...t}:t,e.request(t,{timeout:this.requestTimeout,...n}).then((e=>{if(!a(e)||e.jsonrpc!==j)return e;const{error:t,result:n}=e;if(t)throw t;return n}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}($);function O(){return{onInit(){this.messaging=M,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}const z="3.0";export{z as API_LEVEL,O as messagingPlugin};
+const e=Buffer;function t(t){return"object"==typeof t&&!e.isBuffer(t)&&!Array.isArray(t)&&null!==t}let s=null;s="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},i()?hmApp.getPackageInfo:r()&&s("@zos/app").getPackageInfo,i()?hmUI:r()&&s("@zos/ui"),i()?hmSetting.getDeviceInfo:r()&&s("@zos/device").getDeviceInfo,i()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:r()&&s("@zos/i18n").getText,i()?hmApp.gotoPage:r()&&s("@zos/router").push;let n=null;function i(){return h()&&a()}function r(){return h()&&o()}function a(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function h(){return a()||o()}i()?n=hmBle:r()&&(n=s("@zos/ble"));let d=null;i()?d=DeviceRuntimeCore.HmLogger:r()?d=s("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(d=Logger);class p{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const c=setTimeout,u=clearTimeout,l=Promise;function y(){const e={canceled:!1};return e.promise=new l((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function f(e){return I(function(e){return JSON.stringify(e)}(e))}function g(e){return t=T(e),JSON.parse(t);var t}function I(t){return e.from(t,"utf-8")}function T(e){return e.toString("utf-8")}function m(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function L(t){return s=function(t){return e.from(t)}(t),s.toString("hex");var s}const b=h()?d.getLogger("device-message"):d.getLogger("side-message"),k=void 0,S="json",w="text",U="bin";function E(e){switch(e.toLowerCase()){case S:return 2;case w:return 1;case U:return 3;case"empty":return 0;default:return 3}}let q=1e4;function B(){return q++}let C=1e3;function _(){return C++}class v extends p{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,b.log("Session Created.")}addChunk(t){if(1===t.opCode&&(this.count=t.seqId,this.finishChunk=t),t.payloadLength!==t.payload.byteLength)return void this.emit("error",Error(`receive chunk data length error, expect ${t.payloadLength} but ${t.payload.byteLength}`));this.tempBuf||(this.tempBuf=e.alloc(t.totalLength));const s=3518*(t.seqId-1);t.payload.copy(this.tempBuf,s),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class P{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new v(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const R={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class x extends Error{constructor(e,t){super(t),this.code=e}}d.getLogger("message-builder");const D="hmrpcv1",$=new class extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:i=(h()?n:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:h()?n:void 0}){super(),this.isDevice=h(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new P,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=y(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=c((()=>{this.shakeStatus=4,this.shakeTask.reject(new x(R.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=l.resolve(),e&&e(this)}buildBin(t){if(t.payload.byteLength>this.chunkSize)throw new Error(`${t.payload.byteLength} greater than max size of ${this.chunkSize}`);const s=this.getMessageHeaderSize()+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt8(t.flag,i),i+=1,n.writeUInt8(t.version,i),i+=1,n.writeUInt16LE(t.type,i),i+=2,n.writeUInt16LE(t.port1,i),i+=2,n.writeUInt16LE(t.port2,i),i+=2,n.writeUInt32LE(t.appId,i),i+=4,n.writeUInt32LE(t.extra,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(t){const s=e.from(t);let n=0;const i=s.readUInt8(n);n+=1;const r=s.readUInt8(n);n+=1;const a=s.readUInt16LE(n);n+=2;const o=s.readUInt16LE(n);n+=2;const h=s.readUInt16LE(n);n+=2;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt32LE(n);return n+=4,{flag:i,version:r,type:a,port1:o,port2:h,appId:d,extra:p,payload:s.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=k){if(t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=k){t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:t,dataBin:s,type:n,contentType:i,dataType:r},{messageType:a=4}={}){const o=3518,h=s.byteLength;let d=0;const p=e.alloc(o),c=t||B(),u=_();let l=1;const y=Math.ceil(h/o);function f(){return l++}for(let t=1;t<=y;t++){if(this.errorIfBleDisconnect(),t===y){const t=h-d,o=e.alloc(0+t);s.copy(o,0,d,d+t),d+=t,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:o,type:n,opCode:1,totalLength:h,contentType:i,dataType:r},{messageType:a});break}s.copy(p,0,d,d+o),d+=o,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:p,type:n,opCode:0,totalLength:h,contentType:i,dataType:r},{messageType:a})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),a=e||B();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||B();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=I(t),a=e||B();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let c=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(c)}buildPayload(t){const s=66+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt32LE(t.traceId,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(t.spanId,i),i+=4,n.writeUInt32LE(t.seqId,i),i+=4,n.writeUInt32LE(t.totalLength,i),i+=4,n.writeUInt32LE(t.payload.byteLength,i),i+=4,n.writeUInt8(t.type,i),i+=1,n.writeUInt8(t.opCode,i),i+=1,n.writeUInt32LE(this.now(),i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt8(t.contentType,i),i+=1,n.writeUInt8(t.dataType,i),i+=1,n.writeUInt16LE(0,i),i+=2,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}readPayload(t){const s=e.from(t);let n=0;const i=s.readUInt32LE(n);n+=4;const r=s.readUInt32LE(n);n+=4;const a=s.readUInt32LE(n);n+=4;const o=s.readUInt32LE(n);n+=4;const h=s.readUInt32LE(n);n+=4;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt8(n);n+=1;const c=s.readUInt8(n);n+=1;const u=s.readUInt32LE(n);n+=4;const l=s.readUInt32LE(n);n+=4;const y=s.readUInt32LE(n);n+=4;const f=s.readUInt32LE(n);n+=4;const g=s.readUInt32LE(n);n+=4;const I=s.readUInt32LE(n);n+=4;const T=s.readUInt32LE(n);n+=4;const m=s.readUInt8(n);n+=1;const L=s.readUInt8(n);n+=1;const b=s.readUInt16LE(n);n+=2;const k=s.readUInt32LE(n);n+=4;const S=s.readUInt32LE(n);return n+=4,{traceId:i,parentId:r,spanId:a,seqId:o,totalLength:h,payloadLength:d,payloadType:p,opCode:c,contentType:m,dataType:L,timestamp1:u,timestamp2:l,timestamp3:y,timestamp4:f,timestamp5:g,timestamp6:I,timestamp7:T,extra1:b,extra2:k,extra3:S,payload:s.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(h()&&!this.ble.connectStatus())throw new x(R.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(h()&&!this.appSidePort)throw new x(R.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?E(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(s,n){try{this.errorIfBleDisconnect()}catch(e){return l.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let i=U;"string"==typeof s?i=w:t(s)?i=S:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(i=U);const r={timeout:6e4,contentType:i,dataType:i},a=B(),o=y();n=Object.assign(r,n);let h=c((()=>{h=null,o.reject(new x(R.TIMEOUT,"request timeout"))}),n.timeout);return this.handlers.set(a,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=T(t);break;case 3:default:n=t;break;case 2:n=g(t)}o.resolve(n)})),e.isBuffer(s)?this.sendBuf({requestId:a,buf:s,type:1,contentType:3,dataType:E(n.dataType)}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:3,dataType:E(n.dataType)}):2===E(n.contentType)?this.sendJson({requestId:a,json:s,type:1,contentType:2,dataType:E(n.dataType)}):1===E(n.contentType)?this.sendText({requestId:a,text:s,type:1,contentType:1,dataType:E(n.dataType)}):this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:3,dataType:E(n.dataType)}),o.promise.catch((e=>{throw e})).finally((()=>{h&&(u(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(s){let n=2;return"string"==typeof s?n=1:t(s)?n=2:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(n=3),this.waitingShakePromise.then((()=>e.isBuffer(s)?this.sendBuf({buf:s,type:3,contentType:3,dataType:0}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({buf:e.from(s),type:3,contentType:3,dataType:0}):2===n?this.sendJson({json:s,type:3,contentType:2,dataType:0}):1===n?this.sendText({text:s,type:3,contentType:1,dataType:0}):this.sendBuf({buf:e.from(s),type:3,contentType:3,dataType:0})))}},A=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case 2:s=g(s);break;case 1:s=T(s);break;default:s=m(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(s){return h()&&e.fork(this.shakeTimeout),s=t(s)?s.contentType?s:{jsonrpc:D,...s}:s,e.call(s)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case 2:s=g(s);break;case 1:s=T(s);break;default:s=m(s)}t&&t(s,((t,n,i={})=>2===e.request.contentType&&s?.jsonrpc===D?t?e.response({data:{jsonrpc:D,error:t}}):e.response({data:{jsonrpc:D,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(s,n={}){return h()&&e.fork(this.shakeTimeout),s=t(s)?n.contentType?s:{jsonrpc:D,...s}:s,e.request(s,{timeout:this.requestTimeout,...n}).then((e=>{if(!t(e)||e.jsonrpc!==D)return e;const{error:s,result:n}=e;if(s)throw s;return n}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}($);function M(){return{onInit(){this.messaging=A,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}const O="3.0";export{O as API_LEVEL,M as messagingPlugin};
diff --git a/node_modules/@zeppos/zml/dist/3.0/module/app-service/plugin/app.js b/node_modules/@zeppos/zml/dist/3.0/module/app-service/plugin/app.js
index e02ea6e..704ea15 100644
--- a/node_modules/@zeppos/zml/dist/3.0/module/app-service/plugin/app.js
+++ b/node_modules/@zeppos/zml/dist/3.0/module/app-service/plugin/app.js
@@ -1 +1 @@
-let e=null;function s(){return i()&&r()}function t(){return i()&&n()}function r(){return"undefined"!=typeof hmApp}function n(){return"undefined"!=typeof __$$R$$__}function i(){return r()||n()}function o(e){if(!e||"object"!=typeof e)throw new Error("obj is required and must be an object");const s=[];for(let[t,r]of Object.entries(e))t=encodeURIComponent(t),Array.isArray(r)?r.forEach((e=>{s.push(`${t}[]=${encodeURIComponent(e)}`)})):s.push(`${t}=${encodeURIComponent(r)}`);return s.join("&")}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},s()?hmApp.getPackageInfo:t()&&e("@zos/app").getPackageInfo,s()?hmUI:t()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:t()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:t()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:t()&&e("@zos/router").push,s()?hmBle:t()&&e("@zos/ble"),e("@zos/utils").qs.parse;const{queryPermission:a,requestPermission:u}=e("@zos/app"),{showToast:c}=e("@zos/interaction");class l{static PermissionStatus={unauthorized:0,error:1,authorized:2};static RequestPermissionResult={cancel:0,error:1,granted:2};static request(e,s){const t=a({permissions:e})[0];switch(t){case l.PermissionStatus.unauthorized:u({permissions:e,callback([e]){switch(e){case l.RequestPermissionResult.granted:c({content:"permission: granted"}),s&&s({code:e});break;case l.RequestPermissionResult.cancel:c({content:"permission: canceled"}),s&&s({error:new Error(e)});break;default:c({content:"permission: request error"}),s&&s({error:new Error(e)})}}});break;case l.PermissionStatus.authorized:s&&s({code:t});break;default:c({content:"permission: query error"}),s&&s({error:new Error(t)})}}}const{showToast:h}=e("@zos/interaction"),{EventBus:g}=e("@zos/utils"),p=e("@zos/app-service"),_=["device:os.bg_service"];class f{constructor(e){this.url=e,this._onMessage=null,this.BgService=null}get onMessage(){return this._onMessage}set onMessage(e){e?(this._onMessage=e,this.BgService._eventBus.on("bgServiceMessage",this._onMessage)):(this._onMessage=null,this.BgService._eventBus.off("bgServiceMessage"))}get isRunning(){return p.getAllAppServices().includes(this.url)}postMessage(e){this.BgService._eventBus.emit("clientMessage",e)}postEvent(e,s){if(!e)return s({error:new Error("postEvent need params")});if(!this.isRunning)return this.start(e,s);const t=p.start({url:this.url,param:`_u=${this.url}&_s=m&_a=running&`+o(e),complete_func:e=>{if(!e.result)return h({content:"start service error"}),void(s&&s({error:new Error(e.file)}));s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}start(e,s){this.isRunning?this.postEvent(e,s):l.request(_,(t=>{t.error?s&&s(t):this._start(e,s)}))}_start(e,s){const t=p.start({url:this.url,param:`_u=${this.url}&_s=m&_a=start&`+o(e??{}),complete_func:e=>{if(!e.result)return h({content:"start service error"}),void(s&&s({error:new Error(e.file)}));h({content:"start service success"}),s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}stop(e,s){if(!this.isRunning)return void s({file:this.url});const t=p.stop({url:this.url,param:`_u=${this.url}&_s=m&_a=stop&`+o(e??{}),complete_func:e=>{if(!e.result)return h({content:`stop service[${this.url}] error`}),void(s&&s({error:new Error(e.file)}));s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}toString(){return`BgService {url=${this.url} status=${this.isRunning?"running":"stop"}}`}}class v{constructor(){this._instance=new Map,this._eventBus=new g,this._onMessage=null}instance(e){if(this._instance.has(e)){const s=this._instance.get(e);return s.BgService=this,s}const s=new f(e);return s.BgService=this,this._instance.set(e,s),s}postMessage(e){this._eventBus.emit("bgServiceMessage",e)}get onMessage(){return this._onMessage}set onMessage(e){e?(this._onMessage=e,this._eventBus.on("clientMessage",e)):(this._onMessage=null,this._eventBus.off("clientMessage"))}stopAll(){this._instance.forEach((e=>{e.stop()})),this._instance.clear()}offMessage(){this.onMessage=null}disposePage(){this._instance.forEach((e=>{e.onMessage=null,e.BgService=null})),this._instance.clear()}disposeService(){this.offMessage()}disposeApp(){this.disposePage(),this.disposeService()}}function d(e){return e.$m.BgService=new v,{onDestroy(){e.$m.BgService.disposeApp()}}}const m=__API_LEVEL__;export{m as API_LEVEL,d as appPlugin};
+Buffer;let e=null;function s(){return i()&&r()}function t(){return i()&&n()}function r(){return"undefined"!=typeof hmApp}function n(){return"undefined"!=typeof __$$R$$__}function i(){return r()||n()}function o(e){if(!e||"object"!=typeof e)throw new Error("obj is required and must be an object");const s=[];for(let[t,r]of Object.entries(e))t=encodeURIComponent(t),Array.isArray(r)?r.forEach((e=>{s.push(`${t}[]=${encodeURIComponent(e)}`)})):s.push(`${t}=${encodeURIComponent(r)}`);return s.join("&")}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},s()?hmApp.getPackageInfo:t()&&e("@zos/app").getPackageInfo,s()?hmUI:t()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:t()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:t()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:t()&&e("@zos/router").push,s()?hmBle:t()&&e("@zos/ble"),e("@zos/utils").qs.parse;const{queryPermission:a,requestPermission:u}=e("@zos/app"),{showToast:c}=e("@zos/interaction");class l{static PermissionStatus={unauthorized:0,error:1,authorized:2};static RequestPermissionResult={cancel:0,error:1,granted:2};static request(e,s){const t=a({permissions:e})[0];switch(t){case l.PermissionStatus.unauthorized:u({permissions:e,callback([e]){switch(e){case l.RequestPermissionResult.granted:c({content:"permission: granted"}),s&&s({code:e});break;case l.RequestPermissionResult.cancel:c({content:"permission: canceled"}),s&&s({error:new Error(e)});break;default:c({content:"permission: request error"}),s&&s({error:new Error(e)})}}});break;case l.PermissionStatus.authorized:s&&s({code:t});break;default:c({content:"permission: query error"}),s&&s({error:new Error(t)})}}}const{showToast:h}=e("@zos/interaction"),{EventBus:g}=e("@zos/utils"),_=e("@zos/app-service"),p=["device:os.bg_service"];class f{constructor(e){this.url=e,this._onMessage=null,this.BgService=null}get onMessage(){return this._onMessage}set onMessage(e){e?(this._onMessage=e,this.BgService._eventBus.on("bgServiceMessage",this._onMessage)):(this._onMessage=null,this.BgService._eventBus.off("bgServiceMessage"))}get isRunning(){return _.getAllAppServices().includes(this.url)}postMessage(e){this.BgService._eventBus.emit("clientMessage",e)}postEvent(e,s){if(!e)return s({error:new Error("postEvent need params")});if(!this.isRunning)return this.start(e,s);const t=_.start({url:this.url,param:`_u=${this.url}&_s=m&_a=running&`+o(e),complete_func:e=>{if(!e.result)return h({content:"start service error"}),void(s&&s({error:new Error(e.file)}));s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}start(e,s){this.isRunning?this.postEvent(e,s):l.request(p,(t=>{t.error?s&&s(t):this._start(e,s)}))}_start(e,s){const t=_.start({url:this.url,param:`_u=${this.url}&_s=m&_a=start&`+o(e??{}),complete_func:e=>{if(!e.result)return h({content:"start service error"}),void(s&&s({error:new Error(e.file)}));h({content:"start service success"}),s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}stop(e,s){if(!this.isRunning)return void s({file:this.url});const t=_.stop({url:this.url,param:`_u=${this.url}&_s=m&_a=stop&`+o(e??{}),complete_func:e=>{if(!e.result)return h({content:`stop service[${this.url}] error`}),void(s&&s({error:new Error(e.file)}));s&&s(e)}});0!==t&&s&&s({error:new Error(t)})}toString(){return`BgService {url=${this.url} status=${this.isRunning?"running":"stop"}}`}}class v{constructor(){this._instance=new Map,this._eventBus=new g,this._onMessage=null}instance(e){if(this._instance.has(e)){const s=this._instance.get(e);return s.BgService=this,s}const s=new f(e);return s.BgService=this,this._instance.set(e,s),s}postMessage(e){this._eventBus.emit("bgServiceMessage",e)}get onMessage(){return this._onMessage}set onMessage(e){e?(this._onMessage=e,this._eventBus.on("clientMessage",e)):(this._onMessage=null,this._eventBus.off("clientMessage"))}stopAll(){this._instance.forEach((e=>{e.stop()})),this._instance.clear()}offMessage(){this.onMessage=null}disposePage(){this._instance.forEach((e=>{e.onMessage=null,e.BgService=null})),this._instance.clear()}disposeService(){this.offMessage()}disposeApp(){this.disposePage(),this.disposeService()}}function d(e){return e.$m.BgService=new v,{onDestroy(){e.$m.BgService.disposeApp()}}}const m=__API_LEVEL__;export{m as API_LEVEL,d as appPlugin};
diff --git a/node_modules/@zeppos/zml/dist/3.0/module/messaging/plugin/app.js b/node_modules/@zeppos/zml/dist/3.0/module/messaging/plugin/app.js
index 0a42964..3bbbfe6 100644
--- a/node_modules/@zeppos/zml/dist/3.0/module/messaging/plugin/app.js
+++ b/node_modules/@zeppos/zml/dist/3.0/module/messaging/plugin/app.js
@@ -1,8 +1 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;s()?t=hmApp.getPackageInfo:r()&&(t=e("@zos/app").getPackageInfo),s()?hmUI:r()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:r()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:r()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:r()&&e("@zos/router").push;let n=null;function s(){return a()&&i()}function r(){return a()&&o()}function i(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function a(){return i()||o()}function u(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}s()?n=hmBle:r()&&(n=e("@zos/ble"));let h=null;s()?h=DeviceRuntimeCore.HmLogger:r()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);class c{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const p=setTimeout,d=clearTimeout;var l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function f(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var y={exports:{}};
-/*!
- * @overview es6-promise - a tiny implementation of Promises/A+.
- * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
- * @license   Licensed under MIT license
- *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
- * @version   v4.2.8+1e68dce6
- */y.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){d[n]=e,d[n+1]=t,2===(n+=2)&&(r?r(f):T())},o="undefined"!=typeof window?window:void 0,a=o||{},u=a.MutationObserver||a.WebKitMutationObserver,h="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function p(){var e=setTimeout;return function(){return e(f,1)}}var d=new Array(1e3);function f(){for(var e=0;e<n;e+=2)(0,d[e])(d[e+1]),d[e]=void 0,d[e+1]=void 0;n=0}var y,g,m,I,T=void 0;function v(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&j(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return x(r,s,o,n._result)}))}else P(n,s,e,t);return s}function b(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return q(t,e),t}T=h?function(){return process.nextTick(f)}:u?(g=0,m=new u(f),I=document.createTextNode(""),m.observe(I,{characterData:!0}),function(){I.data=g=++g%2}):c?((y=new MessageChannel).port1.onmessage=f,function(){return y.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(f)}:p()}catch(e){return p()}}():p();var w=Math.random().toString(36).substring(2);function _(){}var k=void 0,L=1,B=2;function S(t,n,s){n.constructor===t.constructor&&s===v&&n.constructor.resolve===b?function(e,t){t._state===L?U(e,t._result):t._state===B?C(e,t._result):P(t,void 0,(function(t){return q(e,t)}),(function(t){return C(e,t)}))}(t,n):void 0===s?U(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?q(e,n):U(e,n))}),(function(t){s||(s=!0,C(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,C(e,r))}),e)}(t,n,s):U(t,n)}function q(e,t){if(e===t)C(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)U(e,t);else{var n=void 0;try{n=t.then}catch(t){return void C(e,t)}S(e,t,n)}var s,r}function E(e){e._onerror&&e._onerror(e._result),A(e)}function U(e,t){e._state===k&&(e._result=t,e._state=L,0!==e._subscribers.length&&i(A,e))}function C(e,t){e._state===k&&(e._state=B,e._result=t,i(E,e))}function P(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+L]=n,r[o+B]=s,0===o&&e._state&&i(A,e)}function A(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function x(t,n,s,r){var i=e(s),o=void 0,a=void 0,u=!0;if(i){try{o=s(r)}catch(e){u=!1,a=e}if(n===o)return void C(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==k||(i&&u?q(n,o):!1===u?C(n,a):t===L?U(n,o):t===B&&C(n,o))}var D=0;function j(e){e[w]=D++,e._state=void 0,e._result=void 0,e._subscribers=[]}var $=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||j(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?U(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&U(this.promise,this._result))):C(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===k&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===b){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===v&&e._state!==k)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===M){var a=new n(_);o?C(a,i):S(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===k&&(this._remaining--,e===B?C(s,n):this._result[t]=n),0===this._remaining&&U(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;P(e,void 0,(function(e){return n._settledAt(L,t,e)}),(function(e){return n._settledAt(B,t,e)}))},e}(),M=function(){function t(e){this[w]=D++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){q(e,t)}),(function(t){C(e,t)}))}catch(t){C(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return M.prototype.then=v,M.all=function(e){return new $(this,e).promise},M.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},M.resolve=b,M.reject=function(e){var t=new this(_);return C(t,e),t},M._setScheduler=function(e){r=e},M._setAsap=function(e){i=e},M._asap=i,M.polyfill=function(){var e=void 0;if(void 0!==l)e=l;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=M},M.Promise=M,M}();const g=f(y.exports);function m(){const e={canceled:!1};return e.promise=new g((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function I(e,t){const n=m(),s=p((()=>{d(s),t?t&&t(n.resolve,n.reject):n.reject("Timed out in "+e+"ms.")}),e=e||1e3);return n.promise}function T(e){return b(function(e){return JSON.stringify(e)}(e))}function v(e){return t=w(e),JSON.parse(t);var t}function b(e){return Buffer.from(e,"utf-8")}function w(e){return e.toString("utf-8")}function _(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function k(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const L=a()?h.getLogger("device-message"):h.getLogger("side-message"),B=void 0,S="json",q="text",E="bin",U=0,C=1,P=2,A=3;function x(e){switch(e.toLowerCase()){case S:return P;case q:return C;case E:return A;case"empty":return U;default:return A}}let D=1e4;function j(){return D++}let $=1e3;function M(){return $++}class R extends c{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const n=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,n]):n}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class O{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new R(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class z extends Error{constructor(e,t){super(t),this.code=e}}class H extends c{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:r=(a()?n:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:a()?n:void 0}){super(),this.isDevice=a(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=r,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new O,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=m(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=p((()=>{this.shakeStatus=4,this.shakeTask.reject(new z(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&d(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return v(e)}json2Buf(e){return T(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=g.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt8(e.flag,s),s+=1,n.writeUInt8(e.version,s),s+=1,n.writeUInt16LE(e.type,s),s+=2,n.writeUInt16LE(e.port1,s),s+=2,n.writeUInt16LE(e.port2,s),s+=2,n.writeUInt32LE(e.appId,s),s+=4,n.writeUInt32LE(e.extra,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let n=0;const s=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const i=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const a=t.readUInt16LE(n);n+=2;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);return n+=4,{flag:s,version:r,type:i,port1:o,port2:a,appId:u,extra:h,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=B){if(t&&L.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,k(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=B){t&&L.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,k(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:s,dataType:r},{messageType:i=4}={}){const o=3518,a=t.byteLength;let u=0;const h=Buffer.alloc(o),c=e||j(),p=M();let d=1;const l=Math.ceil(a/o);function f(){return d++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=a-u,o=Buffer.alloc(0+e);t.copy(o,0,u,u+e),u+=e,this.sendDataWithSession({traceId:c,spanId:p,seqId:f(),payload:o,type:n,opCode:1,totalLength:a,contentType:s,dataType:r},{messageType:i});break}t.copy(h,0,u,u+o),u+=o,this.sendDataWithSession({traceId:c,spanId:p,seqId:f(),payload:h,type:n,opCode:0,totalLength:a,contentType:s,dataType:r},{messageType:i})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=T(t),o=e||j();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||j();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=b(t),o=e||j();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:u},{messageType:h}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:u});let p=this.isDevice?this.buildData(c,{type:h}):c;this.sendMsg(p)}buildPayload(e){const t=66+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt32LE(e.traceId,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(e.spanId,s),s+=4,n.writeUInt32LE(e.seqId,s),s+=4,n.writeUInt32LE(e.totalLength,s),s+=4,n.writeUInt32LE(e.payload.byteLength,s),s+=4,n.writeUInt8(e.type,s),s+=1,n.writeUInt8(e.opCode,s),s+=1,n.writeUInt32LE(this.now(),s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt8(e.contentType,s),s+=1,n.writeUInt8(e.dataType,s),s+=1,n.writeUInt16LE(0,s),s+=2,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}readPayload(e){const t=Buffer.from(e);let n=0;const s=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const i=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt8(n);n+=1;const c=t.readUInt8(n);n+=1;const p=t.readUInt32LE(n);n+=4;const d=t.readUInt32LE(n);n+=4;const l=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const I=t.readUInt8(n);n+=1;const T=t.readUInt8(n);n+=1;const v=t.readUInt16LE(n);n+=2;const b=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:s,parentId:r,spanId:i,seqId:o,totalLength:a,payloadLength:u,payloadType:h,opCode:c,contentType:I,dataType:T,timestamp1:p,timestamp2:d,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:v,extra2:b,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(a()&&!this.ble.connectStatus())throw new z(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(a&&!this.appSidePort)throw new z(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?x(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return g.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=E;"string"==typeof e?n=q:u(e)?n=S:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=E);const s={timeout:6e4,contentType:n,dataType:n},r=j(),i=m();t=Object.assign(s,t),this.handlers.set(r,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case C:s=w(t);break;case A:s=t;break;case P:s=v(t);break;default:s=t}i.resolve(s)})),Buffer.isBuffer(e)?this.sendBuf({requestId:r,buf:e,type:1,contentType:A,dataType:x(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:A,dataType:x(t.dataType)}):x(t.contentType)===P?this.sendJson({requestId:r,json:e,type:1,contentType:P,dataType:x(t.dataType)}):x(t.contentType)===C?this.sendText({requestId:r,text:e,type:1,contentType:C,dataType:x(t.dataType)}):this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:A,dataType:x(t.dataType)});let o=!1;return g.race([I(t.timeout,((e,n)=>{if(o)return e();n(new z(4,`request timed out in ${t.timeout}ms.`))})),i.promise.finally((()=>{o=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(r)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){A===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):C===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):P===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:A})}call(e){let t=P;return"string"==typeof e?t=C:u(e)?t=P:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=A),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:A,dataType:U}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:A,dataType:U}):t===P?this.sendJson({json:e,type:3,contentType:P,dataType:U}):t===C?this.sendText({text:e,type:3,contentType:C,dataType:U}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:A,dataType:U})))}}h.getLogger("message-builder");const J="hmrpcv1";function W(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}function F(e){const n={shakeTimeout:5e3,requestTimeout:6e4,transport:s=new H({appId:t().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(s.on("call",(({contentType:t,payload:n})=>{switch(t){case P:n=v(n);break;case C:n=w(n);break;default:n=_(n)}e&&e(n)})),this):this},offOnCall(e){return s.off("call",e),this},call(e){return a()&&s.fork(this.shakeTimeout),e=u(e)?e.contentType?e:{jsonrpc:J,...e}:e,s.call(e)},onRequest(e){return e?(s.on("request",(t=>{let n=t.request.payload;switch(t.request.contentType){case P:n=v(n);break;case C:n=w(n);break;default:n=_(n)}e&&e(n,((e,s,r={})=>t.request.contentType===P&&n?.jsonrpc===J?e?t.response({data:{jsonrpc:J,error:e}}):t.response({data:{jsonrpc:J,result:s}}):t.response({data:s,...r})))})),this):this},cancelAllRequest(){return s.off("response"),this},offOnRequest(e){return s.off("request",e),this},request(e,t={}){return a()&&s.fork(this.shakeTimeout),e=u(e)?t.contentType?e:{jsonrpc:J,...e}:e,s.request(e,{timeout:this.requestTimeout,...t}).then((e=>{if(!u(e)||e.jsonrpc!==J)return e;const{error:t,result:n}=e;if(t)throw t;return n}))},connect(){return s.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this},start(){return s.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this}};var s;return{onCreate(){this.messaging=this.globalData.messaging=n,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:W}}const V="3.0";export{V as API_LEVEL,F as appPlugin};
+let e=Buffer;function t(t){return"object"==typeof t&&!e.isBuffer(t)&&!Array.isArray(t)&&null!==t}let s=null;s="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let n=null;r()?n=hmApp.getPackageInfo:a()&&(n=s("@zos/app").getPackageInfo),r()?hmUI:a()&&s("@zos/ui"),r()?hmSetting.getDeviceInfo:a()&&s("@zos/device").getDeviceInfo,r()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:a()&&s("@zos/i18n").getText,r()?hmApp.gotoPage:a()&&s("@zos/router").push;let i=null;function r(){return d()&&o()}function a(){return d()&&h()}function o(){return"undefined"!=typeof hmApp}function h(){return"undefined"!=typeof __$$R$$__}function d(){return o()||h()}r()?i=hmBle:a()&&(i=s("@zos/ble"));let p=null;r()?p=DeviceRuntimeCore.HmLogger:a()?p=s("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(p=Logger);const c=s("@zos/utils").EventBus,u=s("@zos/timer").setTimeout,l=s("@zos/timer").clearTimeout,y=globalThis.Promise;function f(){const e={canceled:!1};return e.promise=new y((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function g(e){return T(function(e){return JSON.stringify(e)}(e))}function I(e){return t=m(e),JSON.parse(t);var t}function T(t){return e.from(t,"utf-8")}function m(e){return e.toString("utf-8")}function L(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function b(t){return s=function(t){return e.from(t)}(t),s.toString("hex");var s}const k=d()?p.getLogger("device-message"):p.getLogger("side-message"),S=void 0,w="json",E="text",B="bin",U=0,q=1,C=2,v=3;function P(e){switch(e.toLowerCase()){case w:return C;case E:return q;case B:return v;case"empty":return U;default:return v}}let _=1e4;function D(){return _++}let x=1e3;function $(){return x++}class A extends c{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,k.log("Session Created.")}addChunk(t){if(1===t.opCode&&(this.count=t.seqId,this.finishChunk=t),t.payloadLength!==t.payload.byteLength)return void this.emit("error",Error(`receive chunk data length error, expect ${t.payloadLength} but ${t.payload.byteLength}`));this.tempBuf||(this.tempBuf=e.alloc(t.totalLength));const s=3518*(t.seqId-1);t.payload.copy(this.tempBuf,s),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class R{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new A(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const M={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class z extends Error{constructor(e,t){super(t),this.code=e}}class O extends c{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:n=(d()?i:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:d()?i:void 0}){super(),this.isDevice=d(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=n,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new R,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=f(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=u((()=>{this.shakeStatus=4,this.shakeTask.reject(new z(M.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&l(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return I(e)}json2Buf(e){return g(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=y.resolve(),e&&e(this)}buildBin(t){if(t.payload.byteLength>this.chunkSize)throw new Error(`${t.payload.byteLength} greater than max size of ${this.chunkSize}`);const s=this.getMessageHeaderSize()+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt8(t.flag,i),i+=1,n.writeUInt8(t.version,i),i+=1,n.writeUInt16LE(t.type,i),i+=2,n.writeUInt16LE(t.port1,i),i+=2,n.writeUInt16LE(t.port2,i),i+=2,n.writeUInt32LE(t.appId,i),i+=4,n.writeUInt32LE(t.extra,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(t){const s=e.from(t);let n=0;const i=s.readUInt8(n);n+=1;const r=s.readUInt8(n);n+=1;const a=s.readUInt16LE(n);n+=2;const o=s.readUInt16LE(n);n+=2;const h=s.readUInt16LE(n);n+=2;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt32LE(n);return n+=4,{flag:i,version:r,type:a,port1:o,port2:h,appId:d,extra:p,payload:s.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=S){if(t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,b(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=S){t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,b(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:t,dataBin:s,type:n,contentType:i,dataType:r},{messageType:a=4}={}){const o=3518,h=s.byteLength;let d=0;const p=e.alloc(o),c=t||D(),u=$();let l=1;const y=Math.ceil(h/o);function f(){return l++}for(let t=1;t<=y;t++){if(this.errorIfBleDisconnect(),t===y){const t=h-d,o=e.alloc(0+t);s.copy(o,0,d,d+t),d+=t,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:o,type:n,opCode:1,totalLength:h,contentType:i,dataType:r},{messageType:a});break}s.copy(p,0,d,d+o),d+=o,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:p,type:n,opCode:0,totalLength:h,contentType:i,dataType:r},{messageType:a})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=g(t),a=e||D();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||D();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=T(t),a=e||D();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let c=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(c)}buildPayload(t){const s=66+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt32LE(t.traceId,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(t.spanId,i),i+=4,n.writeUInt32LE(t.seqId,i),i+=4,n.writeUInt32LE(t.totalLength,i),i+=4,n.writeUInt32LE(t.payload.byteLength,i),i+=4,n.writeUInt8(t.type,i),i+=1,n.writeUInt8(t.opCode,i),i+=1,n.writeUInt32LE(this.now(),i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt8(t.contentType,i),i+=1,n.writeUInt8(t.dataType,i),i+=1,n.writeUInt16LE(0,i),i+=2,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}readPayload(t){const s=e.from(t);let n=0;const i=s.readUInt32LE(n);n+=4;const r=s.readUInt32LE(n);n+=4;const a=s.readUInt32LE(n);n+=4;const o=s.readUInt32LE(n);n+=4;const h=s.readUInt32LE(n);n+=4;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt8(n);n+=1;const c=s.readUInt8(n);n+=1;const u=s.readUInt32LE(n);n+=4;const l=s.readUInt32LE(n);n+=4;const y=s.readUInt32LE(n);n+=4;const f=s.readUInt32LE(n);n+=4;const g=s.readUInt32LE(n);n+=4;const I=s.readUInt32LE(n);n+=4;const T=s.readUInt32LE(n);n+=4;const m=s.readUInt8(n);n+=1;const L=s.readUInt8(n);n+=1;const b=s.readUInt16LE(n);n+=2;const k=s.readUInt32LE(n);n+=4;const S=s.readUInt32LE(n);return n+=4,{traceId:i,parentId:r,spanId:a,seqId:o,totalLength:h,payloadLength:d,payloadType:p,opCode:c,contentType:m,dataType:L,timestamp1:u,timestamp2:l,timestamp3:y,timestamp4:f,timestamp5:g,timestamp6:I,timestamp7:T,extra1:b,extra2:k,extra3:S,payload:s.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(d()&&!this.ble.connectStatus())throw new z(M.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(d()&&!this.appSidePort)throw new z(M.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?P(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(s,n){try{this.errorIfBleDisconnect()}catch(e){return y.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let i=B;"string"==typeof s?i=E:t(s)?i=w:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(i=B);const r={timeout:6e4,contentType:i,dataType:i},a=D(),o=f();n=Object.assign(r,n);let h=u((()=>{h=null,o.reject(new z(M.TIMEOUT,"request timeout"))}),n.timeout);return this.handlers.set(a,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case q:n=m(t);break;case v:n=t;break;case C:n=I(t);break;default:n=t}o.resolve(n)})),e.isBuffer(s)?this.sendBuf({requestId:a,buf:s,type:1,contentType:v,dataType:P(n.dataType)}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:v,dataType:P(n.dataType)}):P(n.contentType)===C?this.sendJson({requestId:a,json:s,type:1,contentType:C,dataType:P(n.dataType)}):P(n.contentType)===q?this.sendText({requestId:a,text:s,type:1,contentType:q,dataType:P(n.dataType)}):this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:v,dataType:P(n.dataType)}),o.promise.catch((e=>{throw e})).finally((()=>{h&&(l(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){v===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):q===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):C===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:v})}call(s){let n=C;return"string"==typeof s?n=q:t(s)?n=C:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(n=v),this.waitingShakePromise.then((()=>e.isBuffer(s)?this.sendBuf({buf:s,type:3,contentType:v,dataType:U}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({buf:e.from(s),type:3,contentType:v,dataType:U}):n===C?this.sendJson({json:s,type:3,contentType:C,dataType:U}):n===q?this.sendText({text:s,type:3,contentType:q,dataType:U}):this.sendBuf({buf:e.from(s),type:3,contentType:v,dataType:U})))}}p.getLogger("message-builder");const j="hmrpcv1";function H(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}function J(e){const s={shakeTimeout:5e3,requestTimeout:6e4,transport:i=new O({appId:n().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(i.on("call",(({contentType:t,payload:s})=>{switch(t){case C:s=I(s);break;case q:s=m(s);break;default:s=L(s)}e&&e(s)})),this):this},offOnCall(e){return i.off("call",e),this},call(e){return d()&&i.fork(this.shakeTimeout),e=t(e)?e.contentType?e:{jsonrpc:j,...e}:e,i.call(e)},onRequest(e){return e?(i.on("request",(t=>{let s=t.request.payload;switch(t.request.contentType){case C:s=I(s);break;case q:s=m(s);break;default:s=L(s)}e&&e(s,((e,n,i={})=>t.request.contentType===C&&s?.jsonrpc===j?e?t.response({data:{jsonrpc:j,error:e}}):t.response({data:{jsonrpc:j,result:n}}):t.response({data:n,...i})))})),this):this},cancelAllRequest(){return i.off("response"),this},offOnRequest(e){return i.off("request",e),this},request(e,s={}){return d()&&i.fork(this.shakeTimeout),e=t(e)?s.contentType?e:{jsonrpc:j,...e}:e,i.request(e,{timeout:this.requestTimeout,...s}).then((e=>{if(!t(e)||e.jsonrpc!==j)return e;const{error:s,result:n}=e;if(s)throw s;return n}))},connect(){return i.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),i.disConnect((()=>{})),this},start(){return i.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),i.disConnect((()=>{})),this}};var i;return{onCreate(){this.messaging=this.globalData.messaging=s,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:H}}const W="3.0";export{W as API_LEVEL,J as appPlugin};
diff --git a/node_modules/@zeppos/zml/dist/3.0/module/messaging/plugin/side.js b/node_modules/@zeppos/zml/dist/3.0/module/messaging/plugin/side.js
index e769247..0280869 100644
--- a/node_modules/@zeppos/zml/dist/3.0/module/messaging/plugin/side.js
+++ b/node_modules/@zeppos/zml/dist/3.0/module/messaging/plugin/side.js
@@ -1,8 +1 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},n()?hmApp.getPackageInfo:s()&&e("@zos/app").getPackageInfo,n()?hmUI:s()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:s()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:s()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:s()&&e("@zos/router").push;let t=null;function n(){return o()&&r()}function s(){return o()&&i()}function r(){return"undefined"!=typeof hmApp}function i(){return"undefined"!=typeof __$$R$$__}function o(){return r()||i()}function a(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}n()?t=hmBle:s()&&(t=e("@zos/ble"));let u=null;n()?u=DeviceRuntimeCore.HmLogger:s()?u=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(u=Logger);class h{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const c=setTimeout,d=clearTimeout;var p="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function l(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var f={exports:{}};
-/*!
- * @overview es6-promise - a tiny implementation of Promises/A+.
- * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
- * @license   Licensed under MIT license
- *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
- * @version   v4.2.8+1e68dce6
- */f.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){l[n]=e,l[n+1]=t,2===(n+=2)&&(r?r(f):T())},o="undefined"!=typeof window?window:void 0,a=o||{},u=a.MutationObserver||a.WebKitMutationObserver,h="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function d(){var e=setTimeout;return function(){return e(f,1)}}var l=new Array(1e3);function f(){for(var e=0;e<n;e+=2)(0,l[e])(l[e+1]),l[e]=void 0,l[e+1]=void 0;n=0}var y,g,m,I,T=void 0;function b(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&R(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return x(r,s,o,n._result)}))}else A(n,s,e,t);return s}function v(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return q(t,e),t}T=h?function(){return process.nextTick(f)}:u?(g=0,m=new u(f),I=document.createTextNode(""),m.observe(I,{characterData:!0}),function(){I.data=g=++g%2}):c?((y=new MessageChannel).port1.onmessage=f,function(){return y.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(f)}:d()}catch(e){return d()}}():d();var w=Math.random().toString(36).substring(2);function _(){}var k=void 0,L=1,B=2;function S(t,n,s){n.constructor===t.constructor&&s===b&&n.constructor.resolve===v?function(e,t){t._state===L?E(e,t._result):t._state===B?C(e,t._result):A(t,void 0,(function(t){return q(e,t)}),(function(t){return C(e,t)}))}(t,n):void 0===s?E(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?q(e,n):E(e,n))}),(function(t){s||(s=!0,C(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,C(e,r))}),e)}(t,n,s):E(t,n)}function q(e,t){if(e===t)C(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)E(e,t);else{var n=void 0;try{n=t.then}catch(t){return void C(e,t)}S(e,t,n)}var s,r}function U(e){e._onerror&&e._onerror(e._result),P(e)}function E(e,t){e._state===k&&(e._result=t,e._state=L,0!==e._subscribers.length&&i(P,e))}function C(e,t){e._state===k&&(e._state=B,e._result=t,i(U,e))}function A(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+L]=n,r[o+B]=s,0===o&&e._state&&i(P,e)}function P(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function x(t,n,s,r){var i=e(s),o=void 0,a=void 0,u=!0;if(i){try{o=s(r)}catch(e){u=!1,a=e}if(n===o)return void C(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==k||(i&&u?q(n,o):!1===u?C(n,a):t===L?E(n,o):t===B&&C(n,o))}var D=0;function R(e){e[w]=D++,e._state=void 0,e._result=void 0,e._subscribers=[]}var j=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||R(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?E(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&E(this.promise,this._result))):C(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===k&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===v){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===b&&e._state!==k)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===$){var a=new n(_);o?C(a,i):S(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===k&&(this._remaining--,e===B?C(s,n):this._result[t]=n),0===this._remaining&&E(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;A(e,void 0,(function(e){return n._settledAt(L,t,e)}),(function(e){return n._settledAt(B,t,e)}))},e}(),$=function(){function t(e){this[w]=D++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){q(e,t)}),(function(t){C(e,t)}))}catch(t){C(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return $.prototype.then=b,$.all=function(e){return new j(this,e).promise},$.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},$.resolve=v,$.reject=function(e){var t=new this(_);return C(t,e),t},$._setScheduler=function(e){r=e},$._setAsap=function(e){i=e},$._asap=i,$.polyfill=function(){var e=void 0;if(void 0!==p)e=p;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=$},$.Promise=$,$}();const y=l(f.exports);function g(){const e={canceled:!1};return e.promise=new y((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function m(e,t){const n=g(),s=c((()=>{d(s),t?t&&t(n.resolve,n.reject):n.reject("Timed out in "+e+"ms.")}),e=e||1e3);return n.promise}function I(e){return b(function(e){return JSON.stringify(e)}(e))}function T(e){return t=v(e),JSON.parse(t);var t}function b(e){return Buffer.from(e,"utf-8")}function v(e){return e.toString("utf-8")}function w(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function _(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const k=o()?u.getLogger("device-message"):u.getLogger("side-message"),L=void 0,B="json",S="text",q="bin";function U(e){switch(e.toLowerCase()){case B:return 2;case S:return 1;case q:return 3;case"empty":return 0;default:return 3}}let E=1e4;function C(){return E++}let A=1e3;function P(){return A++}class x extends h{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const n=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,n]):n}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class D{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new x(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class R extends Error{constructor(e,t){super(t),this.code=e}}u.getLogger("message-builder");const j="hmrpcv1",$=new class extends h{constructor({appId:e=0,appDevicePort:n=20,appSidePort:s=0,ble:r=(o()?t:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?t:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=n,this.appSidePort=s,this.ble=r,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new D,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=g(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=c((()=>{this.shakeStatus=4,this.shakeTask.reject(new R(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&d(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return T(e)}json2Buf(e){return I(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=y.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt8(e.flag,s),s+=1,n.writeUInt8(e.version,s),s+=1,n.writeUInt16LE(e.type,s),s+=2,n.writeUInt16LE(e.port1,s),s+=2,n.writeUInt16LE(e.port2,s),s+=2,n.writeUInt32LE(e.appId,s),s+=4,n.writeUInt32LE(e.extra,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let n=0;const s=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const i=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const a=t.readUInt16LE(n);n+=2;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);return n+=4,{flag:s,version:r,type:i,port1:o,port2:a,appId:u,extra:h,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=L){if(t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,_(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=L){t&&k.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,_(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:s,dataType:r},{messageType:i=4}={}){const o=3518,a=t.byteLength;let u=0;const h=Buffer.alloc(o),c=e||C(),d=P();let p=1;const l=Math.ceil(a/o);function f(){return p++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=a-u,o=Buffer.alloc(0+e);t.copy(o,0,u,u+e),u+=e,this.sendDataWithSession({traceId:c,spanId:d,seqId:f(),payload:o,type:n,opCode:1,totalLength:a,contentType:s,dataType:r},{messageType:i});break}t.copy(h,0,u,u+o),u+=o,this.sendDataWithSession({traceId:c,spanId:d,seqId:f(),payload:h,type:n,opCode:0,totalLength:a,contentType:s,dataType:r},{messageType:i})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=I(t),o=e||C();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||C();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=b(t),o=e||C();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:u},{messageType:h}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:u});let d=this.isDevice?this.buildData(c,{type:h}):c;this.sendMsg(d)}buildPayload(e){const t=66+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt32LE(e.traceId,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(e.spanId,s),s+=4,n.writeUInt32LE(e.seqId,s),s+=4,n.writeUInt32LE(e.totalLength,s),s+=4,n.writeUInt32LE(e.payload.byteLength,s),s+=4,n.writeUInt8(e.type,s),s+=1,n.writeUInt8(e.opCode,s),s+=1,n.writeUInt32LE(this.now(),s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt8(e.contentType,s),s+=1,n.writeUInt8(e.dataType,s),s+=1,n.writeUInt16LE(0,s),s+=2,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}readPayload(e){const t=Buffer.from(e);let n=0;const s=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const i=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);n+=4;const h=t.readUInt8(n);n+=1;const c=t.readUInt8(n);n+=1;const d=t.readUInt32LE(n);n+=4;const p=t.readUInt32LE(n);n+=4;const l=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const I=t.readUInt8(n);n+=1;const T=t.readUInt8(n);n+=1;const b=t.readUInt16LE(n);n+=2;const v=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:s,parentId:r,spanId:i,seqId:o,totalLength:a,payloadLength:u,payloadType:h,opCode:c,contentType:I,dataType:T,timestamp1:d,timestamp2:p,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:b,extra2:v,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new R(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new R(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?U(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return y.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=q;"string"==typeof e?n=S:a(e)?n=B:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=q);const s={timeout:6e4,contentType:n,dataType:n},r=C(),i=g();t=Object.assign(s,t),this.handlers.set(r,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case 1:s=v(t);break;case 3:default:s=t;break;case 2:s=T(t)}i.resolve(s)})),Buffer.isBuffer(e)?this.sendBuf({requestId:r,buf:e,type:1,contentType:3,dataType:U(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:3,dataType:U(t.dataType)}):2===U(t.contentType)?this.sendJson({requestId:r,json:e,type:1,contentType:2,dataType:U(t.dataType)}):1===U(t.contentType)?this.sendText({requestId:r,text:e,type:1,contentType:1,dataType:U(t.dataType)}):this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:3,dataType:U(t.dataType)});let o=!1;return y.race([m(t.timeout,((e,n)=>{if(o)return e();n(new R(4,`request timed out in ${t.timeout}ms.`))})),i.promise.finally((()=>{o=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(r)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){3===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):1===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):2===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:a(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}},M=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:n})=>{switch(e){case 2:n=T(n);break;case 1:n=v(n);break;default:n=w(n)}t&&t(n)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=a(t)?t.contentType?t:{jsonrpc:j,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let n=e.request.payload;switch(e.request.contentType){case 2:n=T(n);break;case 1:n=v(n);break;default:n=w(n)}t&&t(n,((t,s,r={})=>2===e.request.contentType&&n?.jsonrpc===j?t?e.response({data:{jsonrpc:j,error:t}}):e.response({data:{jsonrpc:j,result:s}}):e.response({data:s,...r})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,n={}){return o()&&e.fork(this.shakeTimeout),t=a(t)?n.contentType?t:{jsonrpc:j,...t}:t,e.request(t,{timeout:this.requestTimeout,...n}).then((e=>{if(!a(e)||e.jsonrpc!==j)return e;const{error:t,result:n}=e;if(t)throw t;return n}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}($);function O(){return{onInit(){this.messaging=M,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}const z="3.0";export{z as API_LEVEL,O as messagingPlugin};
+const e=Buffer;function t(t){return"object"==typeof t&&!e.isBuffer(t)&&!Array.isArray(t)&&null!==t}let s=null;s="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},i()?hmApp.getPackageInfo:r()&&s("@zos/app").getPackageInfo,i()?hmUI:r()&&s("@zos/ui"),i()?hmSetting.getDeviceInfo:r()&&s("@zos/device").getDeviceInfo,i()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:r()&&s("@zos/i18n").getText,i()?hmApp.gotoPage:r()&&s("@zos/router").push;let n=null;function i(){return h()&&a()}function r(){return h()&&o()}function a(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function h(){return a()||o()}i()?n=hmBle:r()&&(n=s("@zos/ble"));let d=null;i()?d=DeviceRuntimeCore.HmLogger:r()?d=s("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(d=Logger);class p{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const c=setTimeout,u=clearTimeout,l=Promise;function y(){const e={canceled:!1};return e.promise=new l((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function f(e){return I(function(e){return JSON.stringify(e)}(e))}function g(e){return t=T(e),JSON.parse(t);var t}function I(t){return e.from(t,"utf-8")}function T(e){return e.toString("utf-8")}function m(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function L(t){return s=function(t){return e.from(t)}(t),s.toString("hex");var s}const b=h()?d.getLogger("device-message"):d.getLogger("side-message"),k=void 0,S="json",w="text",U="bin";function E(e){switch(e.toLowerCase()){case S:return 2;case w:return 1;case U:return 3;case"empty":return 0;default:return 3}}let q=1e4;function B(){return q++}let C=1e3;function _(){return C++}class v extends p{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,b.log("Session Created.")}addChunk(t){if(1===t.opCode&&(this.count=t.seqId,this.finishChunk=t),t.payloadLength!==t.payload.byteLength)return void this.emit("error",Error(`receive chunk data length error, expect ${t.payloadLength} but ${t.payload.byteLength}`));this.tempBuf||(this.tempBuf=e.alloc(t.totalLength));const s=3518*(t.seqId-1);t.payload.copy(this.tempBuf,s),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class P{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new v(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const R={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class x extends Error{constructor(e,t){super(t),this.code=e}}d.getLogger("message-builder");const D="hmrpcv1",$=new class extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:i=(h()?n:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:h()?n:void 0}){super(),this.isDevice=h(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new P,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=y(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=c((()=>{this.shakeStatus=4,this.shakeTask.reject(new x(R.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=l.resolve(),e&&e(this)}buildBin(t){if(t.payload.byteLength>this.chunkSize)throw new Error(`${t.payload.byteLength} greater than max size of ${this.chunkSize}`);const s=this.getMessageHeaderSize()+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt8(t.flag,i),i+=1,n.writeUInt8(t.version,i),i+=1,n.writeUInt16LE(t.type,i),i+=2,n.writeUInt16LE(t.port1,i),i+=2,n.writeUInt16LE(t.port2,i),i+=2,n.writeUInt32LE(t.appId,i),i+=4,n.writeUInt32LE(t.extra,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:e.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(t){const s=e.from(t);let n=0;const i=s.readUInt8(n);n+=1;const r=s.readUInt8(n);n+=1;const a=s.readUInt16LE(n);n+=2;const o=s.readUInt16LE(n);n+=2;const h=s.readUInt16LE(n);n+=2;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt32LE(n);return n+=4,{flag:i,version:r,type:a,port1:o,port2:h,appId:d,extra:p,payload:s.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=k){if(t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=k){t&&b.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,L(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:t,dataBin:s,type:n,contentType:i,dataType:r},{messageType:a=4}={}){const o=3518,h=s.byteLength;let d=0;const p=e.alloc(o),c=t||B(),u=_();let l=1;const y=Math.ceil(h/o);function f(){return l++}for(let t=1;t<=y;t++){if(this.errorIfBleDisconnect(),t===y){const t=h-d,o=e.alloc(0+t);s.copy(o,0,d,d+t),d+=t,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:o,type:n,opCode:1,totalLength:h,contentType:i,dataType:r},{messageType:a});break}s.copy(p,0,d,d+o),d+=o,this.sendDataWithSession({traceId:c,spanId:u,seqId:f(),payload:p,type:n,opCode:0,totalLength:h,contentType:i,dataType:r},{messageType:a})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),a=e||B();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||B();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=I(t),a=e||B();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let c=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(c)}buildPayload(t){const s=66+t.payload.byteLength;let n=e.alloc(s),i=0;return n.writeUInt32LE(t.traceId,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(t.spanId,i),i+=4,n.writeUInt32LE(t.seqId,i),i+=4,n.writeUInt32LE(t.totalLength,i),i+=4,n.writeUInt32LE(t.payload.byteLength,i),i+=4,n.writeUInt8(t.type,i),i+=1,n.writeUInt8(t.opCode,i),i+=1,n.writeUInt32LE(this.now(),i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt8(t.contentType,i),i+=1,n.writeUInt8(t.dataType,i),i+=1,n.writeUInt16LE(0,i),i+=2,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.fill(t.payload,i,t.payload.byteLength+i),n}readPayload(t){const s=e.from(t);let n=0;const i=s.readUInt32LE(n);n+=4;const r=s.readUInt32LE(n);n+=4;const a=s.readUInt32LE(n);n+=4;const o=s.readUInt32LE(n);n+=4;const h=s.readUInt32LE(n);n+=4;const d=s.readUInt32LE(n);n+=4;const p=s.readUInt8(n);n+=1;const c=s.readUInt8(n);n+=1;const u=s.readUInt32LE(n);n+=4;const l=s.readUInt32LE(n);n+=4;const y=s.readUInt32LE(n);n+=4;const f=s.readUInt32LE(n);n+=4;const g=s.readUInt32LE(n);n+=4;const I=s.readUInt32LE(n);n+=4;const T=s.readUInt32LE(n);n+=4;const m=s.readUInt8(n);n+=1;const L=s.readUInt8(n);n+=1;const b=s.readUInt16LE(n);n+=2;const k=s.readUInt32LE(n);n+=4;const S=s.readUInt32LE(n);return n+=4,{traceId:i,parentId:r,spanId:a,seqId:o,totalLength:h,payloadLength:d,payloadType:p,opCode:c,contentType:m,dataType:L,timestamp1:u,timestamp2:l,timestamp3:y,timestamp4:f,timestamp5:g,timestamp6:I,timestamp7:T,extra1:b,extra2:k,extra3:S,payload:s.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(h()&&!this.ble.connectStatus())throw new x(R.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(h()&&!this.appSidePort)throw new x(R.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?E(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(s,n){try{this.errorIfBleDisconnect()}catch(e){return l.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let i=U;"string"==typeof s?i=w:t(s)?i=S:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(i=U);const r={timeout:6e4,contentType:i,dataType:i},a=B(),o=y();n=Object.assign(r,n);let h=c((()=>{h=null,o.reject(new x(R.TIMEOUT,"request timeout"))}),n.timeout);return this.handlers.set(a,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=T(t);break;case 3:default:n=t;break;case 2:n=g(t)}o.resolve(n)})),e.isBuffer(s)?this.sendBuf({requestId:a,buf:s,type:1,contentType:3,dataType:E(n.dataType)}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:3,dataType:E(n.dataType)}):2===E(n.contentType)?this.sendJson({requestId:a,json:s,type:1,contentType:2,dataType:E(n.dataType)}):1===E(n.contentType)?this.sendText({requestId:a,text:s,type:1,contentType:1,dataType:E(n.dataType)}):this.sendBuf({requestId:a,buf:e.from(s),type:1,contentType:3,dataType:E(n.dataType)}),o.promise.catch((e=>{throw e})).finally((()=>{h&&(u(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(s){let n=2;return"string"==typeof s?n=1:t(s)?n=2:(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||e.isBuffer(s))&&(n=3),this.waitingShakePromise.then((()=>e.isBuffer(s)?this.sendBuf({buf:s,type:3,contentType:3,dataType:0}):s instanceof ArrayBuffer||ArrayBuffer.isView(s)?this.sendBuf({buf:e.from(s),type:3,contentType:3,dataType:0}):2===n?this.sendJson({json:s,type:3,contentType:2,dataType:0}):1===n?this.sendText({text:s,type:3,contentType:1,dataType:0}):this.sendBuf({buf:e.from(s),type:3,contentType:3,dataType:0})))}},A=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case 2:s=g(s);break;case 1:s=T(s);break;default:s=m(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(s){return h()&&e.fork(this.shakeTimeout),s=t(s)?s.contentType?s:{jsonrpc:D,...s}:s,e.call(s)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case 2:s=g(s);break;case 1:s=T(s);break;default:s=m(s)}t&&t(s,((t,n,i={})=>2===e.request.contentType&&s?.jsonrpc===D?t?e.response({data:{jsonrpc:D,error:t}}):e.response({data:{jsonrpc:D,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(s,n={}){return h()&&e.fork(this.shakeTimeout),s=t(s)?n.contentType?s:{jsonrpc:D,...s}:s,e.request(s,{timeout:this.requestTimeout,...n}).then((e=>{if(!t(e)||e.jsonrpc!==D)return e;const{error:s,result:n}=e;if(s)throw s;return n}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}($);function M(){return{onInit(){this.messaging=A,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}const O="3.0";export{O as API_LEVEL,M as messagingPlugin};
diff --git a/node_modules/@zeppos/zml/dist/3.0/module/qs/index.js b/node_modules/@zeppos/zml/dist/3.0/module/qs/index.js
index 5da34fd..f4f7c07 100644
--- a/node_modules/@zeppos/zml/dist/3.0/module/qs/index.js
+++ b/node_modules/@zeppos/zml/dist/3.0/module/qs/index.js
@@ -1 +1 @@
-let e=null;function n(){return p()&&t()}function o(){return p()&&r()}function t(){return"undefined"!=typeof hmApp}function r(){return"undefined"!=typeof __$$R$$__}function p(){return t()||r()}function u(e){if(!e||"object"!=typeof e)throw new Error("obj is required and must be an object");const n=[];for(let[o,t]of Object.entries(e))o=encodeURIComponent(o),Array.isArray(t)?t.forEach((e=>{n.push(`${o}[]=${encodeURIComponent(e)}`)})):n.push(`${o}=${encodeURIComponent(t)}`);return n.join("&")}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},n()?hmApp.getPackageInfo:o()&&e("@zos/app").getPackageInfo,n()?hmUI:o()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:o()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:o()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:o()&&e("@zos/router").push,n()?hmBle:o()&&e("@zos/ble");const $=e("@zos/utils").qs.parse;export{$ as parse,u as stringify};
+Buffer;let e=null;function n(){return u()&&t()}function o(){return u()&&r()}function t(){return"undefined"!=typeof hmApp}function r(){return"undefined"!=typeof __$$R$$__}function u(){return t()||r()}function f(e){if(!e||"object"!=typeof e)throw new Error("obj is required and must be an object");const n=[];for(let[o,t]of Object.entries(e))o=encodeURIComponent(o),Array.isArray(t)?t.forEach((e=>{n.push(`${o}[]=${encodeURIComponent(e)}`)})):n.push(`${o}=${encodeURIComponent(t)}`);return n.join("&")}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},n()?hmApp.getPackageInfo:o()&&e("@zos/app").getPackageInfo,n()?hmUI:o()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:o()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:o()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:o()&&e("@zos/router").push,n()?hmBle:o()&&e("@zos/ble");const p=e("@zos/utils").qs.parse;export{p as parse,f as stringify};
diff --git a/node_modules/@zeppos/zml/dist/base/base-app.js b/node_modules/@zeppos/zml/dist/base/base-app.js
index 788be62..c71985c 100644
--- a/node_modules/@zeppos/zml/dist/base/base-app.js
+++ b/node_modules/@zeppos/zml/dist/base/base-app.js
@@ -1 +1 @@
-const t=Object.prototype.hasOwnProperty;function n(n,e){return Object.getOwnPropertyNames(e).forEach((function(s){if(!t.call(n,s)){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(n,s,i)}})),n}function e({globalData:t={},onCreate:n,onDestroy:s,...i}={}){const r={globalData:t,...i,onCreate(...t){for(let n=0;n<=e.mixins.length-1;n++){const s=e.mixins[n];s.handler.onCreate?.apply(this,t)}n?.apply(this,t)},onDestroy(...t){s?.apply(this,t);for(let n=e.mixins.length-1;n>=0;n--){const s=e.mixins[n];s.handler.onDestroy?.apply(this,t)}}};return e.handle(r),r}n(e,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(t,n){if(1===arguments.length)return this.settings[t];this.settings[t]=n},use(t,...n){return"function"==typeof t?this.plugins.push({handler:t,args:n}):"object"==typeof t&&this.mixins.push({handler:t,args:[]}),this},handle(t){this.plugins.forEach((n=>{if(n&&"function"==typeof n.handler){const e=n.handler.call(this,t,...n.args);"object"==typeof e&&this.mixins.push({handler:e,args:[]})}})),this.mixins.forEach((({handler:{onInit:n,onPause:e,build:s,onResume:i,onDestroy:r,onCreate:o,...a},args:h})=>{Object.assign(t,a)}))}}),e.init();export{e as BaseApp,n as merge};
+const e=Object.prototype.hasOwnProperty;function t(t,n){return Object.getOwnPropertyNames(n).forEach((function(o){if(!e.call(t,o)){var r=Object.getOwnPropertyDescriptor(n,o);Object.defineProperty(t,o,r)}})),t}const n={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const n=t.handler.call(this,e,...t.args);"object"==typeof n&&this.mixins.push({handler:n,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:n,build:o,onResume:r,onDestroy:i,onCreate:s,...g},args:h})=>{Object.assign(e,g)}))}};Buffer;let o=null;function r(){return h()&&s()}function i(){return h()&&g()}function s(){return"undefined"!=typeof hmApp}function g(){return"undefined"!=typeof __$$R$$__}function h(){return s()||g()}o="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},r()?hmApp.getPackageInfo:i()&&o("@zos/app").getPackageInfo,r()?hmUI:i()&&o("@zos/ui"),r()?hmSetting.getDeviceInfo:i()&&o("@zos/device").getDeviceInfo,r()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:i()&&o("@zos/i18n").getText,r()?hmApp.gotoPage:i()&&o("@zos/router").push,r()?hmBle:i()&&o("@zos/ble");let l=null;function a({globalData:e={},onCreate:t,onDestroy:n,...o}={}){const r={globalData:e,...o,onCreate(...e){for(let t=0;t<=a.mixins.length-1;t++){const n=a.mixins[t];n.handler.onCreate?.apply(this,e)}t?.apply(this,e)},onDestroy(...e){n?.apply(this,e);for(let t=a.mixins.length-1;t>=0;t--){const n=a.mixins[t];n.handler.onDestroy?.apply(this,e)}}};return a.handle(r),r}r()?l=DeviceRuntimeCore.HmLogger:i()?l=o("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(l=Logger),t(a,n),a.init(),a.use((function(){return{onInit(){this.logger=l.getLogger(this.name||"Page"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}},onCreate(){this.logger=l.getLogger(this.name||"app.js"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}}));export{a as BaseApp,t as merge};
diff --git a/node_modules/@zeppos/zml/dist/base/base-page.js b/node_modules/@zeppos/zml/dist/base/base-page.js
index 8a34abd..06fb19a 100644
--- a/node_modules/@zeppos/zml/dist/base/base-page.js
+++ b/node_modules/@zeppos/zml/dist/base/base-page.js
@@ -1 +1 @@
-const t=Object.prototype.hasOwnProperty;function n(n,s){return Object.getOwnPropertyNames(s).forEach((function(i){if(!t.call(n,i)){var e=Object.getOwnPropertyDescriptor(s,i);Object.defineProperty(n,i,e)}})),n}function s({state:t={},onInit:n,onResume:i,onPause:e,build:o,onDestroy:a,...r}={}){const l={state:t,...r,globalData:getApp()._options.globalData,onInit(...t){for(let n=0;n<=s.mixins.length-1;n++){const i=s.mixins[n];i.handler.onInit?.apply(this,t)}n?.apply(this,t)},onResume(...t){for(let n=0;n<=s.mixins.length-1;n++){const i=s.mixins[n];i.handler.onResume?.apply(this,t)}i?.apply(this,t)},onPause(...t){e?.apply(this,t);for(let n=s.mixins.length-1;n>=0;n--){const i=s.mixins[n];i.handler.onPause?.apply(this,t)}},build(...t){for(let n=0;n<=s.mixins.length-1;n++){const i=s.mixins[n];i.handler.build?.apply(this,t)}o?.apply(this,t)},onDestroy(...t){a?.apply(this,t);for(let n=s.mixins.length-1;n>=0;n--){const i=s.mixins[n];i.handler.onDestroy?.apply(this,t)}}};return s.handle(l),l}n(s,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(t,n){if(1===arguments.length)return this.settings[t];this.settings[t]=n},use(t,...n){return"function"==typeof t?this.plugins.push({handler:t,args:n}):"object"==typeof t&&this.mixins.push({handler:t,args:[]}),this},handle(t){this.plugins.forEach((n=>{if(n&&"function"==typeof n.handler){const s=n.handler.call(this,t,...n.args);"object"==typeof s&&this.mixins.push({handler:s,args:[]})}})),this.mixins.forEach((({handler:{onInit:n,onPause:s,build:i,onResume:e,onDestroy:o,onCreate:a,...r},args:l})=>{Object.assign(t,r)}))}}),s.init();export{s as BasePage,n as merge};
+const e=Object.prototype.hasOwnProperty;function t(t,n){return Object.getOwnPropertyNames(n).forEach((function(i){if(!e.call(t,i)){var o=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,o)}})),t}const n={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const n=t.handler.call(this,e,...t.args);"object"==typeof n&&this.mixins.push({handler:n,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:n,build:i,onResume:o,onDestroy:s,onCreate:r,...g},args:l})=>{Object.assign(e,g)}))}};Buffer;let i=null;function o(){return l()&&r()}function s(){return l()&&g()}function r(){return"undefined"!=typeof hmApp}function g(){return"undefined"!=typeof __$$R$$__}function l(){return r()||g()}i="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},o()?hmApp.getPackageInfo:s()&&i("@zos/app").getPackageInfo,o()?hmUI:s()&&i("@zos/ui"),o()?hmSetting.getDeviceInfo:s()&&i("@zos/device").getDeviceInfo,o()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:s()&&i("@zos/i18n").getText,o()?hmApp.gotoPage:s()&&i("@zos/router").push,o()?hmBle:s()&&i("@zos/ble");let h=null;function a({state:e={},onInit:t,onResume:n,onPause:i,build:o,onDestroy:s,...r}={}){const g={state:e,...r,globalData:getApp()._options.globalData,onInit(...e){for(let t=0;t<=a.mixins.length-1;t++){const n=a.mixins[t];n.handler.onInit?.apply(this,e)}t?.apply(this,e)},onResume(...e){for(let t=0;t<=a.mixins.length-1;t++){const n=a.mixins[t];n.handler.onResume?.apply(this,e)}n?.apply(this,e)},onPause(...e){i?.apply(this,e);for(let t=a.mixins.length-1;t>=0;t--){const n=a.mixins[t];n.handler.onPause?.apply(this,e)}},build(...e){for(let t=0;t<=a.mixins.length-1;t++){const n=a.mixins[t];n.handler.build?.apply(this,e)}o?.apply(this,e)},onDestroy(...e){s?.apply(this,e);for(let t=a.mixins.length-1;t>=0;t--){const n=a.mixins[t];n.handler.onDestroy?.apply(this,e)}}};return a.handle(g),g}o()?h=DeviceRuntimeCore.HmLogger:s()?h=i("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger),t(a,n),a.init(),a.use((function(){return{onInit(){this.logger=h.getLogger(this.name||"Page"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}},onCreate(){this.logger=h.getLogger(this.name||"app.js"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}}));export{a as BasePage,t as merge};
diff --git a/node_modules/@zeppos/zml/dist/base/base-side.js b/node_modules/@zeppos/zml/dist/base/base-side.js
index 6c40bc3..0b147ae 100644
--- a/node_modules/@zeppos/zml/dist/base/base-side.js
+++ b/node_modules/@zeppos/zml/dist/base/base-side.js
@@ -1 +1 @@
-const t=Object.prototype.hasOwnProperty;function n(n,s){return Object.getOwnPropertyNames(s).forEach((function(i){if(!t.call(n,i)){var e=Object.getOwnPropertyDescriptor(s,i);Object.defineProperty(n,i,e)}})),n}function s({state:t={},onInit:n,onRun:i,onDestroy:e,...o}={}){const r={state:t,...o,onInit(t){for(let n=0;n<=s.mixins.length-1;n++){const i=s.mixins[n];i.handler.onInit?.apply(this,t)}n?.apply(this,t)},onRun(t){for(let n=0;n<=s.mixins.length-1;n++){const i=s.mixins[n];i.handler.onRun?.apply(this,t)}i?.apply(this,t)},onDestroy(t){e?.apply(this,t);for(let n=s.mixins.length-1;n>=0;n--){const i=s.mixins[n];i.handler.onDestroy?.apply(this,t)}}};return s.handle(r),r}n(s,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(t,n){if(1===arguments.length)return this.settings[t];this.settings[t]=n},use(t,...n){return"function"==typeof t?this.plugins.push({handler:t,args:n}):"object"==typeof t&&this.mixins.push({handler:t,args:[]}),this},handle(t){this.plugins.forEach((n=>{if(n&&"function"==typeof n.handler){const s=n.handler.call(this,t,...n.args);"object"==typeof s&&this.mixins.push({handler:s,args:[]})}})),this.mixins.forEach((({handler:{onInit:n,onPause:s,build:i,onResume:e,onDestroy:o,onCreate:r,...h},args:a})=>{Object.assign(t,h)}))}}),s.init();export{s as BaseSideService,n as merge};
+const t=Object.prototype.hasOwnProperty;function e(e,n){return Object.getOwnPropertyNames(n).forEach((function(s){if(!t.call(e,s)){var i=Object.getOwnPropertyDescriptor(n,s);Object.defineProperty(e,s,i)}})),e}const n={onChange(t){return t?(settings.settingsStorage.addListener("change",t),this):this},offChange(){return settings.settingsStorage.removeListener("change"),this},getItem:t=>settings.settingsStorage.getItem(t),setItem:(t,e)=>settings.settingsStorage.setItem(t,e),clear:()=>settings.settingsStorage.clear(),removeItem(t){settings.settingsStorage.removeItem(t)},getAll:()=>settings.settingsStorage.toObject()};function s({state:t={},onInit:e,onRun:n,onDestroy:i,...o}={}){const r={state:t,...o,onInit(t){for(let e=0;e<=s.mixins.length-1;e++){const n=s.mixins[e];n.handler.onInit?.apply(this,t)}e?.apply(this,t)},onRun(t){for(let e=0;e<=s.mixins.length-1;e++){const n=s.mixins[e];n.handler.onRun?.apply(this,t)}n?.apply(this,t)},onDestroy(t){i?.apply(this,t);for(let e=s.mixins.length-1;e>=0;e--){const n=s.mixins[e];n.handler.onDestroy?.apply(this,t)}}};return s.handle(r),r}e(s,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(t,e){if(1===arguments.length)return this.settings[t];this.settings[t]=e},use(t,...e){return"function"==typeof t?this.plugins.push({handler:t,args:e}):"object"==typeof t&&this.mixins.push({handler:t,args:[]}),this},handle(t){this.plugins.forEach((e=>{if(e&&"function"==typeof e.handler){const n=e.handler.call(this,t,...e.args);"object"==typeof n&&this.mixins.push({handler:n,args:[]})}})),this.mixins.forEach((({handler:{onInit:e,onPause:n,build:s,onResume:i,onDestroy:o,onCreate:r,...g},args:h})=>{Object.assign(t,g)}))}}),s.init(),s.use((function(){return{onInit(){this.logger=Logger.getLogger(sideService.appInfo.app.appName),this.logger.scope=sideService.appInfo.app.appName,this.logger.name="side-service",this.log=(...t)=>{this.logger.log(...t)},this.error=(...t)=>{t[0]instanceof Error?this.logger.error(...t):this.logger.error({},...t)},this.debug=(...t)=>{this.logger.debug(...t)}}}})),s.use((function(){return{onInit(){this.settings=n,this._onSettingsChange=this.onSettingsChange?.bind(this),n.onChange(this._onSettingsChange),"undefined"!=typeof sideService&&sideService.launchReasons.settingsChanged&&this._onSettingsChange(sideService.launchArgs)},onDestroy(){this._onSettingsChange&&n.offChange(this._onSettingsChange)}}}));export{s as BaseSideService,e as merge};
diff --git a/node_modules/@zeppos/zml/dist/zml-app.debug.js b/node_modules/@zeppos/zml/dist/zml-app.debug.js
new file mode 100644
index 0000000..bd1926e
--- /dev/null
+++ b/node_modules/@zeppos/zml/dist/zml-app.debug.js
@@ -0,0 +1 @@
+let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;n()?t=hmApp.getPackageInfo:i()&&(t=e("@zos/app").getPackageInfo),n()?hmUI:i()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:i()&&e("@zos/router").push;let s=null;function n(){return o()&&r()}function i(){return o()&&a()}function r(){return"undefined"!=typeof hmApp}function a(){return"undefined"!=typeof __$$R$$__}function o(){return r()||a()}function d(e){return e?.constructor===Object}n()?s=hmBle:i()&&(s=e("@zos/ble"));let h=null;n()?h=DeviceRuntimeCore.HmLogger:i()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);const p=e("@zos/utils").EventBus,u=e("@zos/timer").setTimeout,c=e("@zos/timer").clearTimeout;function l(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function f(e,t){const s=l(),n=u((()=>{c(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function y(e){return m(function(e){return JSON.stringify(e)}(e))}function g(e){return t=I(e),JSON.parse(t);var t}function m(e){return Buffer.from(e,"utf-8")}function I(e){return e.toString("utf-8")}function T(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function b(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const S=o()?h.getLogger("device-message"):h.getLogger("side-message"),B="json",k="text",w="bin",E={EMPTY:0,TEXT:1,JSON:2,BIN:3};function v(e){switch(e.toLowerCase()){case B:return E.JSON;case k:return E.TEXT;case w:return E.BIN;case"empty":return E.EMPTY;default:return E.BIN}}let L=1e4;function q(){return L++}let P=1e3;function U(){return P++}class C extends p{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,S.log("Session Created.")}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.length)return S.error("receive chunk data length error, expect %d but %d",e.payloadLength,e.payload.length),void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.length}`));this.tempBuf||(this.tempBuf=Buffer.alloc(e.totalLength));const t=3518*(e.seqId-1);e.payload.copy(this.tempBuf,t),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){if(this.finishChunk){if(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.length,this.finishChunk.totalLength!==this.finishChunk.payloadLength)return S.error("receive full data length error, expect %d but %d",this.finishChunk.payloadLength,this.finishChunk.payload.length),void this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.length}`));this.emit("data",this.finishChunk)}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class x{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new C(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class D extends Error{constructor(e,t){super(t),this.code=e}}class O extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:i=(o()?s:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?s:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new x,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=l(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=u((()=>{this.shakeStatus=4,this.shakeTask.reject(new D(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&c(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return y(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{S.warn("[RAW] [R] receive index=>%d size=>%d bin=>%s",e,s,b(t)),this.onFragmentData(t)})),e&&e(this)}disConnect(e){S.debug("app ble disconnect"),this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{S.warn("[RAW] [R] receive size=>%d bin=>%s",e.length,b(e)),this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.length>this.chunkSize)throw new Error(`${e.payload.length} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){S.info("shake send");const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){S.info("close send");const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const d=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:a,port2:o,appId:d,extra:h,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=!0){if(t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,b(e.buffer)),!this.ble.send(e.buffer,e.length))throw Error("send message error")}sendBinBySide(e,t=!0){t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,b(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const a=3518,o=t.length;let d=0;const h=Buffer.alloc(a),p=e||q(),u=U();let c=1;const l=Math.ceil(o/a);function f(){return c++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=o-d,a=Buffer.alloc(0+e);t.copy(a,0,d,d+e),d+=e,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:i},{messageType:r});break}t.copy(h,0,d,d+a),d+=a,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:h,type:s,opCode:0,totalLength:o,contentType:n,dataType:i},{messageType:r})}d===o?S.debug("HmProtocol send ok msgSize=> %d dataSize=> %d",d,o):S.error("HmProtocol send error msgSize=> %d dataSize=> %d",d,o)}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=y(t),a=e||q();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||q();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=m(t),a=e||q();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:d},{messageType:h}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:d});let u=this.isDevice?this.buildData(p,{type:h}):p;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.length,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);s+=4;const h=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const T=t.readUInt8(s);s+=1;const b=t.readUInt16LE(s);s+=2;const S=t.readUInt32LE(s);s+=4;const B=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:a,totalLength:o,payloadLength:d,payloadType:h,opCode:p,contentType:I,dataType:T,timestamp1:u,timestamp2:c,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:b,extra2:S,extra3:B,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),S.debug("receive data=>",JSON.stringify(t)),1===t.flag&&1===t.type?(this.appSidePort=t.port2,S.debug("shake success appSidePort=>",t.port2),this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag?S.debug("receive runtime => flag %d type %d",t.flag,t.type):1===t.flag&&2===t.type?(this.appSidePort=0,S.debug("receive close =>",this.appSidePort)):S.error("error appSidePort=>%d data=>%j",this.appSidePort,t)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new D(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new D(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?v(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=w;"string"==typeof e?s=k:d(e)?s=B:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(s=w);const n={timeout:6e4,contentType:s,dataType:s},i=q(),r=l();t=Object.assign(n,t),this.handlers.set(i,(({traceId:t,payload:s,dataType:n})=>{let a;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),S.debug("traceId=>%d payload=>%s",t,s.toString("hex")),n){case E.TEXT:a=I(s);break;case E.BIN:a=s;break;case E.JSON:a=g(s);break;default:a=s}S.debug("request id=>%d payload=>%j",i,e),S.debug("response id=>%d payload=>%j",i,a),r.resolve(a)})),Buffer.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:E.BIN,dataType:v(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:E.BIN,dataType:v(t.dataType)}):v(t.contentType)===E.JSON?this.sendJson({requestId:i,json:e,type:1,contentType:E.JSON,dataType:v(t.dataType)}):v(t.contentType)===E.TEXT?this.sendText({requestId:i,text:e,type:1,contentType:E.TEXT,dataType:v(t.dataType)}):this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:E.BIN,dataType:v(t.dataType)});let a=!1;return Promise.race([f(t.timeout,((s,n)=>{if(a)return s();S.error(`request timeout in ${t.timeout}ms error=> %d data=> %j`,i,e),n(new D(4,`request timed out in ${t.timeout}ms.`))})),r.promise.finally((()=>{a=!0}))]).catch((e=>{throw S.error("error %j",e),e})).finally((()=>{this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){E.BIN===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):E.TEXT===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):E.JSON===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:E.BIN})}call(e){let t=E.JSON;return"string"==typeof e?t=E.TEXT:d(e)?t=E.JSON:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=E.BIN),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:E.BIN,dataType:E.EMPTY}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:E.BIN,dataType:E.EMPTY}):t===E.JSON?this.sendJson({json:e,type:3,contentType:E.JSON,dataType:E.EMPTY}):t===E.TEXT?this.sendText({text:e,type:3,contentType:E.TEXT,dataType:E.EMPTY}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:E.BIN,dataType:E.EMPTY})))}}const N=h.getLogger("message-builder"),j=5e3,$=6e4,R="hmrpcv1",z=20,M=0;function A(){return e=new O({appId:t().appId,appDevicePort:z,appSidePort:M}),{shakeTimeout:j,requestTimeout:$,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case E.JSON:s=g(s);break;case E.TEXT:s=I(s);break;case E.BIN:default:s=T(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=d(t)?opts.contentType?t:{jsonrpc:R,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case E.JSON:s=g(s);break;case E.TEXT:s=I(s);break;case E.BIN:default:s=T(s)}t&&t(s,((t,n,i={})=>e.request.contentType===E.JSON&&s?.jsonrpc===R?t?e.response({data:{jsonrpc:R,error:t}}):e.response({data:{jsonrpc:R,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,s={}){return o()&&e.fork(this.shakeTimeout),N.debug("current request count=>%d",e.getRequestCount()),t=d(t)?s.contentType?t:{jsonrpc:R,...t}:t,e.request(t,{timeout:this.requestTimeout,...s}).then((e=>{if(!d(e)||e.jsonrpc!==R)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{N.debug("DeviceApp messageBuilder connect with SideService")})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{N.debug("DeviceApp messageBuilder disconnect SideService")})),this},start(){return e.listen((()=>{N.debug("SideService messageBuilder start to listen to DeviceApp")})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{N.debug("SideService messageBuilder stop to listen to DeviceApp")})),this}};var e}const J=e("@zos/ble/TransferFile"),_=(F=new J,{onFile(e){return e?(void 0===F||F.inbox.on("newfile",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===F||F.inbox.on("file",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return F.inbox.emit("file"),this},offFile(){return void 0===F||(F.inbox.off("newfile"),F.inbox.off("file")),this},getFile:()=>void 0===F?null:F.inbox.getNextFile(),sendFile(e,t){if(void 0===F)throw new Error("fileTransfer is not available");return F.outbox.enqueueFile(e,t)}});var F;const X=Object.prototype.hasOwnProperty;function H(e,t){return Object.getOwnPropertyNames(t).forEach((function(s){if(!X.call(e,s)){var n=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,n)}})),e}function W({globalData:e={},onCreate:t,onDestroy:s,...n}={}){const i={globalData:e,...n,onCreate(...e){this.messaging=this.globalData.messaging=A(),this.messaging.onCall(this.onCall?.bind(this)).onRequest(this.onRequest?.bind(this)).connect(),_.onFile(this.onReceivedFile?.bind(this));for(let t=0;t<=W.mixins.length-1;t++){const s=W.mixins[t];s.handler.onCreate?.apply(this,e)}t?.apply(this,e)},onDestroy(...e){s?.apply(this,e);for(let t=W.mixins.length-1;t>=0;t--){const s=W.mixins[t];s.handler.onDestroy?.apply(this,e)}this.messaging.offOnCall().offOnRequest().disConnect(),_.offFile()}};return W.handle(i),i}H(W,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:a,...o},args:d})=>{Object.assign(e,o)}))}}),W.init(),W.use((function(e){e.httpRequest=function(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}}));export{W as BaseApp,H as merge};
diff --git a/node_modules/@zeppos/zml/dist/zml-app.js b/node_modules/@zeppos/zml/dist/zml-app.js
index 9208a07..bb22b09 100644
--- a/node_modules/@zeppos/zml/dist/zml-app.js
+++ b/node_modules/@zeppos/zml/dist/zml-app.js
@@ -1,8 +1 @@
-const e=Object.prototype.hasOwnProperty;function t({globalData:e={},onCreate:n,onDestroy:s,...r}={}){const i={globalData:e,...r,onCreate(...e){for(let n=0;n<=t.mixins.length-1;n++){const s=t.mixins[n];s.handler.onCreate?.apply(this,e)}n?.apply(this,e)},onDestroy(...e){s?.apply(this,e);for(let n=t.mixins.length-1;n>=0;n--){const s=t.mixins[n];s.handler.onDestroy?.apply(this,e)}}};return t.handle(i),i}var n,s;n=t,s={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const n=t.handler.call(this,e,...t.args);"object"==typeof n&&this.mixins.push({handler:n,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:n,build:s,onResume:r,onDestroy:i,onCreate:o,...a},args:h})=>{Object.assign(e,a)}))}},Object.getOwnPropertyNames(s).forEach((function(t){if(!e.call(n,t)){var r=Object.getOwnPropertyDescriptor(s,t);Object.defineProperty(n,t,r)}})),t.init();let r=null;r="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let i=null;a()?i=hmApp.getPackageInfo:h()&&(i=r("@zos/app").getPackageInfo),a()?hmUI:h()&&r("@zos/ui"),a()?hmSetting.getDeviceInfo:h()&&r("@zos/device").getDeviceInfo,a()?"undefined"!=typeof __$$app$$__&&__$$app$$__:h()&&r("@zos/i18n").getText,a()?hmApp.gotoPage:h()&&r("@zos/router").push;let o=null;function a(){return l()&&u()}function h(){return l()&&c()}function u(){return"undefined"!=typeof hmApp}function c(){return"undefined"!=typeof __$$R$$__}function l(){return u()||c()}function d(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}a()?o=hmBle:h()&&(o=r("@zos/ble"));let p=null;a()?p=DeviceRuntimeCore.HmLogger:h()?p=r("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(p=Logger);class f{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const y=setTimeout,g=clearTimeout;var m="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function b(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var v={exports:{}};
-/*!
- * @overview es6-promise - a tiny implementation of Promises/A+.
- * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
- * @license   Licensed under MIT license
- *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
- * @version   v4.2.8+1e68dce6
- */v.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,r=void 0,i=function(e,t){d[n]=e,d[n+1]=t,2===(n+=2)&&(r?r(p):v())},o="undefined"!=typeof window?window:void 0,a=o||{},h=a.MutationObserver||a.WebKitMutationObserver,u="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function l(){var e=setTimeout;return function(){return e(p,1)}}var d=new Array(1e3);function p(){for(var e=0;e<n;e+=2)(0,d[e])(d[e+1]),d[e]=void 0,d[e+1]=void 0;n=0}var f,y,g,b,v=void 0;function I(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&j(s);var r=n._state;if(r){var o=arguments[r-1];i((function(){return D(r,s,o,n._result)}))}else x(n,s,e,t);return s}function T(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return E(t,e),t}v=u?function(){return process.nextTick(p)}:h?(y=0,g=new h(p),b=document.createTextNode(""),g.observe(b,{characterData:!0}),function(){b.data=y=++y%2}):c?((f=new MessageChannel).port1.onmessage=p,function(){return f.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(p)}:l()}catch(e){return l()}}():l();var w=Math.random().toString(36).substring(2);function _(){}var k=void 0,L=1,S=2;function B(t,n,s){n.constructor===t.constructor&&s===I&&n.constructor.resolve===T?function(e,t){t._state===L?C(e,t._result):t._state===S?U(e,t._result):x(t,void 0,(function(t){return E(e,t)}),(function(t){return U(e,t)}))}(t,n):void 0===s?C(t,n):e(s)?function(e,t,n){i((function(e){var s=!1,r=function(n,r,i,o){try{n.call(r,(function(n){s||(s=!0,t!==n?E(e,n):C(e,n))}),(function(t){s||(s=!0,U(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&r&&(s=!0,U(e,r))}),e)}(t,n,s):C(t,n)}function E(e,t){if(e===t)U(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(s=t),null===s||"object"!==r&&"function"!==r)C(e,t);else{var n=void 0;try{n=t.then}catch(t){return void U(e,t)}B(e,t,n)}var s,r}function q(e){e._onerror&&e._onerror(e._result),P(e)}function C(e,t){e._state===k&&(e._result=t,e._state=L,0!==e._subscribers.length&&i(P,e))}function U(e,t){e._state===k&&(e._state=S,e._result=t,i(q,e))}function x(e,t,n,s){var r=e._subscribers,o=r.length;e._onerror=null,r[o]=t,r[o+L]=n,r[o+S]=s,0===o&&e._state&&i(P,e)}function P(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,r=void 0,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?D(n,s,r,i):r(i);e._subscribers.length=0}}function D(t,n,s,r){var i=e(s),o=void 0,a=void 0,h=!0;if(i){try{o=s(r)}catch(e){h=!1,a=e}if(n===o)return void U(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;n._state!==k||(i&&h?E(n,o):!1===h?U(n,a):t===L?C(n,o):t===S&&U(n,o))}var A=0;function j(e){e[w]=A++,e._state=void 0,e._result=void 0,e._subscribers=[]}var O=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||j(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?C(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&C(this.promise,this._result))):U(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===k&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===T){var r=void 0,i=void 0,o=!1;try{r=e.then}catch(e){o=!0,i=e}if(r===I&&e._state!==k)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===$){var a=new n(_);o?U(a,i):B(a,e,r),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===k&&(this._remaining--,e===S?U(s,n):this._result[t]=n),0===this._remaining&&C(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;x(e,void 0,(function(e){return n._settledAt(L,t,e)}),(function(e){return n._settledAt(S,t,e)}))},e}(),$=function(){function t(e){this[w]=A++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){E(e,t)}),(function(t){U(e,t)}))}catch(t){U(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return $.prototype.then=I,$.all=function(e){return new O(this,e).promise},$.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var r=e.length,i=0;i<r;i++)n.resolve(e[i]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},$.resolve=T,$.reject=function(e){var t=new this(_);return U(t,e),t},$._setScheduler=function(e){r=e},$._setAsap=function(e){i=e},$._asap=i,$.polyfill=function(){var e=void 0;if(void 0!==m)e=m;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=$},$.Promise=$,$}();const I=b(v.exports);function T(){const e={canceled:!1};return e.promise=new I((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function w(e,t){const n=T(),s=y((()=>{g(s),t?t&&t(n.resolve,n.reject):n.reject("Timed out in "+e+"ms.")}),e=e||1e3);return n.promise}function _(e){return L(function(e){return JSON.stringify(e)}(e))}function k(e){return t=S(e),JSON.parse(t);var t}function L(e){return Buffer.from(e,"utf-8")}function S(e){return e.toString("utf-8")}function B(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function E(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const q=l()?p.getLogger("device-message"):p.getLogger("side-message"),C=void 0,U="json",x="text",P="bin";function D(e){switch(e.toLowerCase()){case U:return 2;case x:return 1;case P:return 3;case"empty":return 0;default:return 3}}let A=1e4;function j(){return A++}let O=1e3;function $(){return O++}class M extends f{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const n=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,n]):n}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class R{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new M(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class F extends Error{constructor(e,t){super(t),this.code=e}}class z extends f{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:s=(l()?o:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:l()?o:void 0}){super(),this.isDevice=l(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=s,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new R,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=T(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=y((()=>{this.shakeStatus=4,this.shakeTask.reject(new F(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&g(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return k(e)}json2Buf(e){return _(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=I.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt8(e.flag,s),s+=1,n.writeUInt8(e.version,s),s+=1,n.writeUInt16LE(e.type,s),s+=2,n.writeUInt16LE(e.port1,s),s+=2,n.writeUInt16LE(e.port2,s),s+=2,n.writeUInt32LE(e.appId,s),s+=4,n.writeUInt32LE(e.extra,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let n=0;const s=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const i=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const a=t.readUInt16LE(n);n+=2;const h=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);return n+=4,{flag:s,version:r,type:i,port1:o,port2:a,appId:h,extra:u,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=C){if(t&&q.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,E(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=C){t&&q.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,E(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:s,dataType:r},{messageType:i=4}={}){const o=3518,a=t.byteLength;let h=0;const u=Buffer.alloc(o),c=e||j(),l=$();let d=1;const p=Math.ceil(a/o);function f(){return d++}for(let e=1;e<=p;e++){if(this.errorIfBleDisconnect(),e===p){const e=a-h,o=Buffer.alloc(0+e);t.copy(o,0,h,h+e),h+=e,this.sendDataWithSession({traceId:c,spanId:l,seqId:f(),payload:o,type:n,opCode:1,totalLength:a,contentType:s,dataType:r},{messageType:i});break}t.copy(u,0,h,h+o),h+=o,this.sendDataWithSession({traceId:c,spanId:l,seqId:f(),payload:u,type:n,opCode:0,totalLength:a,contentType:s,dataType:r},{messageType:i})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:r}){const i=_(t),o=e||j();this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:r}){const i=e||j();return this.sendHmProtocol({requestId:i,dataBin:t,type:n,contentType:s,dataType:r})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:r}){const i=L(t),o=e||j();return this.sendHmProtocol({requestId:o,dataBin:i,type:n,contentType:s,dataType:r})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:r,opCode:i,totalLength:o,contentType:a,dataType:h},{messageType:u}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:r,opCode:i,payload:s,contentType:a,dataType:h});let l=this.isDevice?this.buildData(c,{type:u}):c;this.sendMsg(l)}buildPayload(e){const t=66+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt32LE(e.traceId,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(e.spanId,s),s+=4,n.writeUInt32LE(e.seqId,s),s+=4,n.writeUInt32LE(e.totalLength,s),s+=4,n.writeUInt32LE(e.payload.byteLength,s),s+=4,n.writeUInt8(e.type,s),s+=1,n.writeUInt8(e.opCode,s),s+=1,n.writeUInt32LE(this.now(),s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt8(e.contentType,s),s+=1,n.writeUInt8(e.dataType,s),s+=1,n.writeUInt16LE(0,s),s+=2,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}readPayload(e){const t=Buffer.from(e);let n=0;const s=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const i=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);n+=4;const u=t.readUInt8(n);n+=1;const c=t.readUInt8(n);n+=1;const l=t.readUInt32LE(n);n+=4;const d=t.readUInt32LE(n);n+=4;const p=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const b=t.readUInt8(n);n+=1;const v=t.readUInt8(n);n+=1;const I=t.readUInt16LE(n);n+=2;const T=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:s,parentId:r,spanId:i,seqId:o,totalLength:a,payloadLength:h,payloadType:u,opCode:c,contentType:b,dataType:v,timestamp1:l,timestamp2:d,timestamp3:p,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:I,extra2:T,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(l()&&!this.ble.connectStatus())throw new F(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(l&&!this.appSidePort)throw new F(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?D(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return I.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=P;"string"==typeof e?n=x:d(e)?n=U:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=P);const s={timeout:6e4,contentType:n,dataType:n},r=j(),i=T();t=Object.assign(s,t),this.handlers.set(r,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case 1:s=S(t);break;case 3:default:s=t;break;case 2:s=k(t)}i.resolve(s)})),Buffer.isBuffer(e)?this.sendBuf({requestId:r,buf:e,type:1,contentType:3,dataType:D(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:3,dataType:D(t.dataType)}):2===D(t.contentType)?this.sendJson({requestId:r,json:e,type:1,contentType:2,dataType:D(t.dataType)}):1===D(t.contentType)?this.sendText({requestId:r,text:e,type:1,contentType:1,dataType:D(t.dataType)}):this.sendBuf({requestId:r,buf:Buffer.from(e),type:1,contentType:3,dataType:D(t.dataType)});let o=!1;return I.race([w(t.timeout,((e,n)=>{if(o)return e();n(new F(4,`request timed out in ${t.timeout}ms.`))})),i.promise.finally((()=>{o=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(r)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){3===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):1===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):2===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:d(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}}p.getLogger("message-builder");const H="hmrpcv1";function J(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}const N=r("@zos/ble/TransferFile"),W=function(e){if(!e)throw new Error("FileTransfer require api 3.0");return{onFile(t){return t?(void 0===e||e.inbox.on("newfile",(function(){const n=e.inbox.getNextFile();t&&t(n)})),this):this},onSideServiceFileFinished(t){return t?(void 0===e||e.inbox.on("file",(function(){const n=e.inbox.getNextFile();t&&t(n)})),this):this},emitFile(){return e.inbox.emit("file"),this},offFile(){return void 0===e||(e.inbox.off("newfile"),e.inbox.off("file")),this},getFile:()=>void 0===e?null:e.inbox.getNextFile(),sendFile(t,n){if(void 0===e)throw new Error("fileTransfer is not available");return e.outbox.enqueueFile(t,n)}}}(N?new N:void 0);t.use((function(){return{onInit(){this.logger=p.getLogger(this.name||"Page"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}},onCreate(){this.logger=p.getLogger(this.name||"app.js"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}})).use((function(e){const t={shakeTimeout:5e3,requestTimeout:6e4,transport:n=new z({appId:i().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(n.on("call",(({contentType:t,payload:n})=>{switch(t){case 2:n=k(n);break;case 1:n=S(n);break;default:n=B(n)}e&&e(n)})),this):this},offOnCall(e){return n.off("call",e),this},call(e){return l()&&n.fork(this.shakeTimeout),e=d(e)?e.contentType?e:{jsonrpc:H,...e}:e,n.call(e)},onRequest(e){return e?(n.on("request",(t=>{let n=t.request.payload;switch(t.request.contentType){case 2:n=k(n);break;case 1:n=S(n);break;default:n=B(n)}e&&e(n,((e,s,r={})=>2===t.request.contentType&&n?.jsonrpc===H?e?t.response({data:{jsonrpc:H,error:e}}):t.response({data:{jsonrpc:H,result:s}}):t.response({data:s,...r})))})),this):this},cancelAllRequest(){return n.off("response"),this},offOnRequest(e){return n.off("request",e),this},request(e,t={}){return l()&&n.fork(this.shakeTimeout),e=d(e)?t.contentType?e:{jsonrpc:H,...e}:e,n.request(e,{timeout:this.requestTimeout,...t}).then((e=>{if(!d(e)||e.jsonrpc!==H)return e;const{error:t,result:n}=e;if(t)throw t;return n}))},connect(){return n.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),n.disConnect((()=>{})),this},start(){return n.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),n.disConnect((()=>{})),this}};var n;return{onCreate(){this.messaging=this.globalData.messaging=t,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:J}})).use((function(e){return{onCreate(){W.onFile(this.onReceivedFile?.bind(this))},onDestroy(){W.offFile()},sendFile:(e,t)=>W.sendFile(e,t)}}));export{t as BaseApp};
+const e=Object.prototype.hasOwnProperty,t={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const s=t.handler.call(this,e,...t.args);"object"==typeof s&&this.mixins.push({handler:s,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:a,...o},args:h})=>{Object.assign(e,o)}))}};let s=Buffer;function n(e){return"object"==typeof e&&!s.isBuffer(e)&&!Array.isArray(e)&&null!==e}let i=null;i="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let r=null;o()?r=hmApp.getPackageInfo:h()&&(r=i("@zos/app").getPackageInfo),o()?hmUI:h()&&i("@zos/ui"),o()?hmSetting.getDeviceInfo:h()&&i("@zos/device").getDeviceInfo,o()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:h()&&i("@zos/i18n").getText,o()?hmApp.gotoPage:h()&&i("@zos/router").push;let a=null;function o(){return l()&&p()}function h(){return l()&&d()}function p(){return"undefined"!=typeof hmApp}function d(){return"undefined"!=typeof __$$R$$__}function l(){return p()||d()}o()?a=hmBle:h()&&(a=i("@zos/ble"));let c=null;function u({globalData:e={},onCreate:t,onDestroy:s,...n}={}){const i={globalData:e,...n,onCreate(...e){for(let t=0;t<=u.mixins.length-1;t++){const s=u.mixins[t];s.handler.onCreate?.apply(this,e)}t?.apply(this,e)},onDestroy(...e){s?.apply(this,e);for(let t=u.mixins.length-1;t>=0;t--){const s=u.mixins[t];s.handler.onDestroy?.apply(this,e)}}};return u.handle(i),i}var f,y;o()?c=DeviceRuntimeCore.HmLogger:h()?c=i("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(c=Logger),f=u,y=t,Object.getOwnPropertyNames(y).forEach((function(t){if(!e.call(f,t)){var s=Object.getOwnPropertyDescriptor(y,t);Object.defineProperty(f,t,s)}})),u.init(),u.use((function(){return{onInit(){this.logger=c.getLogger(this.name||"Page"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}},onCreate(){this.logger=c.getLogger(this.name||"app.js"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}}));class g{constructor(e){this.global=e}getValue(e){return this.global[e]}setValue(e,t){return this.global[e]=t}deleteKey(e){delete this.global[e]}}class I extends g{constructor(){super(__$$app$$__.__globals__.__scopedGlobals__)}}const m=i("@zos/utils").EventBus,T=i("@zos/timer").setTimeout,b=i("@zos/timer").clearTimeout,L=globalThis.Promise;function k(){const e={canceled:!1};return e.promise=new L((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function w(e){return E(function(e){return JSON.stringify(e)}(e))}function S(e){return t=U(e),JSON.parse(t);var t}function E(e){return s.from(e,"utf-8")}function U(e){return e.toString("utf-8")}function B(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function C(e){return t=function(e){return s.from(e)}(e),t.toString("hex");var t}const q=l()?c.getLogger("device-message"):c.getLogger("side-message"),_=void 0,v="json",x="text",P="bin";function D(e){switch(e.toLowerCase()){case v:return 2;case x:return 1;case P:return 3;case"empty":return 0;default:return 3}}let $=1e4;function O(){return $++}let j=1e3;function R(){return j++}class A extends m{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,q.log("Session Created.")}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.byteLength)return void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`));this.tempBuf||(this.tempBuf=s.alloc(e.totalLength));const t=3518*(e.seqId-1);e.payload.copy(this.tempBuf,t),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class F{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new A(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const M={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class z extends Error{constructor(e,t){super(t),this.code=e}}class H extends m{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:n=(l()?a:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:l()?a:void 0}){super(),this.isDevice=l(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=n,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new F,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=k(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=T((()=>{this.shakeStatus=4,this.shakeTask.reject(new z(M.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&b(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return S(e)}json2Buf(e){return w(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=L.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=s.alloc(t),i=0;return n.writeUInt8(e.flag,i),i+=1,n.writeUInt8(e.version,i),i+=1,n.writeUInt16LE(e.type,i),i+=2,n.writeUInt16LE(e.port1,i),i+=2,n.writeUInt16LE(e.port2,i),i+=2,n.writeUInt32LE(e.appId,i),i+=4,n.writeUInt32LE(e.extra,i),i+=4,n.fill(e.payload,i,e.payload.byteLength+i),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:s.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:s.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=s.from(e);let n=0;const i=t.readUInt8(n);n+=1;const r=t.readUInt8(n);n+=1;const a=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const h=t.readUInt16LE(n);n+=2;const p=t.readUInt32LE(n);n+=4;const d=t.readUInt32LE(n);return n+=4,{flag:i,version:r,type:a,port1:o,port2:h,appId:p,extra:d,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=_){if(t&&q.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,C(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=_){t&&q.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,C(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:i,dataType:r},{messageType:a=4}={}){const o=3518,h=t.byteLength;let p=0;const d=s.alloc(o),l=e||O(),c=R();let u=1;const f=Math.ceil(h/o);function y(){return u++}for(let e=1;e<=f;e++){if(this.errorIfBleDisconnect(),e===f){const e=h-p,o=s.alloc(0+e);t.copy(o,0,p,p+e),p+=e,this.sendDataWithSession({traceId:l,spanId:c,seqId:y(),payload:o,type:n,opCode:1,totalLength:h,contentType:i,dataType:r},{messageType:a});break}t.copy(d,0,p,p+o),p+=o,this.sendDataWithSession({traceId:l,spanId:c,seqId:y(),payload:d,type:n,opCode:0,totalLength:h,contentType:i,dataType:r},{messageType:a})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=w(t),a=e||O();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||O();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=E(t),a=e||O();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:p}){const d=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let l=this.isDevice?this.buildData(d,{type:p}):d;this.sendMsg(l)}buildPayload(e){const t=66+e.payload.byteLength;let n=s.alloc(t),i=0;return n.writeUInt32LE(e.traceId,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(e.spanId,i),i+=4,n.writeUInt32LE(e.seqId,i),i+=4,n.writeUInt32LE(e.totalLength,i),i+=4,n.writeUInt32LE(e.payload.byteLength,i),i+=4,n.writeUInt8(e.type,i),i+=1,n.writeUInt8(e.opCode,i),i+=1,n.writeUInt32LE(this.now(),i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.writeUInt8(e.contentType,i),i+=1,n.writeUInt8(e.dataType,i),i+=1,n.writeUInt16LE(0,i),i+=2,n.writeUInt32LE(0,i),i+=4,n.writeUInt32LE(0,i),i+=4,n.fill(e.payload,i,e.payload.byteLength+i),n}readPayload(e){const t=s.from(e);let n=0;const i=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);n+=4;const p=t.readUInt32LE(n);n+=4;const d=t.readUInt8(n);n+=1;const l=t.readUInt8(n);n+=1;const c=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const I=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const T=t.readUInt8(n);n+=1;const b=t.readUInt8(n);n+=1;const L=t.readUInt16LE(n);n+=2;const k=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:i,parentId:r,spanId:a,seqId:o,totalLength:h,payloadLength:p,payloadType:d,opCode:l,contentType:T,dataType:b,timestamp1:c,timestamp2:u,timestamp3:f,timestamp4:y,timestamp5:g,timestamp6:I,timestamp7:m,extra1:L,extra2:k,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(l()&&!this.ble.connectStatus())throw new z(M.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(l()&&!this.appSidePort)throw new z(M.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?D(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return L.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let i=P;"string"==typeof e?i=x:n(e)?i=v:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||s.isBuffer(e))&&(i=P);const r={timeout:6e4,contentType:i,dataType:i},a=O(),o=k();t=Object.assign(r,t);let h=T((()=>{h=null,o.reject(new z(M.TIMEOUT,"request timeout"))}),t.timeout);return this.handlers.set(a,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=U(t);break;case 3:default:n=t;break;case 2:n=S(t)}o.resolve(n)})),s.isBuffer(e)?this.sendBuf({requestId:a,buf:e,type:1,contentType:3,dataType:D(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:a,buf:s.from(e),type:1,contentType:3,dataType:D(t.dataType)}):2===D(t.contentType)?this.sendJson({requestId:a,json:e,type:1,contentType:2,dataType:D(t.dataType)}):1===D(t.contentType)?this.sendText({requestId:a,text:e,type:1,contentType:1,dataType:D(t.dataType)}):this.sendBuf({requestId:a,buf:s.from(e),type:1,contentType:3,dataType:D(t.dataType)}),o.promise.catch((e=>{throw e})).finally((()=>{h&&(b(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:n(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||s.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>s.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:s.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:s.from(e),type:3,contentType:3,dataType:0})))}}c.getLogger("message-builder");const J="hmrpcv1";function V(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}const N=i("@zos/ble/TransferFile"),W=(K=N?new N:void 0,{canUseFileTransfer:()=>void 0!==K,onFile(e){return e&&this.canUseFileTransfer()?(K.inbox.on("newfile",(function(){const t=K.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e&&this.canUseFileTransfer()?(K.inbox.on("file",(function(){const t=K.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return K.inbox.emit("file"),this},offFile(){return this.canUseFileTransfer()?(K.inbox.off("newfile"),K.inbox.off("file"),this):this},getFile(){return this.canUseFileTransfer()?K.inbox.getNextFile():null},sendFile(e,t){if(!this.canUseFileTransfer())throw new Error("fileTransfer is not available");return K.outbox.enqueueFile(e,t)}});var K;u.use((function(e){(new I).setValue("_$mgr$_",{}),e.$m={}})).use((function(e){const t={shakeTimeout:5e3,requestTimeout:6e4,transport:s=new H({appId:r().appId,appDevicePort:20,appSidePort:0}),onCall(e){return e?(s.on("call",(({contentType:t,payload:s})=>{switch(t){case 2:s=S(s);break;case 1:s=U(s);break;default:s=B(s)}e&&e(s)})),this):this},offOnCall(e){return s.off("call",e),this},call(e){return l()&&s.fork(this.shakeTimeout),e=n(e)?e.contentType?e:{jsonrpc:J,...e}:e,s.call(e)},onRequest(e){return e?(s.on("request",(t=>{let s=t.request.payload;switch(t.request.contentType){case 2:s=S(s);break;case 1:s=U(s);break;default:s=B(s)}e&&e(s,((e,n,i={})=>2===t.request.contentType&&s?.jsonrpc===J?e?t.response({data:{jsonrpc:J,error:e}}):t.response({data:{jsonrpc:J,result:n}}):t.response({data:n,...i})))})),this):this},cancelAllRequest(){return s.off("response"),this},offOnRequest(e){return s.off("request",e),this},request(e,t={}){return l()&&s.fork(this.shakeTimeout),e=n(e)?t.contentType?e:{jsonrpc:J,...e}:e,s.request(e,{timeout:this.requestTimeout,...t}).then((e=>{if(!n(e)||e.jsonrpc!==J)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return s.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this},start(){return s.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),s.disConnect((()=>{})),this}};var s;return{onCreate(){this.messaging=this.globalData.messaging=t,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest).connect()},onDestroy(){this.messaging.offOnCall().offOnRequest().disConnect()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:V}})).use((function(e){return{onCreate(){W.onFile(this.onReceivedFile?.bind(this))},onDestroy(){W.offFile()},sendFile:(e,t)=>W.sendFile(e,t)}}));export{u as BaseApp};
diff --git a/node_modules/@zeppos/zml/dist/zml-page.debug.js b/node_modules/@zeppos/zml/dist/zml-page.debug.js
new file mode 100644
index 0000000..a40f510
--- /dev/null
+++ b/node_modules/@zeppos/zml/dist/zml-page.debug.js
@@ -0,0 +1 @@
+let e=null;function t(){return o()&&n()}function i(){return o()&&s()}function n(){return"undefined"!=typeof hmApp}function s(){return"undefined"!=typeof __$$R$$__}function o(){return n()||s()}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},t()?hmApp.getPackageInfo:i()&&e("@zos/app").getPackageInfo,t()?hmUI:i()&&e("@zos/ui"),t()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,t()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,t()?hmApp.gotoPage:i()&&e("@zos/router").push,t()?hmBle:i()&&e("@zos/ble");let l=null;t()?l=DeviceRuntimeCore.HmLogger:i()?l=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(l=Logger),e("@zos/utils").EventBus,e("@zos/timer").setTimeout,e("@zos/timer").clearTimeout,o()?l.getLogger("device-message"):l.getLogger("side-message"),l.getLogger("message-builder");const r=e("@zos/ble/TransferFile"),a=(h=new r,{onFile(e){return e?(void 0===h||h.inbox.on("newfile",(function(){const t=h.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===h||h.inbox.on("file",(function(){const t=h.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return h.inbox.emit("file"),this},offFile(){return void 0===h||(h.inbox.off("newfile"),h.inbox.off("file")),this},getFile:()=>void 0===h?null:h.inbox.getNextFile(),sendFile(e,t){if(void 0===h)throw new Error("fileTransfer is not available");return h.outbox.enqueueFile(e,t)}});var h;const u=Object.prototype.hasOwnProperty;function g(e,t){return Object.getOwnPropertyNames(t).forEach((function(i){if(!u.call(e,i)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n)}})),e}function f({state:e={},onInit:t,onResume:i,onPause:n,build:s,onDestroy:o,...l}={}){const r=function(){const{messaging:e}=getApp()._options.globalData;return e}(),h={state:e,...l,globalData:getApp()._options.globalData,onInit(...e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging=r,this.messaging.onCall(this._onCall).onRequest(this._onRequest),this.onReceivedFile&&(this._onReceivedFile=this.onReceivedFile?.bind(this),a.onFile(this._onReceivedFile));for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.onInit?.apply(this,e)}t?.apply(this,e)},onResume(...e){for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.onResume?.apply(this,e)}i?.apply(this,e)},onPause(...e){n?.apply(this,e);for(let t=f.mixins.length-1;t>=0;t--){const i=f.mixins[t];i.handler.onPause?.apply(this,e)}},build(...e){for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.build?.apply(this,e)}s?.apply(this,e)},onDestroy(...e){o?.apply(this,e);for(let t=f.mixins.length-1;t>=0;t--){const i=f.mixins[t];i.handler.onDestroy?.apply(this,e)}this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this._onReceivedFile&&a.offFile(this._onReceivedFile)},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},sendFile:(e,t)=>a.sendFile(e,t)};return f.handle(h),h}g(f,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:i,build:n,onResume:s,onDestroy:o,onCreate:l,...r},args:a})=>{Object.assign(e,r)}))}}),f.init(),f.use((function(e){e.httpRequest=function(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}}));export{f as BasePage,g as merge};
diff --git a/node_modules/@zeppos/zml/dist/zml-page.js b/node_modules/@zeppos/zml/dist/zml-page.js
index fd773fc..c00b526 100644
--- a/node_modules/@zeppos/zml/dist/zml-page.js
+++ b/node_modules/@zeppos/zml/dist/zml-page.js
@@ -1 +1 @@
-const e=Object.prototype.hasOwnProperty;function t({state:e={},onInit:i,onResume:n,onPause:s,build:o,onDestroy:r,...l}={}){const h={state:e,...l,globalData:getApp()._options.globalData,onInit(...e){for(let i=0;i<=t.mixins.length-1;i++){const n=t.mixins[i];n.handler.onInit?.apply(this,e)}i?.apply(this,e)},onResume(...e){for(let i=0;i<=t.mixins.length-1;i++){const n=t.mixins[i];n.handler.onResume?.apply(this,e)}n?.apply(this,e)},onPause(...e){s?.apply(this,e);for(let i=t.mixins.length-1;i>=0;i--){const n=t.mixins[i];n.handler.onPause?.apply(this,e)}},build(...e){for(let i=0;i<=t.mixins.length-1;i++){const n=t.mixins[i];n.handler.build?.apply(this,e)}o?.apply(this,e)},onDestroy(...e){r?.apply(this,e);for(let i=t.mixins.length-1;i>=0;i--){const n=t.mixins[i];n.handler.onDestroy?.apply(this,e)}}};return t.handle(h),h}var i,n;i=t,n={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const i=t.handler.call(this,e,...t.args);"object"==typeof i&&this.mixins.push({handler:i,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:i,build:n,onResume:s,onDestroy:o,onCreate:r,...l},args:h})=>{Object.assign(e,l)}))}},Object.getOwnPropertyNames(n).forEach((function(t){if(!e.call(i,t)){var s=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(i,t,s)}})),t.init();let s=null;function o(){return g()&&l()}function r(){return g()&&h()}function l(){return"undefined"!=typeof hmApp}function h(){return"undefined"!=typeof __$$R$$__}function g(){return l()||h()}s="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},o()?hmApp.getPackageInfo:r()&&s("@zos/app").getPackageInfo,o()?hmUI:r()&&s("@zos/ui"),o()?hmSetting.getDeviceInfo:r()&&s("@zos/device").getDeviceInfo,o()?"undefined"!=typeof __$$app$$__&&__$$app$$__:r()&&s("@zos/i18n").getText,o()?hmApp.gotoPage:r()&&s("@zos/router").push,o()?hmBle:r()&&s("@zos/ble");let a=null;function u(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}o()?a=DeviceRuntimeCore.HmLogger:r()?a=s("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(a=Logger);const f=s("@zos/ble/TransferFile"),p=function(e){if(!e)throw new Error("FileTransfer require api 3.0");return{onFile(t){return t?(void 0===e||e.inbox.on("newfile",(function(){const i=e.inbox.getNextFile();t&&t(i)})),this):this},onSideServiceFileFinished(t){return t?(void 0===e||e.inbox.on("file",(function(){const i=e.inbox.getNextFile();t&&t(i)})),this):this},emitFile(){return e.inbox.emit("file"),this},offFile(){return void 0===e||(e.inbox.off("newfile"),e.inbox.off("file")),this},getFile:()=>void 0===e?null:e.inbox.getNextFile(),sendFile(t,i){if(void 0===e)throw new Error("fileTransfer is not available");return e.outbox.enqueueFile(t,i)}}}(f?new f:void 0);t.use((function(){return{onInit(){this.logger=a.getLogger(this.name||"Page"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}},onCreate(){this.logger=a.getLogger(this.name||"app.js"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}})).use((function(e){const t=function(){const{messaging:e}=getApp()._options.globalData;return e}();return{onInit(){this.messaging=this.state.messaging=t,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest)},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest)},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:u}})).use((function(e){return{onInit(){this._onReceivedFile=this.onReceivedFile?.bind(this),p.onFile(this._onReceivedFile)},onDestroy(){this._onReceivedFile&&p.offFile(this._onReceivedFile)},sendFile:(e,t)=>p.sendFile(e,t)}}));export{t as BasePage};
+const e=Object.prototype.hasOwnProperty,t={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const n=t.handler.call(this,e,...t.args);"object"==typeof n&&this.mixins.push({handler:n,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:n,build:i,onResume:s,onDestroy:o,onCreate:r,...l},args:a})=>{Object.assign(e,l)}))}};Buffer;let n=null;function i(){return l()&&o()}function s(){return l()&&r()}function o(){return"undefined"!=typeof hmApp}function r(){return"undefined"!=typeof __$$R$$__}function l(){return o()||r()}n="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},i()?hmApp.getPackageInfo:s()&&n("@zos/app").getPackageInfo,i()?hmUI:s()&&n("@zos/ui"),i()?hmSetting.getDeviceInfo:s()&&n("@zos/device").getDeviceInfo,i()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:s()&&n("@zos/i18n").getText,i()?hmApp.gotoPage:s()&&n("@zos/router").push,i()?hmBle:s()&&n("@zos/ble");let a=null;function h({state:e={},onInit:t,onResume:n,onPause:i,build:s,onDestroy:o,...r}={}){const l={state:e,...r,globalData:getApp()._options.globalData,onInit(...e){for(let t=0;t<=h.mixins.length-1;t++){const n=h.mixins[t];n.handler.onInit?.apply(this,e)}t?.apply(this,e)},onResume(...e){for(let t=0;t<=h.mixins.length-1;t++){const n=h.mixins[t];n.handler.onResume?.apply(this,e)}n?.apply(this,e)},onPause(...e){i?.apply(this,e);for(let t=h.mixins.length-1;t>=0;t--){const n=h.mixins[t];n.handler.onPause?.apply(this,e)}},build(...e){for(let t=0;t<=h.mixins.length-1;t++){const n=h.mixins[t];n.handler.build?.apply(this,e)}s?.apply(this,e)},onDestroy(...e){o?.apply(this,e);for(let t=h.mixins.length-1;t>=0;t--){const n=h.mixins[t];n.handler.onDestroy?.apply(this,e)}}};return h.handle(l),l}var g,u;i()?a=DeviceRuntimeCore.HmLogger:s()?a=n("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(a=Logger),g=h,u=t,Object.getOwnPropertyNames(u).forEach((function(t){if(!e.call(g,t)){var n=Object.getOwnPropertyDescriptor(u,t);Object.defineProperty(g,t,n)}})),h.init(),h.use((function(){return{onInit(){this.logger=a.getLogger(this.name||"Page"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}},onCreate(){this.logger=a.getLogger(this.name||"app.js"),this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}}));class f{constructor(e){this.global=e}getValue(e){return this.global[e]}setValue(e,t){return this.global[e]=t}deleteKey(e){delete this.global[e]}}class c extends f{constructor(){super(__$$app$$__.__globals__.__scopedGlobals__)}}function p(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}const d=n("@zos/ble/TransferFile"),_=(m=d?new d:void 0,{canUseFileTransfer:()=>void 0!==m,onFile(e){return e&&this.canUseFileTransfer()?(m.inbox.on("newfile",(function(){const t=m.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e&&this.canUseFileTransfer()?(m.inbox.on("file",(function(){const t=m.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return m.inbox.emit("file"),this},offFile(){return this.canUseFileTransfer()?(m.inbox.off("newfile"),m.inbox.off("file"),this):this},getFile(){return this.canUseFileTransfer()?m.inbox.getNextFile():null},sendFile(e,t){if(!this.canUseFileTransfer())throw new Error("fileTransfer is not available");return m.outbox.enqueueFile(e,t)}});var m;h.use((function(){(new c).getValue("_$mgr$_")[__$$module$$__.id]={}})).use((function(e){const t=function(){const{messaging:e}=getApp()._options.globalData;return e}();return{onInit(){this.messaging=this.state.messaging=t,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this._onRequest)},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest)},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},httpRequest:p}})).use((function(e){return{onInit(){this._onReceivedFile=this.onReceivedFile?.bind(this),_.onFile(this._onReceivedFile)},onDestroy(){this._onReceivedFile&&_.offFile(this._onReceivedFile)},sendFile:(e,t)=>_.sendFile(e,t)}}));export{h as BasePage};
diff --git a/node_modules/@zeppos/zml/dist/zml-side.debug.js b/node_modules/@zeppos/zml/dist/zml-side.debug.js
new file mode 100644
index 0000000..091faea
--- /dev/null
+++ b/node_modules/@zeppos/zml/dist/zml-side.debug.js
@@ -0,0 +1 @@
+let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},s()?hmApp.getPackageInfo:n()&&e("@zos/app").getPackageInfo,s()?hmUI:n()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:n()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:n()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:n()&&e("@zos/router").push;let t=null;function s(){return o()&&i()}function n(){return o()&&r()}function i(){return"undefined"!=typeof hmApp}function r(){return"undefined"!=typeof __$$R$$__}function o(){return i()||r()}function a(e){return e?.constructor===Object}s()?t=hmBle:n()&&(t=e("@zos/ble"));let h=null;s()?h=DeviceRuntimeCore.HmLogger:n()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);class d{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const p=setTimeout,u=clearTimeout;function l(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function c(e,t){const s=l(),n=p((()=>{u(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function f(e){return y(function(e){return JSON.stringify(e)}(e))}function g(e){return t=m(e),JSON.parse(t);var t}function y(e){return Buffer.from(e,"utf-8")}function m(e){return e.toString("utf-8")}function I(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function T(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const S=o()?h.getLogger("device-message"):h.getLogger("side-message"),b="json",k="text",w="bin";function v(e){switch(e.toLowerCase()){case b:return 2;case k:return 1;case w:return 3;case"empty":return 0;default:return 3}}let B=1e4;function L(){return B++}let q=1e3;function C(){return q++}class U extends d{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,S.log("Session Created.")}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.length)return S.error("receive chunk data length error, expect %d but %d",e.payloadLength,e.payload.length),void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.length}`));this.tempBuf||(this.tempBuf=Buffer.alloc(e.totalLength));const t=3518*(e.seqId-1);e.payload.copy(this.tempBuf,t),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){if(this.finishChunk){if(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.length,this.finishChunk.totalLength!==this.finishChunk.payloadLength)return S.error("receive full data length error, expect %d but %d",this.finishChunk.payloadLength,this.finishChunk.payload.length),void this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.length}`));this.emit("data",this.finishChunk)}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class x{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new U(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class E extends Error{constructor(e,t){super(t),this.code=e}}const P=h.getLogger("message-builder"),R="hmrpcv1",_=new class extends d{constructor({appId:e=0,appDevicePort:s=20,appSidePort:n=0,ble:i=(o()?t:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?t:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=s,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new x,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=l(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=p((()=>{this.shakeStatus=4,this.shakeTask.reject(new E(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{S.warn("[RAW] [R] receive index=>%d size=>%d bin=>%s",e,s,T(t)),this.onFragmentData(t)})),e&&e(this)}disConnect(e){S.debug("app ble disconnect"),this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{S.warn("[RAW] [R] receive size=>%d bin=>%s",e.length,T(e)),this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.length>this.chunkSize)throw new Error(`${e.payload.length} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){S.info("shake send");const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){S.info("close send");const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:o,port2:a,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=!0){if(t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,T(e.buffer)),!this.ble.send(e.buffer,e.length))throw Error("send message error")}sendBinBySide(e,t=!0){t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,T(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const o=3518,a=t.length;let h=0;const d=Buffer.alloc(o),p=e||L(),u=C();let l=1;const c=Math.ceil(a/o);function f(){return l++}for(let e=1;e<=c;e++){if(this.errorIfBleDisconnect(),e===c){const e=a-h,o=Buffer.alloc(0+e);t.copy(o,0,h,h+e),h+=e,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:o,type:s,opCode:1,totalLength:a,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+o),h+=o,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:d,type:s,opCode:0,totalLength:a,contentType:n,dataType:i},{messageType:r})}h===a?S.debug("HmProtocol send ok msgSize=> %d dataSize=> %d",h,a):S.error("HmProtocol send error msgSize=> %d dataSize=> %d",h,a)}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),o=e||L();this.sendHmProtocol({requestId:o,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||L();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=y(t),o=e||L();return this.sendHmProtocol({requestId:o,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:o,contentType:a,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:o,type:i,opCode:r,payload:n,contentType:a,dataType:h});let u=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.length,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const T=t.readUInt8(s);s+=1;const S=t.readUInt16LE(s);s+=2;const b=t.readUInt32LE(s);s+=4;const k=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:o,totalLength:a,payloadLength:h,payloadType:d,opCode:p,contentType:I,dataType:T,timestamp1:u,timestamp2:l,timestamp3:c,timestamp4:f,timestamp5:g,timestamp6:y,timestamp7:m,extra1:S,extra2:b,extra3:k,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),S.debug("receive data=>",JSON.stringify(t)),1===t.flag&&1===t.type?(this.appSidePort=t.port2,S.debug("shake success appSidePort=>",t.port2),this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag?S.debug("receive runtime => flag %d type %d",t.flag,t.type):1===t.flag&&2===t.type?(this.appSidePort=0,S.debug("receive close =>",this.appSidePort)):S.error("error appSidePort=>%d data=>%j",this.appSidePort,t)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new E(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new E(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?v(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=w;"string"==typeof e?s=k:a(e)?s=b:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(s=w);const n={timeout:6e4,contentType:s,dataType:s},i=L(),r=l();t=Object.assign(n,t),this.handlers.set(i,(({traceId:t,payload:s,dataType:n})=>{let o;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),S.debug("traceId=>%d payload=>%s",t,s.toString("hex")),n){case 1:o=m(s);break;case 3:default:o=s;break;case 2:o=g(s)}S.debug("request id=>%d payload=>%j",i,e),S.debug("response id=>%d payload=>%j",i,o),r.resolve(o)})),Buffer.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:3,dataType:v(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:3,dataType:v(t.dataType)}):2===v(t.contentType)?this.sendJson({requestId:i,json:e,type:1,contentType:2,dataType:v(t.dataType)}):1===v(t.contentType)?this.sendText({requestId:i,text:e,type:1,contentType:1,dataType:v(t.dataType)}):this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:3,dataType:v(t.dataType)});let o=!1;return Promise.race([c(t.timeout,((s,n)=>{if(o)return s();S.error(`request timeout in ${t.timeout}ms error=> %d data=> %j`,i,e),n(new E(4,`request timed out in ${t.timeout}ms.`))})),r.promise.finally((()=>{o=!0}))]).catch((e=>{throw S.error("error %j",e),e})).finally((()=>{this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:a(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}},D=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case 2:s=g(s);break;case 1:s=m(s);break;default:s=I(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=a(t)?opts.contentType?t:{jsonrpc:R,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case 2:s=g(s);break;case 1:s=m(s);break;default:s=I(s)}t&&t(s,((t,n,i={})=>2===e.request.contentType&&s?.jsonrpc===R?t?e.response({data:{jsonrpc:R,error:t}}):e.response({data:{jsonrpc:R,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,s={}){return o()&&e.fork(this.shakeTimeout),P.debug("current request count=>%d",e.getRequestCount()),t=a(t)?s.contentType?t:{jsonrpc:R,...t}:t,e.request(t,{timeout:this.requestTimeout,...s}).then((e=>{if(!a(e)||e.jsonrpc!==R)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{P.debug("DeviceApp messageBuilder connect with SideService")})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{P.debug("DeviceApp messageBuilder disconnect SideService")})),this},start(){return e.listen((()=>{P.debug("SideService messageBuilder start to listen to DeviceApp")})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{P.debug("SideService messageBuilder stop to listen to DeviceApp")})),this}}}(_),j={onChange(e){return e?(settings.settingsStorage.addListener("change",e),this):this},offChange(){return settings.settingsStorage.removeListener("change"),this},getItem:e=>settings.settingsStorage.getItem(e),setItem:(e,t)=>settings.settingsStorage.setItem(e,t),clear:()=>settings.settingsStorage.clear(),removeItem(e){settings.settingsStorage.removeItem(e)},getAll:()=>settings.settingsStorage.toObject()},$=(A=transferFile,{onFile(e){return e?(void 0===A||A.inbox.on("newfile",(function(){const t=A.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===A||A.inbox.on("file",(function(){const t=A.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return A.inbox.emit("file"),this},offFile(){return void 0===A||(A.inbox.off("newfile"),A.inbox.off("file")),this},getFile:()=>void 0===A?null:A.inbox.getNextFile(),sendFile(e,t){if(void 0===A)throw new Error("fileTransfer is not available");return A.outbox.enqueueFile(e,t)}});var A;const F=Object.prototype.hasOwnProperty,z={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:o,...a},args:h})=>{Object.assign(e,a)}))}},O=Logger.getLogger(sideService.appInfo.app.appName);function M({state:e={},onInit:t,onRun:s,onDestroy:n,...i}={}){const r={state:e,...i,onInit(e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging=D,this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this._onReceivedFile=this.onReceivedFile?.bind(this),$.onSideServiceFileFinished(this._onReceivedFile),this._onSettingsChange=this.onSettingsChange?.bind(this),j.onChange(this._onSettingsChange),this.messaging.start();for(let t=0;t<=M.mixins.length-1;t++){const s=M.mixins[t];s.handler.onInit?.apply(this,e)}t?.apply(this,e),"undefined"!=typeof sideService&&(O.log("sideService start launchArgs=>",sideService.launchArgs),sideService.launchReasons.settingsChanged&&this._onSettingsChange(sideService.launchArgs),sideService.launchReasons.fileTransfer&&$.emitFile())},onRun(e){for(let t=0;t<=M.mixins.length-1;t++){const s=M.mixins[t];s.handler.onRun?.apply(this,e)}s?.apply(this,e)},onDestroy(e){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop(),this._onReceivedFile&&$.offFile(this._onReceivedFile),this._onSettingsChange&&j.offChange(this._onSettingsChange),n?.apply(this,e);for(let t=M.mixins.length-1;t>=0;t--){const s=M.mixins[t];s.handler.onDestroy?.apply(this,e)}},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.url=new URL(e.url,t.baseURL).toString(),t}(e)),sendFile:(e,t)=>$.sendFile(e,t),download:(e,t={})=>((e,t)=>network.downloader.downloadFile({url:e,...t}))(e,t),__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}};return M.handle(r),r}var H,J;H=M,J=z,Object.getOwnPropertyNames(J).forEach((function(e){if(!F.call(H,e)){var t=Object.getOwnPropertyDescriptor(J,e);Object.defineProperty(H,e,t)}})),M.init();const N={convert:e=>image.convert(e)};export{M as BaseSideService,N as convertLib,j as settingsLib};
diff --git a/node_modules/@zeppos/zml/dist/zml-side.js b/node_modules/@zeppos/zml/dist/zml-side.js
index 7018892..f0bc73e 100644
--- a/node_modules/@zeppos/zml/dist/zml-side.js
+++ b/node_modules/@zeppos/zml/dist/zml-side.js
@@ -1,8 +1 @@
-const e=Object.prototype.hasOwnProperty;function t({state:e={},onInit:n,onRun:s,onDestroy:i,...r}={}){const o={state:e,...r,onInit(e){for(let n=0;n<=t.mixins.length-1;n++){const s=t.mixins[n];s.handler.onInit?.apply(this,e)}n?.apply(this,e)},onRun(e){for(let n=0;n<=t.mixins.length-1;n++){const s=t.mixins[n];s.handler.onRun?.apply(this,e)}s?.apply(this,e)},onDestroy(e){i?.apply(this,e);for(let n=t.mixins.length-1;n>=0;n--){const s=t.mixins[n];s.handler.onDestroy?.apply(this,e)}}};return t.handle(o),o}var n,s;n=t,s={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const n=t.handler.call(this,e,...t.args);"object"==typeof n&&this.mixins.push({handler:n,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:n,build:s,onResume:i,onDestroy:r,onCreate:o,...a},args:h})=>{Object.assign(e,a)}))}},Object.getOwnPropertyNames(s).forEach((function(t){if(!e.call(n,t)){var i=Object.getOwnPropertyDescriptor(s,t);Object.defineProperty(n,t,i)}})),t.init();let i=null;i="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},o()?hmApp.getPackageInfo:a()&&i("@zos/app").getPackageInfo,o()?hmUI:a()&&i("@zos/ui"),o()?hmSetting.getDeviceInfo:a()&&i("@zos/device").getDeviceInfo,o()?"undefined"!=typeof __$$app$$__&&__$$app$$__:a()&&i("@zos/i18n").getText,o()?hmApp.gotoPage:a()&&i("@zos/router").push;let r=null;function o(){return c()&&h()}function a(){return c()&&u()}function h(){return"undefined"!=typeof hmApp}function u(){return"undefined"!=typeof __$$R$$__}function c(){return h()||u()}function l(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}o()?r=hmBle:a()&&(r=i("@zos/ble"));let d=null;o()?d=DeviceRuntimeCore.HmLogger:a()?d=i("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(d=Logger);class p{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const n=this.listeners.get(e);if(!n)return;const s=n.findIndex((e=>e===t));s>=0&&n.splice(s,1)}else this.listeners.delete(e)}emit(e,...t){for(let n of this.listeners.get(e)??[])n&&n(...t)}clear(){this.listeners.clear()}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}count(e){return(this.listeners.get(e)??[]).length}}const f=setTimeout,y=clearTimeout;var g="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function m(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var v={exports:{}};
-/*!
- * @overview es6-promise - a tiny implementation of Promises/A+.
- * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
- * @license   Licensed under MIT license
- *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
- * @version   v4.2.8+1e68dce6
- */v.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=0,s=void 0,i=void 0,r=function(e,t){d[n]=e,d[n+1]=t,2===(n+=2)&&(i?i(p):I())},o="undefined"!=typeof window?window:void 0,a=o||{},h=a.MutationObserver||a.WebKitMutationObserver,u="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),c="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function l(){var e=setTimeout;return function(){return e(p,1)}}var d=new Array(1e3);function p(){for(var e=0;e<n;e+=2)(0,d[e])(d[e+1]),d[e]=void 0,d[e+1]=void 0;n=0}var f,y,m,v,I=void 0;function b(e,t){var n=this,s=new this.constructor(_);void 0===s[w]&&j(s);var i=n._state;if(i){var o=arguments[i-1];r((function(){return A(i,s,o,n._result)}))}else U(n,s,e,t);return s}function T(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(_);return C(t,e),t}I=u?function(){return process.nextTick(p)}:h?(y=0,m=new h(p),v=document.createTextNode(""),m.observe(v,{characterData:!0}),function(){v.data=y=++y%2}):c?((f=new MessageChannel).port1.onmessage=p,function(){return f.port2.postMessage(0)}):void 0===o?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(p)}:l()}catch(e){return l()}}():l();var w=Math.random().toString(36).substring(2);function _(){}var S=void 0,k=1,L=2;function B(t,n,s){n.constructor===t.constructor&&s===b&&n.constructor.resolve===T?function(e,t){t._state===k?E(e,t._result):t._state===L?x(e,t._result):U(t,void 0,(function(t){return C(e,t)}),(function(t){return x(e,t)}))}(t,n):void 0===s?E(t,n):e(s)?function(e,t,n){r((function(e){var s=!1,i=function(n,i,r,o){try{n.call(i,(function(n){s||(s=!0,t!==n?C(e,n):E(e,n))}),(function(t){s||(s=!0,x(e,t))}))}catch(e){return e}}(n,t,0,0,e._label);!s&&i&&(s=!0,x(e,i))}),e)}(t,n,s):E(t,n)}function C(e,t){if(e===t)x(e,new TypeError("You cannot resolve a promise with itself"));else if(i=typeof(s=t),null===s||"object"!==i&&"function"!==i)E(e,t);else{var n=void 0;try{n=t.then}catch(t){return void x(e,t)}B(e,t,n)}var s,i}function q(e){e._onerror&&e._onerror(e._result),P(e)}function E(e,t){e._state===S&&(e._result=t,e._state=k,0!==e._subscribers.length&&r(P,e))}function x(e,t){e._state===S&&(e._state=L,e._result=t,r(q,e))}function U(e,t,n,s){var i=e._subscribers,o=i.length;e._onerror=null,i[o]=t,i[o+k]=n,i[o+L]=s,0===o&&e._state&&r(P,e)}function P(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s=void 0,i=void 0,r=e._result,o=0;o<t.length;o+=3)s=t[o],i=t[o+n],s?A(n,s,i,r):i(r);e._subscribers.length=0}}function A(t,n,s,i){var r=e(s),o=void 0,a=void 0,h=!0;if(r){try{o=s(i)}catch(e){h=!1,a=e}if(n===o)return void x(n,new TypeError("A promises callback cannot return that same promise."))}else o=i;n._state!==S||(r&&h?C(n,o):!1===h?x(n,a):t===k?E(n,o):t===L&&x(n,o))}var R=0;function j(e){e[w]=R++,e._state=void 0,e._result=void 0,e._subscribers=[]}var D=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(_),this.promise[w]||j(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?E(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&E(this.promise,this._result))):x(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===S&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,s=n.resolve;if(s===T){var i=void 0,r=void 0,o=!1;try{i=e.then}catch(e){o=!0,r=e}if(i===b&&e._state!==S)this._settledAt(e._state,t,e._result);else if("function"!=typeof i)this._remaining--,this._result[t]=e;else if(n===F){var a=new n(_);o?x(a,r):B(a,e,i),this._willSettleAt(a,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,n){var s=this.promise;s._state===S&&(this._remaining--,e===L?x(s,n):this._result[t]=n),0===this._remaining&&E(s,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;U(e,void 0,(function(e){return n._settledAt(k,t,e)}),(function(e){return n._settledAt(L,t,e)}))},e}(),F=function(){function t(e){this[w]=R++,this._result=this._state=void 0,this._subscribers=[],_!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){C(e,t)}),(function(t){x(e,t)}))}catch(t){x(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this,s=n.constructor;return e(t)?n.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):n.then(t,t)},t}();return F.prototype.then=b,F.all=function(e){return new D(this,e).promise},F.race=function(e){var n=this;return t(e)?new n((function(t,s){for(var i=e.length,r=0;r<i;r++)n.resolve(e[r]).then(t,s)})):new n((function(e,t){return t(new TypeError("You must pass an array to race."))}))},F.resolve=T,F.reject=function(e){var t=new this(_);return x(t,e),t},F._setScheduler=function(e){i=e},F._setAsap=function(e){r=e},F._asap=r,F.polyfill=function(){var e=void 0;if(void 0!==g)e=g;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=F},F.Promise=F,F}();const I=m(v.exports);function b(){const e={canceled:!1};return e.promise=new I((function(t,n){e.resolve=t,e.reject=n})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function T(e,t){const n=b(),s=f((()=>{y(s),t?t&&t(n.resolve,n.reject):n.reject("Timed out in "+e+"ms.")}),e=e||1e3);return n.promise}function w(e){return S(function(e){return JSON.stringify(e)}(e))}function _(e){return t=k(e),JSON.parse(t);var t}function S(e){return Buffer.from(e,"utf-8")}function k(e){return e.toString("utf-8")}function L(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function B(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const C=c()?d.getLogger("device-message"):d.getLogger("side-message"),q=void 0,E="json",x="text",U="bin";function P(e){switch(e.toLowerCase()){case E:return 2;case x:return 1;case U:return 3;case"empty":return 0;default:return 3}}let A=1e4;function R(){return A++}let j=1e3;function D(){return j++}class F extends p{constructor(e,t,n){super(),this.id=e,this.type=t,this.ctx=n,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const n=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,n]):n}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class O{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,n){const s=new F(e,t,n);return this.sessions.set(this.key(s),s),s}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class $ extends Error{constructor(e,t){super(t),this.code=e}}d.getLogger("message-builder");const M="hmrpcv1",z=new class extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:s=(c()?r:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:c()?r:void 0}){super(),this.isDevice=c(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=s,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new O,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=b(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=f((()=>{this.shakeStatus=4,this.shakeTask.reject(new $(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&y(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return _(e)}json2Buf(e){return w(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,n)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=I.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt8(e.flag,s),s+=1,n.writeUInt8(e.version,s),s+=1,n.writeUInt16LE(e.type,s),s+=2,n.writeUInt16LE(e.port1,s),s+=2,n.writeUInt16LE(e.port2,s),s+=2,n.writeUInt32LE(e.appId,s),s+=4,n.writeUInt32LE(e.extra,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let n=0;const s=t.readUInt8(n);n+=1;const i=t.readUInt8(n);n+=1;const r=t.readUInt16LE(n);n+=2;const o=t.readUInt16LE(n);n+=2;const a=t.readUInt16LE(n);n+=2;const h=t.readUInt32LE(n);n+=4;const u=t.readUInt32LE(n);return n+=4,{flag:s,version:i,type:r,port1:o,port2:a,appId:h,extra:u,payload:t.subarray(n)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=q){if(t&&C.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,B(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=q){t&&C.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,B(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:n,contentType:s,dataType:i},{messageType:r=4}={}){const o=3518,a=t.byteLength;let h=0;const u=Buffer.alloc(o),c=e||R(),l=D();let d=1;const p=Math.ceil(a/o);function f(){return d++}for(let e=1;e<=p;e++){if(this.errorIfBleDisconnect(),e===p){const e=a-h,o=Buffer.alloc(0+e);t.copy(o,0,h,h+e),h+=e,this.sendDataWithSession({traceId:c,spanId:l,seqId:f(),payload:o,type:n,opCode:1,totalLength:a,contentType:s,dataType:i},{messageType:r});break}t.copy(u,0,h,h+o),h+=o,this.sendDataWithSession({traceId:c,spanId:l,seqId:f(),payload:u,type:n,opCode:0,totalLength:a,contentType:s,dataType:i},{messageType:r})}}sendJson({requestId:e=0,json:t,type:n=1,contentType:s,dataType:i}){const r=w(t),o=e||R();this.sendHmProtocol({requestId:o,dataBin:r,type:n,contentType:s,dataType:i})}sendBuf({requestId:e=0,buf:t,type:n=1,contentType:s,dataType:i}){const r=e||R();return this.sendHmProtocol({requestId:r,dataBin:t,type:n,contentType:s,dataType:i})}sendText({requestId:e=0,text:t,type:n=1,contentType:s,dataType:i}){const r=S(t),o=e||R();return this.sendHmProtocol({requestId:o,dataBin:r,type:n,contentType:s,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:n,payload:s,type:i,opCode:r,totalLength:o,contentType:a,dataType:h},{messageType:u}){const c=this.buildPayload({traceId:e,spanId:t,seqId:n,totalLength:o,type:i,opCode:r,payload:s,contentType:a,dataType:h});let l=this.isDevice?this.buildData(c,{type:u}):c;this.sendMsg(l)}buildPayload(e){const t=66+e.payload.byteLength;let n=Buffer.alloc(t),s=0;return n.writeUInt32LE(e.traceId,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(e.spanId,s),s+=4,n.writeUInt32LE(e.seqId,s),s+=4,n.writeUInt32LE(e.totalLength,s),s+=4,n.writeUInt32LE(e.payload.byteLength,s),s+=4,n.writeUInt8(e.type,s),s+=1,n.writeUInt8(e.opCode,s),s+=1,n.writeUInt32LE(this.now(),s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.writeUInt8(e.contentType,s),s+=1,n.writeUInt8(e.dataType,s),s+=1,n.writeUInt16LE(0,s),s+=2,n.writeUInt32LE(0,s),s+=4,n.writeUInt32LE(0,s),s+=4,n.fill(e.payload,s,e.payload.byteLength+s),n}readPayload(e){const t=Buffer.from(e);let n=0;const s=t.readUInt32LE(n);n+=4;const i=t.readUInt32LE(n);n+=4;const r=t.readUInt32LE(n);n+=4;const o=t.readUInt32LE(n);n+=4;const a=t.readUInt32LE(n);n+=4;const h=t.readUInt32LE(n);n+=4;const u=t.readUInt8(n);n+=1;const c=t.readUInt8(n);n+=1;const l=t.readUInt32LE(n);n+=4;const d=t.readUInt32LE(n);n+=4;const p=t.readUInt32LE(n);n+=4;const f=t.readUInt32LE(n);n+=4;const y=t.readUInt32LE(n);n+=4;const g=t.readUInt32LE(n);n+=4;const m=t.readUInt32LE(n);n+=4;const v=t.readUInt8(n);n+=1;const I=t.readUInt8(n);n+=1;const b=t.readUInt16LE(n);n+=2;const T=t.readUInt32LE(n);n+=4;const w=t.readUInt32LE(n);return n+=4,{traceId:s,parentId:i,spanId:r,seqId:o,totalLength:a,payloadLength:h,payloadType:u,opCode:c,contentType:v,dataType:I,timestamp1:l,timestamp2:d,timestamp3:p,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:b,extra2:T,extra3:w,payload:t.subarray(n)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(c()&&!this.ble.connectStatus())throw new $(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(c&&!this.appSidePort)throw new $(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let n=this.sessionMgr.getById(t.traceId,t.payloadType);n||(n=this.sessionMgr.newSession(t.traceId,t.payloadType,this),n.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:n})=>{n=void 0!==n?P(n):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:n,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(n))})),n.on("error",(e=>{this.sessionMgr.destroy(n),this.emit("error",e)}))),n.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return I.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=U;"string"==typeof e?n=x:l(e)?n=E:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=U);const s={timeout:6e4,contentType:n,dataType:n},i=R(),r=b();t=Object.assign(s,t),this.handlers.set(i,(({traceId:e,payload:t,dataType:n})=>{let s;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),n){case 1:s=k(t);break;case 3:default:s=t;break;case 2:s=_(t)}r.resolve(s)})),Buffer.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:3,dataType:P(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:3,dataType:P(t.dataType)}):2===P(t.contentType)?this.sendJson({requestId:i,json:e,type:1,contentType:2,dataType:P(t.dataType)}):1===P(t.contentType)?this.sendText({requestId:i,text:e,type:1,contentType:1,dataType:P(t.dataType)}):this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:3,dataType:P(t.dataType)});let o=!1;return I.race([T(t.timeout,((e,n)=>{if(o)return e();n(new $(4,`request timed out in ${t.timeout}ms.`))})),r.promise.finally((()=>{o=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:n,data:s}){3===n?this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:n}):1===n?this.sendText({requestId:e,text:s,type:2,contentType:t,dataType:n}):2===n?this.sendJson({requestId:e,json:s,type:2,contentType:t,dataType:n}):this.sendBuf({requestId:e,buf:s,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:l(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}},H=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:n})=>{switch(e){case 2:n=_(n);break;case 1:n=k(n);break;default:n=L(n)}t&&t(n)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return c()&&e.fork(this.shakeTimeout),t=l(t)?t.contentType?t:{jsonrpc:M,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let n=e.request.payload;switch(e.request.contentType){case 2:n=_(n);break;case 1:n=k(n);break;default:n=L(n)}t&&t(n,((t,s,i={})=>2===e.request.contentType&&n?.jsonrpc===M?t?e.response({data:{jsonrpc:M,error:t}}):e.response({data:{jsonrpc:M,result:s}}):e.response({data:s,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,n={}){return c()&&e.fork(this.shakeTimeout),t=l(t)?n.contentType?t:{jsonrpc:M,...t}:t,e.request(t,{timeout:this.requestTimeout,...n}).then((e=>{if(!l(e)||e.jsonrpc!==M)return e;const{error:t,result:n}=e;if(t)throw t;return n}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}(z),N=function(e){if(!e)throw new Error("FileTransfer require api 3.0");return{onFile(t){return t?(void 0===e||e.inbox.on("newfile",(function(){const n=e.inbox.getNextFile();t&&t(n)})),this):this},onSideServiceFileFinished(t){return t?(void 0===e||e.inbox.on("file",(function(){const n=e.inbox.getNextFile();t&&t(n)})),this):this},emitFile(){return e.inbox.emit("file"),this},offFile(){return void 0===e||(e.inbox.off("newfile"),e.inbox.off("file")),this},getFile:()=>void 0===e?null:e.inbox.getNextFile(),sendFile(t,n){if(void 0===e)throw new Error("fileTransfer is not available");return e.outbox.enqueueFile(t,n)}}}(transferFile),J={convert:e=>image.convert(e)},W={onChange(e){return e?(settings.settingsStorage.addListener("change",e),this):this},offChange(){return settings.settingsStorage.removeListener("change"),this},getItem:e=>settings.settingsStorage.getItem(e),setItem:(e,t)=>settings.settingsStorage.setItem(e,t),clear:()=>settings.settingsStorage.clear(),removeItem(e){settings.settingsStorage.removeItem(e)},getAll:()=>settings.settingsStorage.toObject()};t.use((function(){return{onInit(){this.logger=Logger.getLogger(sideService.appInfo.app.appName),this.logger.scope=sideService.appInfo.app.appName,this.logger.name="side-service",this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}})).use((function(){return{onInit(){this.settings=W,this._onSettingsChange=this.onSettingsChange?.bind(this),W.onChange(this._onSettingsChange),"undefined"!=typeof sideService&&sideService.launchReasons.settingsChanged&&this._onSettingsChange(sideService.launchArgs)},onDestroy(){this._onSettingsChange&&W.offChange(this._onSettingsChange)}}})).use((function(){return{onInit(){this.messaging=H,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}})).use((function(){return{onInit(){this._onReceivedFile=this.onReceivedFile?.bind(this),N.onSideServiceFileFinished(this._onReceivedFile),"undefined"!=typeof sideService&&sideService.launchReasons.fileTransfer&&N.emitFile()},onDestroy(){this._onReceivedFile&&N.offFile(this._onReceivedFile)},sendFile:(e,t)=>N.sendFile(e,t)}})).use((function(e){e.download=function(e,t){return network.downloader.downloadFile({url:e,...t})}})).use((function(e){e.convert=function(e){return J.convert(e)}}));export{t as BaseSideService,J as convertLib,W as settingsLib};
+const e=Object.prototype.hasOwnProperty,t={onChange(e){return e?(settings.settingsStorage.addListener("change",e),this):this},offChange(){return settings.settingsStorage.removeListener("change"),this},getItem:e=>settings.settingsStorage.getItem(e),setItem:(e,t)=>settings.settingsStorage.setItem(e,t),clear:()=>settings.settingsStorage.clear(),removeItem(e){settings.settingsStorage.removeItem(e)},getAll:()=>settings.settingsStorage.toObject()};function s({state:e={},onInit:t,onRun:n,onDestroy:i,...r}={}){const o={state:e,...r,onInit(e){for(let t=0;t<=s.mixins.length-1;t++){const n=s.mixins[t];n.handler.onInit?.apply(this,e)}t?.apply(this,e)},onRun(e){for(let t=0;t<=s.mixins.length-1;t++){const n=s.mixins[t];n.handler.onRun?.apply(this,e)}n?.apply(this,e)},onDestroy(e){i?.apply(this,e);for(let t=s.mixins.length-1;t>=0;t--){const n=s.mixins[t];n.handler.onDestroy?.apply(this,e)}}};return s.handle(o),o}var n,i;n=s,i={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{if(t&&"function"==typeof t.handler){const s=t.handler.call(this,e,...t.args);"object"==typeof s&&this.mixins.push({handler:s,args:[]})}})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:o,...a},args:h})=>{Object.assign(e,a)}))}},Object.getOwnPropertyNames(i).forEach((function(t){if(!e.call(n,t)){var s=Object.getOwnPropertyDescriptor(i,t);Object.defineProperty(n,t,s)}})),s.init(),s.use((function(){return{onInit(){this.logger=Logger.getLogger(sideService.appInfo.app.appName),this.logger.scope=sideService.appInfo.app.appName,this.logger.name="side-service",this.log=(...e)=>{this.logger.log(...e)},this.error=(...e)=>{e[0]instanceof Error?this.logger.error(...e):this.logger.error({},...e)},this.debug=(...e)=>{this.logger.debug(...e)}}}})),s.use((function(){return{onInit(){this.settings=t,this._onSettingsChange=this.onSettingsChange?.bind(this),t.onChange(this._onSettingsChange),"undefined"!=typeof sideService&&sideService.launchReasons.settingsChanged&&this._onSettingsChange(sideService.launchArgs)},onDestroy(){this._onSettingsChange&&t.offChange(this._onSettingsChange)}}}));const r=Buffer;function o(e){return"object"==typeof e&&!r.isBuffer(e)&&!Array.isArray(e)&&null!==e}let a=null;a="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},d()?hmApp.getPackageInfo:p()&&a("@zos/app").getPackageInfo,d()?hmUI:p()&&a("@zos/ui"),d()?hmSetting.getDeviceInfo:p()&&a("@zos/device").getDeviceInfo,d()?"undefined"!=typeof __$$app$$__&&__$$app$$__?.__globals__?.gettext:p()&&a("@zos/i18n").getText,d()?hmApp.gotoPage:p()&&a("@zos/router").push;let h=null;function d(){return u()&&c()}function p(){return u()&&l()}function c(){return"undefined"!=typeof hmApp}function l(){return"undefined"!=typeof __$$R$$__}function u(){return c()||l()}d()?h=hmBle:p()&&(h=a("@zos/ble"));let f=null;d()?f=DeviceRuntimeCore.HmLogger:p()?f=a("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(f=Logger);class g{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const y=setTimeout,m=clearTimeout,I=Promise;function T(){const e={canceled:!1};return e.promise=new I((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function b(e){return L(function(e){return JSON.stringify(e)}(e))}function S(e){return t=k(e),JSON.parse(t);var t}function L(e){return r.from(e,"utf-8")}function k(e){return e.toString("utf-8")}function w(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function U(e){return t=function(e){return r.from(e)}(e),t.toString("hex");var t}const E=u()?f.getLogger("device-message"):f.getLogger("side-message"),v=void 0,C="json",q="text",B="bin";function _(e){switch(e.toLowerCase()){case C:return 2;case q:return 1;case B:return 3;case"empty":return 0;default:return 3}}let x=1e4;function P(){return x++}let R=1e3;function D(){return R++}class F extends g{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,E.log("Session Created.")}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.byteLength)return void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`));this.tempBuf||(this.tempBuf=r.alloc(e.totalLength));const t=3518*(e.seqId-1);e.payload.copy(this.tempBuf,t),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class O{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new F(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const $={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class j extends Error{constructor(e,t){super(t),this.code=e}}f.getLogger("message-builder");const A="hmrpcv1",M=new class extends g{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:n=(u()?h:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:u()?h:void 0}){super(),this.isDevice=u(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=n,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new O,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=T(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=y((()=>{this.shakeStatus=4,this.shakeTask.reject(new j($.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&m(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return S(e)}json2Buf(e){return b(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=I.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let s=r.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:r.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:r.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=r.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const o=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const h=t.readUInt16LE(s);s+=2;const d=t.readUInt32LE(s);s+=4;const p=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:o,port1:a,port2:h,appId:d,extra:p,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=v){if(t&&E.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,U(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=v){t&&E.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,U(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:o=4}={}){const a=3518,h=t.byteLength;let d=0;const p=r.alloc(a),c=e||P(),l=D();let u=1;const f=Math.ceil(h/a);function g(){return u++}for(let e=1;e<=f;e++){if(this.errorIfBleDisconnect(),e===f){const e=h-d,a=r.alloc(0+e);t.copy(a,0,d,d+e),d+=e,this.sendDataWithSession({traceId:c,spanId:l,seqId:g(),payload:a,type:s,opCode:1,totalLength:h,contentType:n,dataType:i},{messageType:o});break}t.copy(p,0,d,d+a),d+=a,this.sendDataWithSession({traceId:c,spanId:l,seqId:g(),payload:p,type:s,opCode:0,totalLength:h,contentType:n,dataType:i},{messageType:o})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=b(t),o=e||P();this.sendHmProtocol({requestId:o,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||P();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=L(t),o=e||P();return this.sendHmProtocol({requestId:o,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:o,contentType:a,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:o,type:i,opCode:r,payload:n,contentType:a,dataType:h});let c=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(c)}buildPayload(e){const t=66+e.payload.byteLength;let s=r.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.byteLength,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}readPayload(e){const t=r.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);s+=4;const p=t.readUInt8(s);s+=1;const c=t.readUInt8(s);s+=1;const l=t.readUInt32LE(s);s+=4;const u=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt32LE(s);s+=4;const T=t.readUInt8(s);s+=1;const b=t.readUInt8(s);s+=1;const S=t.readUInt16LE(s);s+=2;const L=t.readUInt32LE(s);s+=4;const k=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:o,seqId:a,totalLength:h,payloadLength:d,payloadType:p,opCode:c,contentType:T,dataType:b,timestamp1:l,timestamp2:u,timestamp3:f,timestamp4:g,timestamp5:y,timestamp6:m,timestamp7:I,extra1:S,extra2:L,extra3:k,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(u()&&!this.ble.connectStatus())throw new j($.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(u()&&!this.appSidePort)throw new j($.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?_(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return I.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=B;"string"==typeof e?s=q:o(e)?s=C:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||r.isBuffer(e))&&(s=B);const n={timeout:6e4,contentType:s,dataType:s},i=P(),a=T();t=Object.assign(n,t);let h=y((()=>{h=null,a.reject(new j($.TIMEOUT,"request timeout"))}),t.timeout);return this.handlers.set(i,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=k(t);break;case 3:default:n=t;break;case 2:n=S(t)}a.resolve(n)})),r.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:3,dataType:_(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:r.from(e),type:1,contentType:3,dataType:_(t.dataType)}):2===_(t.contentType)?this.sendJson({requestId:i,json:e,type:1,contentType:2,dataType:_(t.dataType)}):1===_(t.contentType)?this.sendText({requestId:i,text:e,type:1,contentType:1,dataType:_(t.dataType)}):this.sendBuf({requestId:i,buf:r.from(e),type:1,contentType:3,dataType:_(t.dataType)}),a.promise.catch((e=>{throw e})).finally((()=>{h&&(m(h),h=null),this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:o(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||r.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>r.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:r.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:r.from(e),type:3,contentType:3,dataType:0})))}},z=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case 2:s=S(s);break;case 1:s=k(s);break;default:s=w(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return u()&&e.fork(this.shakeTimeout),t=o(t)?t.contentType?t:{jsonrpc:A,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case 2:s=S(s);break;case 1:s=k(s);break;default:s=w(s)}t&&t(s,((t,n,i={})=>2===e.request.contentType&&s?.jsonrpc===A?t?e.response({data:{jsonrpc:A,error:t}}):e.response({data:{jsonrpc:A,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,s={}){return u()&&e.fork(this.shakeTimeout),t=o(t)?s.contentType?t:{jsonrpc:A,...t}:t,e.request(t,{timeout:this.requestTimeout,...s}).then((e=>{if(!o(e)||e.jsonrpc!==A)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}(M),H=(N=transferFile,{canUseFileTransfer:()=>void 0!==N,onFile(e){return e&&this.canUseFileTransfer()?(N.inbox.on("newfile",(function(){const t=N.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e&&this.canUseFileTransfer()?(N.inbox.on("file",(function(){const t=N.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return N.inbox.emit("file"),this},offFile(){return this.canUseFileTransfer()?(N.inbox.off("newfile"),N.inbox.off("file"),this):this},getFile(){return this.canUseFileTransfer()?N.inbox.getNextFile():null},sendFile(e,t){if(!this.canUseFileTransfer())throw new Error("fileTransfer is not available");return N.outbox.enqueueFile(e,t)}});var N;const J={convert:e=>image.convert(e)};s.use((function(){return{onInit(){this.messaging=z,this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this.messaging.start()},onDestroy(){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop()},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.baseURL&&(t.url=new URL(t.url,t.baseURL).toString()),t}(e)),httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}})).use((function(){return{onInit(){this._onReceivedFile=this.onReceivedFile?.bind(this),H.onSideServiceFileFinished(this._onReceivedFile),"undefined"!=typeof sideService&&sideService.launchReasons.fileTransfer&&H.emitFile()},onDestroy(){this._onReceivedFile&&H.offFile(this._onReceivedFile)},sendFile:(e,t)=>H.sendFile(e,t)}})).use((function(e){e.download=function(e,t){return network.downloader.downloadFile({url:e,...t})}})).use((function(e){e.convert=function(e){return J.convert(e)}}));export{s as BaseSideService,J as convertLib,t as settingsLib};
